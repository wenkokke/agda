<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE NondecreasingIndentation #-}</span><span>
</span><span id="line-2"></span><span>
</span><span id="line-3"></span><span class="hs-comment">-- | Solving size constraints under hypotheses.</span><span>
</span><span id="line-4"></span><span class="hs-comment">--</span><span>
</span><span id="line-5"></span><span class="hs-comment">-- The size solver proceeds as follows:</span><span>
</span><span id="line-6"></span><span class="hs-comment">--</span><span>
</span><span id="line-7"></span><span class="hs-comment">-- 1. Get size constraints, cluster into connected components.</span><span>
</span><span id="line-8"></span><span class="hs-comment">--</span><span>
</span><span id="line-9"></span><span class="hs-comment">--    All size constraints that mention the same metas go into the same</span><span>
</span><span id="line-10"></span><span class="hs-comment">--    cluster.  Each cluster can be solved by itself.</span><span>
</span><span id="line-11"></span><span class="hs-comment">--</span><span>
</span><span id="line-12"></span><span class="hs-comment">--    Constraints that do not fit our format are ignored.</span><span>
</span><span id="line-13"></span><span class="hs-comment">--    We check whether our computed solution fulfills them as well</span><span>
</span><span id="line-14"></span><span class="hs-comment">--    in the last step.</span><span>
</span><span id="line-15"></span><span class="hs-comment">--</span><span>
</span><span id="line-16"></span><span class="hs-comment">-- 2. Find a joint context for each cluster.</span><span>
</span><span id="line-17"></span><span class="hs-comment">--</span><span>
</span><span id="line-18"></span><span class="hs-comment">--    Each constraint comes with its own typing context, which</span><span>
</span><span id="line-19"></span><span class="hs-comment">--    contains size hypotheses @j : Size&lt; i@.  We need to find a</span><span>
</span><span id="line-20"></span><span class="hs-comment">--    common super context in which all constraints of a cluster live,</span><span>
</span><span id="line-21"></span><span class="hs-comment">--    and raise all constraints to this context.</span><span>
</span><span id="line-22"></span><span class="hs-comment">--</span><span>
</span><span id="line-23"></span><span class="hs-comment">--    There might not be a common super context.  Then we are screwed,</span><span>
</span><span id="line-24"></span><span class="hs-comment">--    since our solver is not ready to deal with such a situation.  We</span><span>
</span><span id="line-25"></span><span class="hs-comment">--    will blatantly refuse to solve this cluster and blame it on the</span><span>
</span><span id="line-26"></span><span class="hs-comment">--    user.</span><span>
</span><span id="line-27"></span><span class="hs-comment">--</span><span>
</span><span id="line-28"></span><span class="hs-comment">-- 3. Convert the joint context into a hypothesis graph.</span><span>
</span><span id="line-29"></span><span class="hs-comment">--</span><span>
</span><span id="line-30"></span><span class="hs-comment">--    This is straightforward.  Each de Bruijn index becomes a</span><span>
</span><span id="line-31"></span><span class="hs-comment">--    rigid variable, each typing assumption @j : Size&lt; i@ becomes an</span><span>
</span><span id="line-32"></span><span class="hs-comment">--    arc.</span><span>
</span><span id="line-33"></span><span class="hs-comment">--</span><span>
</span><span id="line-34"></span><span class="hs-comment">-- 4. Convert the constraints into a constraint graph.</span><span>
</span><span id="line-35"></span><span class="hs-comment">--</span><span>
</span><span id="line-36"></span><span class="hs-comment">--    Here we need to convert @MetaV@s into flexible variables.</span><span>
</span><span id="line-37"></span><span class="hs-comment">--</span><span>
</span><span id="line-38"></span><span class="hs-comment">-- 5. Run the solver</span><span>
</span><span id="line-39"></span><span class="hs-comment">--</span><span>
</span><span id="line-40"></span><span class="hs-comment">-- 6. Convert the solution into meta instantiations.</span><span>
</span><span id="line-41"></span><span class="hs-comment">--</span><span>
</span><span id="line-42"></span><span class="hs-comment">-- 7. Double-check whether the constraints are solved.</span><span>
</span><span id="line-43"></span><span>
</span><span id="line-44"></span><span class="hs-comment">-- Opportunities for optimization:</span><span>
</span><span id="line-45"></span><span class="hs-comment">--</span><span>
</span><span id="line-46"></span><span class="hs-comment">-- - NamedRigids has some cost to retrieve variable names</span><span>
</span><span id="line-47"></span><span class="hs-comment">--   just for the sake of debug printing.</span><span>
</span><span id="line-48"></span><span>
</span><span id="line-49"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Agda.TypeChecking.SizedTypes.Solve</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-50"></span><span>
</span><span id="line-51"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Prelude</span></span><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">null</span></span><span class="hs-special">)</span><span>
</span><span id="line-52"></span><span>
</span><span id="line-53"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad</span></span><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">forM</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">forM_</span></span><span class="hs-special">)</span><span>
</span><span id="line-54"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.Except</span></span><span>
</span><span id="line-55"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.Trans.Maybe</span></span><span>
</span><span id="line-56"></span><span>
</span><span id="line-57"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Either</span></span><span>
</span><span id="line-58"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Foldable</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">forM_</span></span><span class="hs-special">)</span><span>
</span><span id="line-59"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.Foldable</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Fold</span></span><span>
</span><span id="line-60"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Function</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">on</span></span><span class="hs-special">)</span><span>
</span><span id="line-61"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.IntSet</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">IntSet</span></span><span>
</span><span id="line-62"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.List</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">List</span></span><span>
</span><span id="line-63"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Monoid</span></span><span>
</span><span id="line-64"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.Map</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Map</span></span><span>
</span><span id="line-65"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Set</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Set</span></span><span class="hs-special">)</span><span>
</span><span id="line-66"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.Set</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Set</span></span><span>
</span><span id="line-67"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Traversable</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">forM</span></span><span class="hs-special">)</span><span>
</span><span id="line-68"></span><span>
</span><span id="line-69"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Agda.Syntax.Common.html"><span class="hs-identifier">Agda.Syntax.Common</span></a></span><span>
</span><span id="line-70"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Agda.Syntax.Internal.html"><span class="hs-identifier">Agda.Syntax.Internal</span></a></span><span>
</span><span id="line-71"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Agda.Syntax.Internal.MetaVars.html"><span class="hs-identifier">Agda.Syntax.Internal.MetaVars</span></a></span><span>
</span><span id="line-72"></span><span>
</span><span id="line-73"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Agda.TypeChecking.Monad.html"><span class="hs-identifier">Agda.TypeChecking.Monad</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">TCM</span></span><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Agda.TypeChecking.Monad.SizedTypes.html#Offset"><span class="hs-identifier">Offset</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-74"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Agda.TypeChecking.Pretty.html"><span class="hs-identifier">Agda.TypeChecking.Pretty</span></a></span><span>
</span><span id="line-75"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Agda.TypeChecking.Free.html"><span class="hs-identifier">Agda.TypeChecking.Free</span></a></span><span>
</span><span id="line-76"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Agda.TypeChecking.Reduce.html"><span class="hs-identifier">Agda.TypeChecking.Reduce</span></a></span><span>
</span><span id="line-77"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Agda.TypeChecking.MetaVars.html"><span class="hs-identifier">Agda.TypeChecking.MetaVars</span></a></span><span>
</span><span id="line-78"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Agda.TypeChecking.Substitute.html"><span class="hs-identifier">Agda.TypeChecking.Substitute</span></a></span><span>
</span><span id="line-79"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Agda.TypeChecking.Telescope.html"><span class="hs-identifier">Agda.TypeChecking.Telescope</span></a></span><span>
</span><span id="line-80"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Agda.TypeChecking.Constraints.html"><span class="hs-identifier">Agda.TypeChecking.Constraints</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">C</span></span><span>
</span><span id="line-81"></span><span>
</span><span id="line-82"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Agda.TypeChecking.SizedTypes.html"><span class="hs-identifier">Agda.TypeChecking.SizedTypes</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">S</span></span><span>
</span><span id="line-83"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Agda.TypeChecking.SizedTypes.Syntax.html"><span class="hs-identifier">Agda.TypeChecking.SizedTypes.Syntax</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Size</span></span><span>
</span><span id="line-84"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Agda.TypeChecking.SizedTypes.Utils.html"><span class="hs-identifier">Agda.TypeChecking.SizedTypes.Utils</span></a></span><span>
</span><span id="line-85"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Agda.TypeChecking.SizedTypes.WarshallSolver.html"><span class="hs-identifier">Agda.TypeChecking.SizedTypes.WarshallSolver</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Size</span></span><span>
</span><span id="line-86"></span><span>
</span><span id="line-87"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Agda.Utils.Cluster.html"><span class="hs-identifier">Agda.Utils.Cluster</span></a></span><span>
</span><span id="line-88"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Agda.Utils.Function.html"><span class="hs-identifier">Agda.Utils.Function</span></a></span><span>
</span><span id="line-89"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Agda.Utils.Functor.html"><span class="hs-identifier">Agda.Utils.Functor</span></a></span><span>
</span><span id="line-90"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Agda.Utils.Lens.html"><span class="hs-identifier">Agda.Utils.Lens</span></a></span><span>
</span><span id="line-91"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Agda.Utils.List1.html"><span class="hs-identifier">Agda.Utils.List1</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Agda.Utils.List1.html#List1"><span class="hs-identifier">List1</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-keyword">pattern</span><span> </span><span class="annot"><span class="hs-operator">(:|)</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">nonEmpty</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-operator">(&lt;|)</span></span><span class="hs-special">)</span><span>
</span><span id="line-92"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Agda.Utils.List.html"><span class="hs-identifier">Agda.Utils.List</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">List</span></span><span>
</span><span id="line-93"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Agda.Utils.List1.html"><span class="hs-identifier">Agda.Utils.List1</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">List1</span></span><span>
</span><span id="line-94"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Agda.Utils.Maybe.html"><span class="hs-identifier">Agda.Utils.Maybe</span></a></span><span>
</span><span id="line-95"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Agda.Utils.Monad.html"><span class="hs-identifier">Agda.Utils.Monad</span></a></span><span>
</span><span id="line-96"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Agda.Utils.Null.html"><span class="hs-identifier">Agda.Utils.Null</span></a></span><span>
</span><span id="line-97"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Agda.Syntax.Common.Pretty.html"><span class="hs-identifier">Agda.Syntax.Common.Pretty</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Agda.Syntax.Common.Pretty.html#Pretty"><span class="hs-identifier">Pretty</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Agda.Syntax.Common.Pretty.html#prettyShow"><span class="hs-identifier">prettyShow</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-98"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Agda.Syntax.Common.Pretty.html"><span class="hs-identifier">Agda.Syntax.Common.Pretty</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">P</span></span><span>
</span><span id="line-99"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Agda.Utils.Singleton.html"><span class="hs-identifier">Agda.Utils.Singleton</span></a></span><span>
</span><span id="line-100"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Agda.Utils.Size.html"><span class="hs-identifier">Agda.Utils.Size</span></a></span><span>
</span><span id="line-101"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Agda.Utils.VarSet.html"><span class="hs-identifier">Agda.Utils.VarSet</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">VarSet</span></span><span>
</span><span id="line-102"></span><span>
</span><span id="line-103"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Agda.Utils.Impossible.html"><span class="hs-identifier">Agda.Utils.Impossible</span></a></span><span>
</span><span id="line-104"></span><span>
</span><span id="line-105"></span><span class="hs-keyword">type</span><span> </span><span id="CC"><span class="annot"><a href="Agda.TypeChecking.SizedTypes.Solve.html#CC"><span class="hs-identifier hs-var">CC</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="Agda.TypeChecking.Monad.Base.html#ProblemConstraint"><span class="hs-identifier hs-type">ProblemConstraint</span></a></span><span>
</span><span id="line-106"></span><span>
</span><span id="line-107"></span><span class="annot"><span class="hs-comment">-- | Flag to control the behavior of size solver.</span></span><span>
</span><span id="line-108"></span><span class="hs-keyword">data</span><span> </span><span id="DefaultToInfty"><span class="annot"><a href="Agda.TypeChecking.SizedTypes.Solve.html#DefaultToInfty"><span class="hs-identifier hs-var">DefaultToInfty</span></a></span></span><span>
</span><span id="line-109"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="DefaultToInfty"><span class="annot"><a href="Agda.TypeChecking.SizedTypes.Solve.html#DefaultToInfty"><span class="hs-identifier hs-var">DefaultToInfty</span></a></span></span><span>      </span><span class="annot"><span class="hs-comment">-- ^ Instantiate all unconstrained size variables to &#8734;.</span></span><span>
</span><span id="line-110"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="DontDefaultToInfty"><span class="annot"><a href="Agda.TypeChecking.SizedTypes.Solve.html#DontDefaultToInfty"><span class="hs-identifier hs-var">DontDefaultToInfty</span></a></span></span><span>  </span><span class="annot"><span class="hs-comment">-- ^ Leave unconstrained size variables unsolved.</span></span><span>
</span><span id="line-111"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681544915"><span id="local-6989586621681544917"><span class="annot"><span class="annottext">DefaultToInfty -&gt; DefaultToInfty -&gt; Bool
(DefaultToInfty -&gt; DefaultToInfty -&gt; Bool)
-&gt; (DefaultToInfty -&gt; DefaultToInfty -&gt; Bool) -&gt; Eq DefaultToInfty
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
$c== :: DefaultToInfty -&gt; DefaultToInfty -&gt; Bool
== :: DefaultToInfty -&gt; DefaultToInfty -&gt; Bool
$c/= :: DefaultToInfty -&gt; DefaultToInfty -&gt; Bool
/= :: DefaultToInfty -&gt; DefaultToInfty -&gt; Bool
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681544923"><span id="local-6989586621681544925"><span id="local-6989586621681544927"><span id="local-6989586621681544931"><span id="local-6989586621681544934"><span id="local-6989586621681544937"><span id="local-6989586621681544940"><span class="annot"><span class="annottext">Eq DefaultToInfty
Eq DefaultToInfty =&gt;
(DefaultToInfty -&gt; DefaultToInfty -&gt; Ordering)
-&gt; (DefaultToInfty -&gt; DefaultToInfty -&gt; Bool)
-&gt; (DefaultToInfty -&gt; DefaultToInfty -&gt; Bool)
-&gt; (DefaultToInfty -&gt; DefaultToInfty -&gt; Bool)
-&gt; (DefaultToInfty -&gt; DefaultToInfty -&gt; Bool)
-&gt; (DefaultToInfty -&gt; DefaultToInfty -&gt; DefaultToInfty)
-&gt; (DefaultToInfty -&gt; DefaultToInfty -&gt; DefaultToInfty)
-&gt; Ord DefaultToInfty
DefaultToInfty -&gt; DefaultToInfty -&gt; Bool
DefaultToInfty -&gt; DefaultToInfty -&gt; Ordering
DefaultToInfty -&gt; DefaultToInfty -&gt; DefaultToInfty
forall a.
Eq a =&gt;
(a -&gt; a -&gt; Ordering)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; a)
-&gt; (a -&gt; a -&gt; a)
-&gt; Ord a
$ccompare :: DefaultToInfty -&gt; DefaultToInfty -&gt; Ordering
compare :: DefaultToInfty -&gt; DefaultToInfty -&gt; Ordering
$c&lt; :: DefaultToInfty -&gt; DefaultToInfty -&gt; Bool
&lt; :: DefaultToInfty -&gt; DefaultToInfty -&gt; Bool
$c&lt;= :: DefaultToInfty -&gt; DefaultToInfty -&gt; Bool
&lt;= :: DefaultToInfty -&gt; DefaultToInfty -&gt; Bool
$c&gt; :: DefaultToInfty -&gt; DefaultToInfty -&gt; Bool
&gt; :: DefaultToInfty -&gt; DefaultToInfty -&gt; Bool
$c&gt;= :: DefaultToInfty -&gt; DefaultToInfty -&gt; Bool
&gt;= :: DefaultToInfty -&gt; DefaultToInfty -&gt; Bool
$cmax :: DefaultToInfty -&gt; DefaultToInfty -&gt; DefaultToInfty
max :: DefaultToInfty -&gt; DefaultToInfty -&gt; DefaultToInfty
$cmin :: DefaultToInfty -&gt; DefaultToInfty -&gt; DefaultToInfty
min :: DefaultToInfty -&gt; DefaultToInfty -&gt; DefaultToInfty
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Ord</span></span></span></span></span></span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681544944"><span id="local-6989586621681544946"><span id="local-6989586621681544949"><span class="annot"><span class="annottext">Int -&gt; DefaultToInfty -&gt; ShowS
[DefaultToInfty] -&gt; ShowS
DefaultToInfty -&gt; String
(Int -&gt; DefaultToInfty -&gt; ShowS)
-&gt; (DefaultToInfty -&gt; String)
-&gt; ([DefaultToInfty] -&gt; ShowS)
-&gt; Show DefaultToInfty
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
$cshowsPrec :: Int -&gt; DefaultToInfty -&gt; ShowS
showsPrec :: Int -&gt; DefaultToInfty -&gt; ShowS
$cshow :: DefaultToInfty -&gt; String
show :: DefaultToInfty -&gt; String
$cshowList :: [DefaultToInfty] -&gt; ShowS
showList :: [DefaultToInfty] -&gt; ShowS
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-112"></span><span>
</span><span id="line-113"></span><span class="annot"><span class="hs-comment">-- | Solve size constraints involving hypotheses.</span></span><span>
</span><span id="line-114"></span><span>
</span><span id="line-115"></span><span class="annot"><a href="Agda.TypeChecking.SizedTypes.Solve.html#solveSizeConstraints"><span class="hs-identifier hs-type">solveSizeConstraints</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Agda.TypeChecking.SizedTypes.Solve.html#DefaultToInfty"><span class="hs-identifier hs-type">DefaultToInfty</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Agda.TypeChecking.Monad.Base.html#TCM"><span class="hs-identifier hs-type">TCM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-116"></span><span id="solveSizeConstraints"><span class="annot"><span class="annottext">solveSizeConstraints :: DefaultToInfty -&gt; TCM ()
</span><a href="Agda.TypeChecking.SizedTypes.Solve.html#solveSizeConstraints"><span class="hs-identifier hs-var hs-var">solveSizeConstraints</span></a></span></span><span> </span><span id="local-6989586621681544953"><span class="annot"><span class="annottext">DefaultToInfty
</span><a href="#local-6989586621681544953"><span class="hs-identifier hs-var">flag</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>  </span><span class="hs-keyword">do</span><span>
</span><span id="line-117"></span><span>
</span><span id="line-118"></span><span>  </span><span class="hs-comment">-- 1. Take out the size constraints normalised.</span><span>
</span><span id="line-119"></span><span>
</span><span id="line-120"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681544996"><span class="annot"><span class="annottext">norm :: ProblemConstraint -&gt; f ProblemConstraint
</span><a href="#local-6989586621681544996"><span class="hs-identifier hs-var hs-var">norm</span></a></span></span><span> </span><span id="local-6989586621681544997"><span class="annot"><span class="annottext">ProblemConstraint
</span><a href="#local-6989586621681544997"><span class="hs-identifier hs-var">c</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Constraint -&gt; f Constraint)
-&gt; Closure Constraint -&gt; f (Closure Constraint)
forall (m :: * -&gt; *) a b.
(MonadTCEnv m, ReadTCState m) =&gt;
(a -&gt; m b) -&gt; Closure a -&gt; m (Closure b)
</span><a href="Agda.TypeChecking.Monad.Closure.html#mapClosure"><span class="hs-identifier hs-var">mapClosure</span></a></span><span> </span><span class="annot"><span class="annottext">Constraint -&gt; f Constraint
forall a (m :: * -&gt; *). (Normalise a, MonadReduce m) =&gt; a -&gt; m a
</span><a href="Agda.TypeChecking.Reduce.html#normalise"><span class="hs-identifier hs-var">normalise</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ProblemConstraint -&gt; Closure Constraint
</span><a href="Agda.TypeChecking.Monad.Base.html#theConstraint"><span class="hs-identifier hs-var">theConstraint</span></a></span><span> </span><span class="annot"><span class="annottext">ProblemConstraint
</span><a href="#local-6989586621681544997"><span class="hs-identifier hs-var">c</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">f (Closure Constraint)
-&gt; (Closure Constraint -&gt; ProblemConstraint) -&gt; f ProblemConstraint
forall (f :: * -&gt; *) a b. Functor f =&gt; f a -&gt; (a -&gt; b) -&gt; f b
</span><span class="hs-operator hs-var">&lt;&amp;&gt;</span></span><span> </span><span class="hs-glyph">\</span><span> </span><span id="local-6989586621681545002"><span class="annot"><span class="annottext">Closure Constraint
</span><a href="#local-6989586621681545002"><span class="hs-identifier hs-var">cl</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ProblemConstraint
</span><a href="#local-6989586621681544997"><span class="hs-identifier hs-var">c</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="Agda.TypeChecking.Monad.Base.html#theConstraint"><span class="hs-identifier hs-var">theConstraint</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621681545002"><span class="hs-identifier hs-type">cl</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-121"></span><span>  </span><span id="local-6989586621681545003"><span class="annot"><span class="annottext">[ProblemConstraint]
</span><a href="#local-6989586621681545003"><span class="hs-identifier hs-var">cs0</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(ProblemConstraint -&gt; TCMT IO ProblemConstraint)
-&gt; [ProblemConstraint] -&gt; TCMT IO [ProblemConstraint]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; [a] -&gt; m [b]
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">ProblemConstraint -&gt; TCMT IO ProblemConstraint
forall {f :: * -&gt; *}.
MonadReduce f =&gt;
ProblemConstraint -&gt; f ProblemConstraint
</span><a href="#local-6989586621681544996"><span class="hs-identifier hs-var">norm</span></a></span><span> </span><span class="annot"><span class="annottext">([ProblemConstraint] -&gt; TCMT IO [ProblemConstraint])
-&gt; TCMT IO [ProblemConstraint] -&gt; TCMT IO [ProblemConstraint]
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; m a -&gt; m b
</span><span class="hs-operator hs-var">=&lt;&lt;</span></span><span> </span><span class="annot"><span class="annottext">(Comparison -&gt; Bool) -&gt; TCMT IO [ProblemConstraint]
</span><a href="Agda.TypeChecking.SizedTypes.html#takeSizeConstraints"><span class="hs-identifier hs-var">S.takeSizeConstraints</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Comparison -&gt; Comparison -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Comparison
</span><a href="Agda.TypeChecking.Monad.Base.html#CmpLeq"><span class="hs-identifier hs-var">CmpLeq</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-122"></span><span>    </span><span class="hs-comment">-- NOTE: this deletes the size constraints from the constraint set!</span><span>
</span><span id="line-123"></span><span>  </span><span class="annot"><span class="annottext">Bool -&gt; TCM () -&gt; TCM ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">unless</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[ProblemConstraint] -&gt; Bool
forall a. Null a =&gt; a -&gt; Bool
</span><a href="Agda.Utils.Null.html#null"><span class="hs-identifier hs-var">null</span></a></span><span> </span><span class="annot"><span class="annottext">[ProblemConstraint]
</span><a href="#local-6989586621681545003"><span class="hs-identifier hs-var">cs0</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(TCM () -&gt; TCM ()) -&gt; TCM () -&gt; TCM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-124"></span><span>    </span><span class="annot"><span class="annottext">String -&gt; Int -&gt; TCMT IO Doc -&gt; TCM ()
forall (m :: * -&gt; *).
MonadDebug m =&gt;
String -&gt; Int -&gt; TCMT IO Doc -&gt; m ()
</span><a href="Agda.TypeChecking.Monad.Debug.html#reportSDoc"><span class="hs-identifier hs-var">reportSDoc</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;tc.size.solve&quot;</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">40</span></span><span> </span><span class="annot"><span class="annottext">(TCMT IO Doc -&gt; TCM ()) -&gt; TCMT IO Doc -&gt; TCM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[TCMT IO Doc] -&gt; TCMT IO Doc
forall (m :: * -&gt; *) (t :: * -&gt; *).
(Applicative m, Foldable t) =&gt;
t (m Doc) -&gt; m Doc
</span><a href="Agda.TypeChecking.Pretty.html#vcat"><span class="hs-identifier hs-var">vcat</span></a></span><span> </span><span class="annot"><span class="annottext">([TCMT IO Doc] -&gt; TCMT IO Doc) -&gt; [TCMT IO Doc] -&gt; TCMT IO Doc
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-125"></span><span>      </span><span class="annot"><span class="annottext">String -&gt; TCMT IO Doc
forall (m :: * -&gt; *). Applicative m =&gt; String -&gt; m Doc
</span><a href="Agda.TypeChecking.Pretty.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Solving constraints (&quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">DefaultToInfty -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">DefaultToInfty
</span><a href="#local-6989586621681544953"><span class="hs-identifier hs-var">flag</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;)&quot;</span></span><span> </span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TCMT IO Doc -&gt; [TCMT IO Doc] -&gt; [TCMT IO Doc]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">(ProblemConstraint -&gt; TCMT IO Doc)
-&gt; [ProblemConstraint] -&gt; [TCMT IO Doc]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">ProblemConstraint -&gt; TCMT IO Doc
forall a (m :: * -&gt; *). (PrettyTCM a, MonadPretty m) =&gt; a -&gt; m Doc
forall (m :: * -&gt; *). MonadPretty m =&gt; ProblemConstraint -&gt; m Doc
</span><a href="Agda.TypeChecking.Pretty.html#prettyTCM"><span class="hs-identifier hs-var">prettyTCM</span></a></span><span> </span><span class="annot"><span class="annottext">[ProblemConstraint]
</span><a href="#local-6989586621681545003"><span class="hs-identifier hs-var">cs0</span></a></span><span>
</span><span id="line-126"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="hs-comment">-- Error for giving up</span><span>
</span><span id="line-127"></span><span>      </span><span id="local-6989586621681543897"><span class="annot"><a href="#local-6989586621681545015"><span class="hs-identifier hs-type">cannotSolve</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Agda.TypeChecking.Monad.Base.html#TCM"><span class="hs-identifier hs-type">TCM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681543897"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span class="hs-comment">-- Defined, but not currently used</span><span>
</span><span id="line-128"></span><span>      </span><span id="local-6989586621681545015"><span class="annot"><span class="annottext">cannotSolve :: forall a. TCM a
</span><a href="#local-6989586621681545015"><span class="hs-identifier hs-var hs-var">cannotSolve</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TypeError -&gt; TCMT IO a
forall (m :: * -&gt; *) a.
(HasCallStack, MonadTCError m) =&gt;
TypeError -&gt; m a
</span><a href="Agda.TypeChecking.Monad.Base.html#typeError"><span class="hs-identifier hs-var">typeError</span></a></span><span> </span><span class="annot"><span class="annottext">(TypeError -&gt; TCMT IO a) -&gt; (Doc -&gt; TypeError) -&gt; Doc -&gt; TCMT IO a
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; TypeError
</span><a href="Agda.TypeChecking.Monad.Base.html#GenericDocError"><span class="hs-identifier hs-var">GenericDocError</span></a></span><span> </span><span class="annot"><span class="annottext">(Doc -&gt; TCMT IO a) -&gt; TCMT IO Doc -&gt; TCMT IO a
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; m a -&gt; m b
</span><span class="hs-operator hs-var">=&lt;&lt;</span></span><span>
</span><span id="line-129"></span><span>        </span><span class="annot"><span class="annottext">[TCMT IO Doc] -&gt; TCMT IO Doc
forall (m :: * -&gt; *) (t :: * -&gt; *).
(Applicative m, Foldable t) =&gt;
t (m Doc) -&gt; m Doc
</span><a href="Agda.TypeChecking.Pretty.html#vcat"><span class="hs-identifier hs-var">vcat</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TCMT IO Doc
</span><span class="hs-string">&quot;Cannot solve size constraints&quot;</span></span><span> </span><span class="annot"><span class="annottext">TCMT IO Doc -&gt; [TCMT IO Doc] -&gt; [TCMT IO Doc]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">(ProblemConstraint -&gt; TCMT IO Doc)
-&gt; [ProblemConstraint] -&gt; [TCMT IO Doc]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">ProblemConstraint -&gt; TCMT IO Doc
forall a (m :: * -&gt; *). (PrettyTCM a, MonadPretty m) =&gt; a -&gt; m Doc
forall (m :: * -&gt; *). MonadPretty m =&gt; ProblemConstraint -&gt; m Doc
</span><a href="Agda.TypeChecking.Pretty.html#prettyTCM"><span class="hs-identifier hs-var">prettyTCM</span></a></span><span> </span><span class="annot"><span class="annottext">[ProblemConstraint]
</span><a href="#local-6989586621681545003"><span class="hs-identifier hs-var">cs0</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-130"></span><span>
</span><span id="line-131"></span><span>  </span><span class="hs-comment">-- 2. Cluster the constraints by common size metas.</span><span>
</span><span id="line-132"></span><span>
</span><span id="line-133"></span><span>  </span><span class="hs-comment">-- Get all size metas.</span><span>
</span><span id="line-134"></span><span>  </span><span id="local-6989586621681545028"><span class="annot"><span class="annottext">Set MetaId
</span><a href="#local-6989586621681545028"><span class="hs-identifier hs-var">sizeMetaSet</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[MetaId] -&gt; Set MetaId
forall a. Ord a =&gt; [a] -&gt; Set a
</span><span class="hs-identifier hs-var">Set.fromList</span></span><span> </span><span class="annot"><span class="annottext">([MetaId] -&gt; Set MetaId)
-&gt; ([(MetaId, Type, Tele (Dom Type))] -&gt; [MetaId])
-&gt; [(MetaId, Type, Tele (Dom Type))]
-&gt; Set MetaId
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">((MetaId, Type, Tele (Dom Type)) -&gt; MetaId)
-&gt; [(MetaId, Type, Tele (Dom Type))] -&gt; [MetaId]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681545030"><span class="annot"><span class="annottext">MetaId
</span><a href="#local-6989586621681545030"><span class="hs-identifier hs-var">x</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681545031"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681545031"><span class="hs-identifier hs-var">_t</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681545032"><span class="annot"><span class="annottext">Tele (Dom Type)
</span><a href="#local-6989586621681545032"><span class="hs-identifier hs-var">_tel</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">MetaId
</span><a href="#local-6989586621681545030"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([(MetaId, Type, Tele (Dom Type))] -&gt; Set MetaId)
-&gt; TCMT IO [(MetaId, Type, Tele (Dom Type))]
-&gt; TCMT IO (Set MetaId)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; TCMT IO [(MetaId, Type, Tele (Dom Type))]
</span><a href="Agda.TypeChecking.SizedTypes.html#getSizeMetas"><span class="hs-identifier hs-var">S.getSizeMetas</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-135"></span><span>
</span><span id="line-136"></span><span>  </span><span class="hs-comment">-- Pair each constraint with its list of size metas occurring in it.</span><span>
</span><span id="line-137"></span><span>  </span><span id="local-6989586621681545035"><span class="annot"><span class="annottext">[(ProblemConstraint, [MetaId])]
</span><a href="#local-6989586621681545035"><span class="hs-identifier hs-var">cms</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[ProblemConstraint]
-&gt; (ProblemConstraint -&gt; TCMT IO (ProblemConstraint, [MetaId]))
-&gt; TCMT IO [(ProblemConstraint, [MetaId])]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m (t b)
</span><span class="hs-identifier hs-var">forM</span></span><span> </span><span class="annot"><span class="annottext">[ProblemConstraint]
</span><a href="#local-6989586621681545003"><span class="hs-identifier hs-var">cs0</span></a></span><span> </span><span class="annot"><span class="annottext">((ProblemConstraint -&gt; TCMT IO (ProblemConstraint, [MetaId]))
 -&gt; TCMT IO [(ProblemConstraint, [MetaId])])
-&gt; (ProblemConstraint -&gt; TCMT IO (ProblemConstraint, [MetaId]))
-&gt; TCMT IO [(ProblemConstraint, [MetaId])]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span> </span><span id="local-6989586621681545036"><span class="annot"><span class="annottext">ProblemConstraint
</span><a href="#local-6989586621681545036"><span class="hs-identifier hs-var">cl</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Closure Constraint
-&gt; (Constraint -&gt; TCMT IO (ProblemConstraint, [MetaId]))
-&gt; TCMT IO (ProblemConstraint, [MetaId])
forall (m :: * -&gt; *) c a b.
(MonadTCEnv m, ReadTCState m, LensClosure c a) =&gt;
c -&gt; (a -&gt; m b) -&gt; m b
</span><a href="Agda.TypeChecking.Monad.Closure.html#enterClosure"><span class="hs-identifier hs-var">enterClosure</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ProblemConstraint -&gt; Closure Constraint
</span><a href="Agda.TypeChecking.Monad.Base.html#theConstraint"><span class="hs-identifier hs-var">theConstraint</span></a></span><span> </span><span class="annot"><span class="annottext">ProblemConstraint
</span><a href="#local-6989586621681545036"><span class="hs-identifier hs-var">cl</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((Constraint -&gt; TCMT IO (ProblemConstraint, [MetaId]))
 -&gt; TCMT IO (ProblemConstraint, [MetaId]))
-&gt; (Constraint -&gt; TCMT IO (ProblemConstraint, [MetaId]))
-&gt; TCMT IO (ProblemConstraint, [MetaId])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span> </span><span id="local-6989586621681545038"><span class="annot"><span class="annottext">Constraint
</span><a href="#local-6989586621681545038"><span class="hs-identifier hs-var">c</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-138"></span><span>
</span><span id="line-139"></span><span>    </span><span class="hs-comment">-- @allMetas@ does not reduce or instantiate;</span><span>
</span><span id="line-140"></span><span>    </span><span class="hs-comment">-- this is why we require the size constraints to be normalised.</span><span>
</span><span id="line-141"></span><span>    </span><span class="annot"><span class="annottext">(ProblemConstraint, [MetaId])
-&gt; TCMT IO (ProblemConstraint, [MetaId])
forall a. a -&gt; TCMT IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ProblemConstraint
</span><a href="#local-6989586621681545036"><span class="hs-identifier hs-var">cl</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Set MetaId -&gt; [MetaId]
forall a. Set a -&gt; [a]
</span><span class="hs-identifier hs-var">Set.toList</span></span><span> </span><span class="annot"><span class="annottext">(Set MetaId -&gt; [MetaId]) -&gt; Set MetaId -&gt; [MetaId]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-142"></span><span>      </span><span class="annot"><span class="annottext">Set MetaId
</span><a href="#local-6989586621681545028"><span class="hs-identifier hs-var">sizeMetaSet</span></a></span><span> </span><span class="annot"><span class="annottext">Set MetaId -&gt; Set MetaId -&gt; Set MetaId
forall a. Ord a =&gt; Set a -&gt; Set a -&gt; Set a
</span><span class="hs-operator hs-var">`Set.intersection`</span></span><span> </span><span class="annot"><span class="annottext">(MetaId -&gt; Set MetaId) -&gt; Constraint -&gt; Set MetaId
forall m. Monoid m =&gt; (MetaId -&gt; m) -&gt; Constraint -&gt; m
forall t m. (AllMetas t, Monoid m) =&gt; (MetaId -&gt; m) -&gt; t -&gt; m
</span><a href="Agda.Syntax.Internal.MetaVars.html#allMetas"><span class="hs-identifier hs-var">allMetas</span></a></span><span> </span><span class="annot"><span class="annottext">MetaId -&gt; Set MetaId
forall el coll. Singleton el coll =&gt; el -&gt; coll
</span><a href="Agda.Utils.Singleton.html#singleton"><span class="hs-identifier hs-var">singleton</span></a></span><span> </span><span class="annot"><span class="annottext">Constraint
</span><a href="#local-6989586621681545038"><span class="hs-identifier hs-var">c</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-143"></span><span>
</span><span id="line-144"></span><span>  </span><span class="hs-comment">-- Now, some constraints may have no metas (clcs), the others have at least one (othercs).</span><span>
</span><span id="line-145"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681543925"><span id="local-6989586621681543926"><span class="annot"><a href="#local-6989586621681545043"><span class="hs-identifier hs-type">classify</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621681543925"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621681543926"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="annot"><a href="#local-6989586621681543925"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621681543925"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Agda.Utils.List1.html#List1"><span class="hs-identifier hs-type">List1</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681543926"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span></span></span><span>
</span><span id="line-146"></span><span>      </span><span id="local-6989586621681545043"><span class="annot"><span class="annottext">classify :: forall a b. (a, [b]) -&gt; Either a (a, List1 b)
</span><a href="#local-6989586621681545043"><span class="hs-identifier hs-var hs-var">classify</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621681545044"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621681545044"><span class="hs-identifier hs-var">cl</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">a -&gt; Either a (a, List1 b)
forall a b. a -&gt; Either a b
</span><span class="hs-identifier hs-var">Left</span></span><span>  </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621681545044"><span class="hs-identifier hs-var">cl</span></a></span><span>
</span><span id="line-147"></span><span>      </span><span class="annot"><a href="#local-6989586621681545043"><span class="hs-identifier hs-var">classify</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621681545045"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621681545045"><span class="hs-identifier hs-var">cl</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681545046"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621681545046"><span class="hs-identifier hs-var">x</span></a></span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span id="local-6989586621681545047"><span class="annot"><span class="annottext">[b]
</span><a href="#local-6989586621681545047"><span class="hs-identifier hs-var">xs</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(a, List1 b) -&gt; Either a (a, List1 b)
forall a b. b -&gt; Either a b
</span><span class="hs-identifier hs-var">Right</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621681545045"><span class="hs-identifier hs-var">cl</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621681545046"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">b -&gt; [b] -&gt; List1 b
forall a. a -&gt; [a] -&gt; NonEmpty a
</span><span class="hs-operator hs-var">:|</span></span><span> </span><span class="annot"><span class="annottext">[b]
</span><a href="#local-6989586621681545047"><span class="hs-identifier hs-var">xs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-148"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681545048"><span class="annot"><span class="annottext">[ProblemConstraint]
</span><a href="#local-6989586621681545048"><span class="hs-identifier hs-var">clcs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681545049"><span class="annot"><span class="annottext">[(ProblemConstraint, List1 MetaId)]
</span><a href="#local-6989586621681545049"><span class="hs-identifier hs-var">othercs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Either ProblemConstraint (ProblemConstraint, List1 MetaId)]
-&gt; ([ProblemConstraint], [(ProblemConstraint, List1 MetaId)])
forall a b. [Either a b] -&gt; ([a], [b])
</span><span class="hs-identifier hs-var">partitionEithers</span></span><span> </span><span class="annot"><span class="annottext">([Either ProblemConstraint (ProblemConstraint, List1 MetaId)]
 -&gt; ([ProblemConstraint], [(ProblemConstraint, List1 MetaId)]))
-&gt; [Either ProblemConstraint (ProblemConstraint, List1 MetaId)]
-&gt; ([ProblemConstraint], [(ProblemConstraint, List1 MetaId)])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">((ProblemConstraint, [MetaId])
 -&gt; Either ProblemConstraint (ProblemConstraint, List1 MetaId))
-&gt; [(ProblemConstraint, [MetaId])]
-&gt; [Either ProblemConstraint (ProblemConstraint, List1 MetaId)]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">(ProblemConstraint, [MetaId])
-&gt; Either ProblemConstraint (ProblemConstraint, List1 MetaId)
forall a b. (a, [b]) -&gt; Either a (a, List1 b)
</span><a href="#local-6989586621681545043"><span class="hs-identifier hs-var">classify</span></a></span><span> </span><span class="annot"><span class="annottext">[(ProblemConstraint, [MetaId])]
</span><a href="#local-6989586621681545035"><span class="hs-identifier hs-var">cms</span></a></span><span>
</span><span id="line-149"></span><span>
</span><span id="line-150"></span><span>  </span><span class="hs-comment">-- We cluster the constraints by their metas.</span><span>
</span><span id="line-151"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681545051"><span class="annot"><span class="annottext">ccs :: [NonEmpty ProblemConstraint]
</span><a href="#local-6989586621681545051"><span class="hs-identifier hs-var hs-var">ccs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(ProblemConstraint, List1 MetaId)] -&gt; [NonEmpty ProblemConstraint]
forall c a. Ord c =&gt; [(a, NonEmpty c)] -&gt; [NonEmpty a]
</span><a href="Agda.Utils.Cluster.html#cluster%27"><span class="hs-identifier hs-var">cluster'</span></a></span><span> </span><span class="annot"><span class="annottext">[(ProblemConstraint, List1 MetaId)]
</span><a href="#local-6989586621681545049"><span class="hs-identifier hs-var">othercs</span></a></span><span>
</span><span id="line-152"></span><span>
</span><span id="line-153"></span><span>  </span><span class="hs-comment">-- 3. Solve each cluster</span><span>
</span><span id="line-154"></span><span>
</span><span id="line-155"></span><span>  </span><span class="hs-comment">-- Solve the closed constraints, one by one.</span><span>
</span><span id="line-156"></span><span>
</span><span id="line-157"></span><span>  </span><span class="annot"><span class="annottext">[ProblemConstraint] -&gt; (ProblemConstraint -&gt; TCM ()) -&gt; TCM ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="annot"><span class="annottext">[ProblemConstraint]
</span><a href="#local-6989586621681545048"><span class="hs-identifier hs-var">clcs</span></a></span><span> </span><span class="annot"><span class="annottext">((ProblemConstraint -&gt; TCM ()) -&gt; TCM ())
-&gt; (ProblemConstraint -&gt; TCM ()) -&gt; TCM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span> </span><span id="local-6989586621681545053"><span class="annot"><span class="annottext">ProblemConstraint
</span><a href="#local-6989586621681545053"><span class="hs-identifier hs-var">c</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">() -&gt; TCMT IO (Set MetaId) -&gt; TCM ()
forall a b. a -&gt; TCMT IO b -&gt; TCMT IO a
forall (f :: * -&gt; *) a b. Functor f =&gt; a -&gt; f b -&gt; f a
</span><span class="hs-operator hs-var">&lt;$</span></span><span> </span><span class="annot"><span class="annottext">DefaultToInfty -&gt; [ProblemConstraint] -&gt; TCMT IO (Set MetaId)
</span><a href="Agda.TypeChecking.SizedTypes.Solve.html#solveSizeConstraints_"><span class="hs-identifier hs-var">solveSizeConstraints_</span></a></span><span> </span><span class="annot"><span class="annottext">DefaultToInfty
</span><a href="#local-6989586621681544953"><span class="hs-identifier hs-var">flag</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">ProblemConstraint
</span><a href="#local-6989586621681545053"><span class="hs-identifier hs-var">c</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-158"></span><span>
</span><span id="line-159"></span><span>  </span><span class="hs-comment">-- Solve the clusters.</span><span>
</span><span id="line-160"></span><span>
</span><span id="line-161"></span><span>  </span><span id="local-6989586621681545056"><span class="annot"><span class="annottext">Set MetaId
</span><a href="#local-6989586621681545056"><span class="hs-identifier hs-var">constrainedMetas</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Set MetaId] -&gt; Set MetaId
forall (f :: * -&gt; *) a. (Foldable f, Ord a) =&gt; f (Set a) -&gt; Set a
</span><span class="hs-identifier hs-var">Set.unions</span></span><span> </span><span class="annot"><span class="annottext">([Set MetaId] -&gt; Set MetaId)
-&gt; TCMT IO [Set MetaId] -&gt; TCMT IO (Set MetaId)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-162"></span><span>    </span><span class="annot"><span class="annottext">[NonEmpty ProblemConstraint]
-&gt; (NonEmpty ProblemConstraint -&gt; TCMT IO (Set MetaId))
-&gt; TCMT IO [Set MetaId]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m (t b)
</span><span class="hs-identifier hs-var">forM</span></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[NonEmpty ProblemConstraint]
</span><a href="#local-6989586621681545051"><span class="hs-identifier hs-var">ccs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((NonEmpty ProblemConstraint -&gt; TCMT IO (Set MetaId))
 -&gt; TCMT IO [Set MetaId])
-&gt; (NonEmpty ProblemConstraint -&gt; TCMT IO (Set MetaId))
-&gt; TCMT IO [Set MetaId]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681545058"><span class="annot"><span class="annottext">NonEmpty ProblemConstraint
</span><a href="#local-6989586621681545058"><span class="hs-identifier hs-var">cs</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Agda.Utils.List1.html#List1"><span class="hs-identifier hs-type">List1</span></a></span><span> </span><span class="annot"><a href="Agda.TypeChecking.SizedTypes.Solve.html#CC"><span class="hs-identifier hs-type">CC</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-163"></span><span>
</span><span id="line-164"></span><span>      </span><span class="annot"><span class="annottext">String -&gt; Int -&gt; TCMT IO Doc -&gt; TCM ()
forall (m :: * -&gt; *).
MonadDebug m =&gt;
String -&gt; Int -&gt; TCMT IO Doc -&gt; m ()
</span><a href="Agda.TypeChecking.Monad.Debug.html#reportSDoc"><span class="hs-identifier hs-var">reportSDoc</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;tc.size.solve&quot;</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">60</span></span><span> </span><span class="annot"><span class="annottext">(TCMT IO Doc -&gt; TCM ()) -&gt; TCMT IO Doc -&gt; TCM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">NonEmpty (TCMT IO Doc) -&gt; TCMT IO Doc
forall (m :: * -&gt; *) (t :: * -&gt; *).
(Applicative m, Foldable t) =&gt;
t (m Doc) -&gt; m Doc
</span><a href="Agda.TypeChecking.Pretty.html#vcat"><span class="hs-identifier hs-var">vcat</span></a></span><span> </span><span class="annot"><span class="annottext">(NonEmpty (TCMT IO Doc) -&gt; TCMT IO Doc)
-&gt; NonEmpty (TCMT IO Doc) -&gt; TCMT IO Doc
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-165"></span><span>        </span><span class="annot"><span class="annottext">TCMT IO Doc
</span><span class="hs-string">&quot;size constraint cluster:&quot;</span></span><span> </span><span class="annot"><span class="annottext">TCMT IO Doc -&gt; NonEmpty (TCMT IO Doc) -&gt; NonEmpty (TCMT IO Doc)
forall a. a -&gt; NonEmpty a -&gt; NonEmpty a
</span><span class="hs-operator hs-var">&lt;|</span></span><span> </span><span class="annot"><span class="annottext">(ProblemConstraint -&gt; TCMT IO Doc)
-&gt; NonEmpty ProblemConstraint -&gt; NonEmpty (TCMT IO Doc)
forall a b. (a -&gt; b) -&gt; NonEmpty a -&gt; NonEmpty b
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; TCMT IO Doc
forall (m :: * -&gt; *). Applicative m =&gt; String -&gt; m Doc
</span><a href="Agda.TypeChecking.Pretty.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">(String -&gt; TCMT IO Doc)
-&gt; (ProblemConstraint -&gt; String)
-&gt; ProblemConstraint
-&gt; TCMT IO Doc
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">ProblemConstraint -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">NonEmpty ProblemConstraint
</span><a href="#local-6989586621681545058"><span class="hs-identifier hs-var">cs</span></a></span><span>
</span><span id="line-166"></span><span>
</span><span id="line-167"></span><span>      </span><span class="hs-comment">-- Convert each constraint in the cluster to the largest context.</span><span>
</span><span id="line-168"></span><span>      </span><span class="hs-comment">-- (Keep fingers crossed).</span><span>
</span><span id="line-169"></span><span>
</span><span id="line-170"></span><span>      </span><span class="annot"><span class="annottext">Closure Constraint
-&gt; (Constraint -&gt; TCMT IO (Set MetaId)) -&gt; TCMT IO (Set MetaId)
forall (m :: * -&gt; *) c a b.
(MonadTCEnv m, ReadTCState m, LensClosure c a) =&gt;
c -&gt; (a -&gt; m b) -&gt; m b
</span><a href="Agda.TypeChecking.Monad.Closure.html#enterClosure"><span class="hs-identifier hs-var">enterClosure</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Closure Constraint -&gt; Closure Constraint -&gt; Ordering)
-&gt; NonEmpty (Closure Constraint) -&gt; Closure Constraint
forall (t :: * -&gt; *) a.
Foldable t =&gt;
(a -&gt; a -&gt; Ordering) -&gt; t a -&gt; a
</span><span class="hs-identifier hs-var">Fold.maximumBy</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Ordering
forall a. Ord a =&gt; a -&gt; a -&gt; Ordering
</span><span class="hs-identifier hs-var">compare</span></span><span> </span><span class="annot"><span class="annottext">(Int -&gt; Int -&gt; Ordering)
-&gt; (Closure Constraint -&gt; Int)
-&gt; Closure Constraint
-&gt; Closure Constraint
-&gt; Ordering
forall b c a. (b -&gt; b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; a -&gt; c
</span><span class="hs-operator hs-var">`on`</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Context -&gt; Int
forall a. [a] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">(Context -&gt; Int)
-&gt; (Closure Constraint -&gt; Context) -&gt; Closure Constraint -&gt; Int
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">TCEnv -&gt; Context
</span><a href="Agda.TypeChecking.Monad.Base.html#envContext"><span class="hs-identifier hs-var">envContext</span></a></span><span> </span><span class="annot"><span class="annottext">(TCEnv -&gt; Context)
-&gt; (Closure Constraint -&gt; TCEnv) -&gt; Closure Constraint -&gt; Context
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Closure Constraint -&gt; TCEnv
forall a. Closure a -&gt; TCEnv
</span><a href="Agda.TypeChecking.Monad.Base.html#clEnv"><span class="hs-identifier hs-var">clEnv</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(NonEmpty (Closure Constraint) -&gt; Closure Constraint)
-&gt; NonEmpty (Closure Constraint) -&gt; Closure Constraint
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(ProblemConstraint -&gt; Closure Constraint)
-&gt; NonEmpty ProblemConstraint -&gt; NonEmpty (Closure Constraint)
forall a b. (a -&gt; b) -&gt; NonEmpty a -&gt; NonEmpty b
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">ProblemConstraint -&gt; Closure Constraint
</span><a href="Agda.TypeChecking.Monad.Base.html#theConstraint"><span class="hs-identifier hs-var">theConstraint</span></a></span><span> </span><span class="annot"><span class="annottext">NonEmpty ProblemConstraint
</span><a href="#local-6989586621681545058"><span class="hs-identifier hs-var">cs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((Constraint -&gt; TCMT IO (Set MetaId)) -&gt; TCMT IO (Set MetaId))
-&gt; (Constraint -&gt; TCMT IO (Set MetaId)) -&gt; TCMT IO (Set MetaId)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span> </span><span class="annot"><span class="annottext">Constraint
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-171"></span><span>        </span><span class="hs-comment">-- Get all constraints that can be cast to the longest context.</span><span>
</span><span id="line-172"></span><span>        </span><span id="local-6989586621681545064"><span class="annot"><span class="annottext">[ProblemConstraint]
</span><a href="#local-6989586621681545064"><span class="hs-identifier hs-var">cs'</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Agda.TypeChecking.Monad.Base.html#ProblemConstraint"><span class="hs-identifier hs-type">ProblemConstraint</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">List1 (Maybe ProblemConstraint) -&gt; [ProblemConstraint]
forall a. List1 (Maybe a) -&gt; [a]
</span><a href="Agda.Utils.List1.html#catMaybes"><span class="hs-identifier hs-var">List1.catMaybes</span></a></span><span> </span><span class="annot"><span class="annottext">(List1 (Maybe ProblemConstraint) -&gt; [ProblemConstraint])
-&gt; TCMT IO (List1 (Maybe ProblemConstraint))
-&gt; TCMT IO [ProblemConstraint]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-173"></span><span>          </span><span class="annot"><span class="annottext">(ProblemConstraint -&gt; TCMT IO (Maybe ProblemConstraint))
-&gt; NonEmpty ProblemConstraint
-&gt; TCMT IO (List1 (Maybe ProblemConstraint))
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
forall (m :: * -&gt; *) a b.
Monad m =&gt;
(a -&gt; m b) -&gt; NonEmpty a -&gt; m (NonEmpty b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MaybeT (TCMT IO) ProblemConstraint
-&gt; TCMT IO (Maybe ProblemConstraint)
forall (m :: * -&gt; *) a. MaybeT m a -&gt; m (Maybe a)
</span><span class="hs-identifier hs-var">runMaybeT</span></span><span> </span><span class="annot"><span class="annottext">(MaybeT (TCMT IO) ProblemConstraint
 -&gt; TCMT IO (Maybe ProblemConstraint))
-&gt; (ProblemConstraint -&gt; MaybeT (TCMT IO) ProblemConstraint)
-&gt; ProblemConstraint
-&gt; TCMT IO (Maybe ProblemConstraint)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">ProblemConstraint -&gt; MaybeT (TCMT IO) ProblemConstraint
</span><a href="Agda.TypeChecking.SizedTypes.Solve.html#castConstraintToCurrentContext"><span class="hs-identifier hs-var">castConstraintToCurrentContext</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">NonEmpty ProblemConstraint
</span><a href="#local-6989586621681545058"><span class="hs-identifier hs-var">cs</span></a></span><span>
</span><span id="line-174"></span><span>
</span><span id="line-175"></span><span>        </span><span class="annot"><span class="annottext">String -&gt; Int -&gt; TCMT IO Doc -&gt; TCM ()
forall (m :: * -&gt; *).
MonadDebug m =&gt;
String -&gt; Int -&gt; TCMT IO Doc -&gt; m ()
</span><a href="Agda.TypeChecking.Monad.Debug.html#reportSDoc"><span class="hs-identifier hs-var">reportSDoc</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;tc.size.solve&quot;</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">20</span></span><span> </span><span class="annot"><span class="annottext">(TCMT IO Doc -&gt; TCM ()) -&gt; TCMT IO Doc -&gt; TCM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[TCMT IO Doc] -&gt; TCMT IO Doc
forall (m :: * -&gt; *) (t :: * -&gt; *).
(Applicative m, Foldable t) =&gt;
t (m Doc) -&gt; m Doc
</span><a href="Agda.TypeChecking.Pretty.html#vcat"><span class="hs-identifier hs-var">vcat</span></a></span><span> </span><span class="annot"><span class="annottext">([TCMT IO Doc] -&gt; TCMT IO Doc) -&gt; [TCMT IO Doc] -&gt; TCMT IO Doc
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-176"></span><span>          </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">TCMT IO Doc
</span><span class="hs-string">&quot;converted size constraints to context: &quot;</span></span><span> </span><span class="annot"><span class="annottext">TCMT IO Doc -&gt; TCMT IO Doc -&gt; TCMT IO Doc
forall (m :: * -&gt; *). Applicative m =&gt; m Doc -&gt; m Doc -&gt; m Doc
</span><a href="Agda.TypeChecking.Pretty.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-177"></span><span>              </span><span id="local-6989586621681545069"><span class="annot"><span class="annottext">Tele (Dom Type)
</span><a href="#local-6989586621681545069"><span class="hs-identifier hs-var">tel</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TCMT IO (Tele (Dom Type))
forall (m :: * -&gt; *).
(Applicative m, MonadTCEnv m) =&gt;
m (Tele (Dom Type))
</span><a href="Agda.TypeChecking.Monad.Context.html#getContextTelescope"><span class="hs-identifier hs-var">getContextTelescope</span></a></span><span>
</span><span id="line-178"></span><span>              </span><span class="annot"><span class="annottext">TCMT IO Doc -&gt; TCMT IO Doc
forall (tcm :: * -&gt; *) a.
(MonadTCEnv tcm, ReadTCState tcm) =&gt;
tcm a -&gt; tcm a
</span><a href="Agda.TypeChecking.Monad.Context.html#inTopContext"><span class="hs-identifier hs-var">inTopContext</span></a></span><span> </span><span class="annot"><span class="annottext">(TCMT IO Doc -&gt; TCMT IO Doc) -&gt; TCMT IO Doc -&gt; TCMT IO Doc
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Tele (Dom Type) -&gt; TCMT IO Doc
forall a (m :: * -&gt; *). (PrettyTCM a, MonadPretty m) =&gt; a -&gt; m Doc
forall (m :: * -&gt; *). MonadPretty m =&gt; Tele (Dom Type) -&gt; m Doc
</span><a href="Agda.TypeChecking.Pretty.html#prettyTCM"><span class="hs-identifier hs-var">prettyTCM</span></a></span><span> </span><span class="annot"><span class="annottext">Tele (Dom Type)
</span><a href="#local-6989586621681545069"><span class="hs-identifier hs-var">tel</span></a></span><span>
</span><span id="line-179"></span><span>          </span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TCMT IO Doc -&gt; [TCMT IO Doc] -&gt; [TCMT IO Doc]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">(ProblemConstraint -&gt; TCMT IO Doc)
-&gt; [ProblemConstraint] -&gt; [TCMT IO Doc]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; TCMT IO Doc -&gt; TCMT IO Doc
forall (m :: * -&gt; *). Functor m =&gt; Int -&gt; m Doc -&gt; m Doc
</span><a href="Agda.TypeChecking.Pretty.html#nest"><span class="hs-identifier hs-var">nest</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">2</span></span><span> </span><span class="annot"><span class="annottext">(TCMT IO Doc -&gt; TCMT IO Doc)
-&gt; (ProblemConstraint -&gt; TCMT IO Doc)
-&gt; ProblemConstraint
-&gt; TCMT IO Doc
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">ProblemConstraint -&gt; TCMT IO Doc
forall a (m :: * -&gt; *). (PrettyTCM a, MonadPretty m) =&gt; a -&gt; m Doc
forall (m :: * -&gt; *). MonadPretty m =&gt; ProblemConstraint -&gt; m Doc
</span><a href="Agda.TypeChecking.Pretty.html#prettyTCM"><span class="hs-identifier hs-var">prettyTCM</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[ProblemConstraint]
</span><a href="#local-6989586621681545064"><span class="hs-identifier hs-var">cs'</span></a></span><span>
</span><span id="line-180"></span><span>
</span><span id="line-181"></span><span>        </span><span class="hs-comment">-- Solve the converted constraints.</span><span>
</span><span id="line-182"></span><span>        </span><span class="annot"><span class="annottext">DefaultToInfty -&gt; [ProblemConstraint] -&gt; TCMT IO (Set MetaId)
</span><a href="Agda.TypeChecking.SizedTypes.Solve.html#solveSizeConstraints_"><span class="hs-identifier hs-var">solveSizeConstraints_</span></a></span><span> </span><span class="annot"><span class="annottext">DefaultToInfty
</span><a href="#local-6989586621681544953"><span class="hs-identifier hs-var">flag</span></a></span><span> </span><span class="annot"><span class="annottext">[ProblemConstraint]
</span><a href="#local-6989586621681545064"><span class="hs-identifier hs-var">cs'</span></a></span><span>
</span><span id="line-183"></span><span>
</span><span id="line-184"></span><span>  </span><span class="hs-comment">-- 4. Possibly set remaining metas to infinity.</span><span>
</span><span id="line-185"></span><span>
</span><span id="line-186"></span><span>  </span><span class="hs-comment">-- Andreas, issue 1862: do not default to &#8734; always, could be too early.</span><span>
</span><span id="line-187"></span><span>  </span><span class="annot"><span class="annottext">Bool -&gt; TCM () -&gt; TCM ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DefaultToInfty
</span><a href="#local-6989586621681544953"><span class="hs-identifier hs-var">flag</span></a></span><span> </span><span class="annot"><span class="annottext">DefaultToInfty -&gt; DefaultToInfty -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">DefaultToInfty
</span><a href="Agda.TypeChecking.SizedTypes.Solve.html#DefaultToInfty"><span class="hs-identifier hs-var">DefaultToInfty</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(TCM () -&gt; TCM ()) -&gt; TCM () -&gt; TCM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-188"></span><span>
</span><span id="line-189"></span><span>    </span><span class="hs-comment">-- let constrainedMetas = Set.fromList $ concat $</span><span>
</span><span id="line-190"></span><span>    </span><span class="hs-comment">--       for cs0 $ \ Closure{ clValue = ValueCmp _ _ u v } -&gt;</span><span>
</span><span id="line-191"></span><span>    </span><span class="hs-comment">--         allMetas u ++ allMetas v</span><span>
</span><span id="line-192"></span><span>
</span><span id="line-193"></span><span>    </span><span class="hs-comment">-- Set the unconstrained, open size metas to &#8734;.</span><span>
</span><span id="line-194"></span><span>    </span><span id="local-6989586621681545074"><span class="annot"><span class="annottext">[(MetaId, Type, Tele (Dom Type))]
</span><a href="#local-6989586621681545074"><span class="hs-identifier hs-var">ms</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; TCMT IO [(MetaId, Type, Tele (Dom Type))]
</span><a href="Agda.TypeChecking.SizedTypes.html#getSizeMetas"><span class="hs-identifier hs-var">S.getSizeMetas</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span> </span><span class="hs-comment">-- do not get interaction metas</span><span>
</span><span id="line-195"></span><span>    </span><span class="annot"><span class="annottext">Bool -&gt; TCM () -&gt; TCM ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">unless</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[(MetaId, Type, Tele (Dom Type))] -&gt; Bool
forall a. Null a =&gt; a -&gt; Bool
</span><a href="Agda.Utils.Null.html#null"><span class="hs-identifier hs-var">null</span></a></span><span> </span><span class="annot"><span class="annottext">[(MetaId, Type, Tele (Dom Type))]
</span><a href="#local-6989586621681545074"><span class="hs-identifier hs-var">ms</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(TCM () -&gt; TCM ()) -&gt; TCM () -&gt; TCM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-196"></span><span>      </span><span id="local-6989586621681545075"><span class="annot"><span class="annottext">Term
</span><a href="#local-6989586621681545075"><span class="hs-identifier hs-var">inf</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TCMT IO Term
forall (m :: * -&gt; *).
(HasBuiltins m, MonadError TCErr m, MonadTCEnv m, ReadTCState m) =&gt;
m Term
</span><a href="Agda.TypeChecking.Monad.Builtin.html#primSizeInf"><span class="hs-identifier hs-var">primSizeInf</span></a></span><span>
</span><span id="line-197"></span><span>      </span><span class="annot"><span class="annottext">[(MetaId, Type, Tele (Dom Type))]
-&gt; ((MetaId, Type, Tele (Dom Type)) -&gt; TCM ()) -&gt; TCM ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="annot"><span class="annottext">[(MetaId, Type, Tele (Dom Type))]
</span><a href="#local-6989586621681545074"><span class="hs-identifier hs-var">ms</span></a></span><span> </span><span class="annot"><span class="annottext">(((MetaId, Type, Tele (Dom Type)) -&gt; TCM ()) -&gt; TCM ())
-&gt; ((MetaId, Type, Tele (Dom Type)) -&gt; TCM ()) -&gt; TCM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681545077"><span class="annot"><span class="annottext">MetaId
</span><a href="#local-6989586621681545077"><span class="hs-identifier hs-var">m</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681545078"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681545078"><span class="hs-identifier hs-var">t</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681545079"><span class="annot"><span class="annottext">Tele (Dom Type)
</span><a href="#local-6989586621681545079"><span class="hs-identifier hs-var">tel</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-198"></span><span>        </span><span class="annot"><span class="annottext">Bool -&gt; TCM () -&gt; TCM ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">unless</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MetaId
</span><a href="#local-6989586621681545077"><span class="hs-identifier hs-var">m</span></a></span><span> </span><span class="annot"><span class="annottext">MetaId -&gt; Set MetaId -&gt; Bool
forall a. Ord a =&gt; a -&gt; Set a -&gt; Bool
</span><span class="hs-operator hs-var">`Set.member`</span></span><span> </span><span class="annot"><span class="annottext">Set MetaId
</span><a href="#local-6989586621681545056"><span class="hs-identifier hs-var">constrainedMetas</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(TCM () -&gt; TCM ()) -&gt; TCM () -&gt; TCM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-199"></span><span>        </span><span class="annot"><span class="annottext">TCMT IO Bool -&gt; TCM () -&gt; TCM ()
forall (m :: * -&gt; *). Monad m =&gt; m Bool -&gt; m () -&gt; m ()
</span><a href="Agda.Utils.Monad.html#unlessM"><span class="hs-identifier hs-var">unlessM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MetaId -&gt; TCMT IO Bool
forall (m :: * -&gt; *).
(HasCallStack, MonadDebug m, ReadTCState m) =&gt;
MetaId -&gt; m Bool
</span><a href="Agda.TypeChecking.Monad.MetaVars.html#isFrozen"><span class="hs-identifier hs-var">isFrozen</span></a></span><span> </span><span class="annot"><span class="annottext">MetaId
</span><a href="#local-6989586621681545077"><span class="hs-identifier hs-var">m</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(TCM () -&gt; TCM ()) -&gt; TCM () -&gt; TCM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-200"></span><span>        </span><span class="annot"><span class="annottext">String -&gt; Int -&gt; TCMT IO Doc -&gt; TCM ()
forall (m :: * -&gt; *).
MonadDebug m =&gt;
String -&gt; Int -&gt; TCMT IO Doc -&gt; m ()
</span><a href="Agda.TypeChecking.Monad.Debug.html#reportSDoc"><span class="hs-identifier hs-var">reportSDoc</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;tc.size.solve&quot;</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">20</span></span><span> </span><span class="annot"><span class="annottext">(TCMT IO Doc -&gt; TCM ()) -&gt; TCMT IO Doc -&gt; TCM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-201"></span><span>          </span><span class="annot"><span class="annottext">TCMT IO Doc
</span><span class="hs-string">&quot;solution &quot;</span></span><span> </span><span class="annot"><span class="annottext">TCMT IO Doc -&gt; TCMT IO Doc -&gt; TCMT IO Doc
forall (m :: * -&gt; *). Applicative m =&gt; m Doc -&gt; m Doc -&gt; m Doc
</span><a href="Agda.TypeChecking.Pretty.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Term -&gt; TCMT IO Doc
forall a (m :: * -&gt; *). (PrettyTCM a, MonadPretty m) =&gt; a -&gt; m Doc
forall (m :: * -&gt; *). MonadPretty m =&gt; Term -&gt; m Doc
</span><a href="Agda.TypeChecking.Pretty.html#prettyTCM"><span class="hs-identifier hs-var">prettyTCM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MetaId -&gt; Elims -&gt; Term
</span><a href="Agda.Syntax.Internal.html#MetaV"><span class="hs-identifier hs-var">MetaV</span></a></span><span> </span><span class="annot"><span class="annottext">MetaId
</span><a href="#local-6989586621681545077"><span class="hs-identifier hs-var">m</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TCMT IO Doc -&gt; TCMT IO Doc -&gt; TCMT IO Doc
forall (m :: * -&gt; *). Applicative m =&gt; m Doc -&gt; m Doc -&gt; m Doc
</span><a href="Agda.TypeChecking.Pretty.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span>
</span><span id="line-202"></span><span>          </span><span class="annot"><span class="annottext">TCMT IO Doc
</span><span class="hs-string">&quot; := &quot;</span></span><span>      </span><span class="annot"><span class="annottext">TCMT IO Doc -&gt; TCMT IO Doc -&gt; TCMT IO Doc
forall (m :: * -&gt; *). Applicative m =&gt; m Doc -&gt; m Doc -&gt; m Doc
</span><a href="Agda.TypeChecking.Pretty.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Term -&gt; TCMT IO Doc
forall a (m :: * -&gt; *). (PrettyTCM a, MonadPretty m) =&gt; a -&gt; m Doc
forall (m :: * -&gt; *). MonadPretty m =&gt; Term -&gt; m Doc
</span><a href="Agda.TypeChecking.Pretty.html#prettyTCM"><span class="hs-identifier hs-var">prettyTCM</span></a></span><span> </span><span class="annot"><span class="annottext">Term
</span><a href="#local-6989586621681545075"><span class="hs-identifier hs-var">inf</span></a></span><span>
</span><span id="line-203"></span><span>        </span><span class="annot"><span class="annottext">Int -&gt; MetaId -&gt; Type -&gt; [Int] -&gt; Term -&gt; TCM ()
</span><a href="Agda.TypeChecking.MetaVars.html#assignMeta"><span class="hs-identifier hs-var">assignMeta</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">MetaId
</span><a href="#local-6989586621681545077"><span class="hs-identifier hs-var">m</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681545078"><span class="hs-identifier hs-var">t</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; [Int]
forall a. Integral a =&gt; a -&gt; [a]
</span><a href="Agda.Utils.List.html#downFrom"><span class="hs-identifier hs-var">List.downFrom</span></a></span><span> </span><span class="annot"><span class="annottext">(Int -&gt; [Int]) -&gt; Int -&gt; [Int]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Tele (Dom Type) -&gt; Int
forall a. Sized a =&gt; a -&gt; Int
</span><a href="Agda.Utils.Size.html#size"><span class="hs-identifier hs-var">size</span></a></span><span> </span><span class="annot"><span class="annottext">Tele (Dom Type)
</span><a href="#local-6989586621681545079"><span class="hs-identifier hs-var">tel</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Term
</span><a href="#local-6989586621681545075"><span class="hs-identifier hs-var">inf</span></a></span><span>
</span><span id="line-204"></span><span>
</span><span id="line-205"></span><span>  </span><span class="hs-comment">-- -- Double check.</span><span>
</span><span id="line-206"></span><span>  </span><span class="hs-comment">-- unless (null cs0 &amp;&amp; null ms) $ do</span><span>
</span><span id="line-207"></span><span>  </span><span class="hs-comment">--   flip catchError (const cannotSolve) $</span><span>
</span><span id="line-208"></span><span>  </span><span class="hs-comment">--     noConstraints $</span><span>
</span><span id="line-209"></span><span>  </span><span class="hs-comment">--       forM_ cs0 $ \ cl -&gt; enterClosure cl solveConstraint</span><span>
</span><span id="line-210"></span><span>
</span><span id="line-211"></span><span>  </span><span class="hs-comment">-- 5. Make sure we did not lose any constraints.</span><span>
</span><span id="line-212"></span><span>
</span><span id="line-213"></span><span>  </span><span class="hs-comment">-- This is necessary since we have removed the size constraints.</span><span>
</span><span id="line-214"></span><span>  </span><span class="annot"><span class="annottext">[ProblemConstraint] -&gt; (ProblemConstraint -&gt; TCM ()) -&gt; TCM ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="annot"><span class="annottext">[ProblemConstraint]
</span><a href="#local-6989586621681545003"><span class="hs-identifier hs-var">cs0</span></a></span><span> </span><span class="annot"><span class="annottext">((ProblemConstraint -&gt; TCM ()) -&gt; TCM ())
-&gt; (ProblemConstraint -&gt; TCM ()) -&gt; TCM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(Constraint -&gt; TCM ()) -&gt; ProblemConstraint -&gt; TCM ()
forall (m :: * -&gt; *) a.
MonadConstraint m =&gt;
(Constraint -&gt; m a) -&gt; ProblemConstraint -&gt; m a
</span><a href="Agda.TypeChecking.Monad.Constraints.html#withConstraint"><span class="hs-identifier hs-var">withConstraint</span></a></span><span> </span><span class="annot"><span class="annottext">Constraint -&gt; TCM ()
forall (m :: * -&gt; *). MonadConstraint m =&gt; Constraint -&gt; m ()
</span><a href="Agda.TypeChecking.Monad.Constraints.html#solveConstraint"><span class="hs-identifier hs-var">solveConstraint</span></a></span><span>
</span><span id="line-215"></span><span>
</span><span id="line-216"></span><span>
</span><span id="line-217"></span><span class="hs-comment">-- | TODO: this does not actually work!</span><span>
</span><span id="line-218"></span><span class="hs-comment">--</span><span>
</span><span id="line-219"></span><span class="hs-comment">--   We would like to use a constraint @c@ created in context @&#916;@ from module @N@</span><span>
</span><span id="line-220"></span><span class="hs-comment">--   in the current context @&#915;@ and current module @M@.</span><span>
</span><span id="line-221"></span><span class="hs-comment">--</span><span>
</span><span id="line-222"></span><span class="hs-comment">--   @&#916;@ is module tel @&#916;&#8321;@ of @N@ extended by some local bindings @&#916;&#8322;@.</span><span>
</span><span id="line-223"></span><span class="hs-comment">--   @&#915;@ is the current context.</span><span>
</span><span id="line-224"></span><span class="hs-comment">--   The module parameter substitution from current @M@ to @N@ be</span><span>
</span><span id="line-225"></span><span class="hs-comment">--   @&#915; &#8866; &#963; : &#916;&#8321;@.</span><span>
</span><span id="line-226"></span><span class="hs-comment">--</span><span>
</span><span id="line-227"></span><span class="hs-comment">--   If @M == N@, we do not need the parameter substitution.  We try raising.</span><span>
</span><span id="line-228"></span><span class="hs-comment">--</span><span>
</span><span id="line-229"></span><span class="hs-comment">--   We first strengthen @&#916; &#8866; c@ to live in @&#916;&#8321;@ and obtain @c&#8321; = strengthen &#916;&#8322; c@.</span><span>
</span><span id="line-230"></span><span class="hs-comment">--   We then transport @c&#8321;@ to @&#915;@ and obtain @c&#8322; = applySubst &#963; c&#8321;@.</span><span>
</span><span id="line-231"></span><span class="hs-comment">--</span><span>
</span><span id="line-232"></span><span class="hs-comment">--   This works for different modules, but if @M == N@ we should not strengthen</span><span>
</span><span id="line-233"></span><span class="hs-comment">--   and then weaken, because strengthening is a partial operation.</span><span>
</span><span id="line-234"></span><span class="hs-comment">--   We should rather lift the substitution @&#963;@ by @&#916;&#8322;@ and then</span><span>
</span><span id="line-235"></span><span class="hs-comment">--   raise by @&#915;&#8322; - &#916;&#8322;@.</span><span>
</span><span id="line-236"></span><span class="hs-comment">--   This &quot;raising&quot; might be a strengthening if @&#915;&#8322;@ is shorter than @&#916;&#8322;@.</span><span>
</span><span id="line-237"></span><span class="hs-comment">--</span><span>
</span><span id="line-238"></span><span class="hs-comment">--   (TODO: If the module substitution does not exist, because @N@ is not</span><span>
</span><span id="line-239"></span><span class="hs-comment">--   a parent of @M@, we cannot use the constraint, as it has been created</span><span>
</span><span id="line-240"></span><span class="hs-comment">--   in an unrelated context.)</span><span>
</span><span id="line-241"></span><span>
</span><span id="line-242"></span><span class="annot"><a href="Agda.TypeChecking.SizedTypes.Solve.html#castConstraintToCurrentContext%27"><span class="hs-identifier hs-type">castConstraintToCurrentContext'</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Agda.TypeChecking.Monad.Base.html#Closure"><span class="hs-identifier hs-type">Closure</span></a></span><span> </span><span class="annot"><a href="Agda.TypeChecking.Monad.Base.html#Constraint"><span class="hs-identifier hs-type">TCM.Constraint</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MaybeT</span></span><span> </span><span class="annot"><a href="Agda.TypeChecking.Monad.Base.html#TCM"><span class="hs-identifier hs-type">TCM</span></a></span><span> </span><span class="annot"><a href="Agda.TypeChecking.Monad.Base.html#Constraint"><span class="hs-identifier hs-type">TCM.Constraint</span></a></span><span>
</span><span id="line-243"></span><span id="castConstraintToCurrentContext%27"><span class="annot"><span class="annottext">castConstraintToCurrentContext' :: Closure Constraint -&gt; MaybeT (TCMT IO) Constraint
</span><a href="Agda.TypeChecking.SizedTypes.Solve.html#castConstraintToCurrentContext%27"><span class="hs-identifier hs-var hs-var">castConstraintToCurrentContext'</span></a></span></span><span> </span><span id="local-6989586621681545090"><span class="annot"><span class="annottext">Closure Constraint
</span><a href="#local-6989586621681545090"><span class="hs-identifier hs-var">cl</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-244"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681545091"><span class="annot"><span class="annottext">modN :: ModuleName
</span><a href="#local-6989586621681545091"><span class="hs-identifier hs-var hs-var">modN</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TCEnv -&gt; ModuleName
</span><a href="Agda.TypeChecking.Monad.Base.html#envCurrentModule"><span class="hs-identifier hs-var">envCurrentModule</span></a></span><span> </span><span class="annot"><span class="annottext">(TCEnv -&gt; ModuleName) -&gt; TCEnv -&gt; ModuleName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Closure Constraint -&gt; TCEnv
forall a. Closure a -&gt; TCEnv
</span><a href="Agda.TypeChecking.Monad.Base.html#clEnv"><span class="hs-identifier hs-var">clEnv</span></a></span><span> </span><span class="annot"><span class="annottext">Closure Constraint
</span><a href="#local-6989586621681545090"><span class="hs-identifier hs-var">cl</span></a></span><span>
</span><span id="line-245"></span><span>      </span><span id="local-6989586621681545093"><span class="annot"><span class="annottext">delta :: Context
</span><a href="#local-6989586621681545093"><span class="hs-identifier hs-var hs-var">delta</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TCEnv -&gt; Context
</span><a href="Agda.TypeChecking.Monad.Base.html#envContext"><span class="hs-identifier hs-var">envContext</span></a></span><span> </span><span class="annot"><span class="annottext">(TCEnv -&gt; Context) -&gt; TCEnv -&gt; Context
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Closure Constraint -&gt; TCEnv
forall a. Closure a -&gt; TCEnv
</span><a href="Agda.TypeChecking.Monad.Base.html#clEnv"><span class="hs-identifier hs-var">clEnv</span></a></span><span> </span><span class="annot"><span class="annottext">Closure Constraint
</span><a href="#local-6989586621681545090"><span class="hs-identifier hs-var">cl</span></a></span><span>
</span><span id="line-246"></span><span>  </span><span class="hs-comment">-- The module telescope of the constraint.</span><span>
</span><span id="line-247"></span><span>  </span><span class="hs-comment">-- The constraint could come from the module telescope of the top level module.</span><span>
</span><span id="line-248"></span><span>  </span><span class="hs-comment">-- In this case, it does not live in any module!</span><span>
</span><span id="line-249"></span><span>  </span><span class="hs-comment">-- Thus, getSection can return Nothing.</span><span>
</span><span id="line-250"></span><span>  </span><span id="local-6989586621681545094"><span class="annot"><span class="annottext">Tele (Dom Type)
</span><a href="#local-6989586621681545094"><span class="hs-identifier hs-var">delta1</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TCMT IO (Tele (Dom Type)) -&gt; MaybeT (TCMT IO) (Tele (Dom Type))
forall a. TCM a -&gt; MaybeT (TCMT IO) a
forall (tcm :: * -&gt; *) a. MonadTCM tcm =&gt; TCM a -&gt; tcm a
</span><a href="Agda.TypeChecking.Monad.Base.html#liftTCM"><span class="hs-identifier hs-var">liftTCM</span></a></span><span> </span><span class="annot"><span class="annottext">(TCMT IO (Tele (Dom Type)) -&gt; MaybeT (TCMT IO) (Tele (Dom Type)))
-&gt; TCMT IO (Tele (Dom Type)) -&gt; MaybeT (TCMT IO) (Tele (Dom Type))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Tele (Dom Type)
-&gt; (Section -&gt; Tele (Dom Type)) -&gt; Maybe Section -&gt; Tele (Dom Type)
forall b a. b -&gt; (a -&gt; b) -&gt; Maybe a -&gt; b
</span><span class="hs-identifier hs-var">maybe</span></span><span> </span><span class="annot"><span class="annottext">Tele (Dom Type)
forall a. Null a =&gt; a
</span><a href="Agda.Utils.Null.html#empty"><span class="hs-identifier hs-var">empty</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Section -&gt; Lens' Section (Tele (Dom Type)) -&gt; Tele (Dom Type)
forall o i. o -&gt; Lens' o i -&gt; i
</span><a href="Agda.Utils.Lens.html#%5E."><span class="hs-operator hs-var">^.</span></a></span><span> </span><span class="annot"><span class="annottext">(Tele (Dom Type) -&gt; f (Tele (Dom Type))) -&gt; Section -&gt; f Section
Lens' Section (Tele (Dom Type))
</span><a href="Agda.TypeChecking.Monad.Base.html#secTelescope"><span class="hs-identifier hs-var">secTelescope</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Maybe Section -&gt; Tele (Dom Type))
-&gt; TCMT IO (Maybe Section) -&gt; TCMT IO (Tele (Dom Type))
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">ModuleName -&gt; TCMT IO (Maybe Section)
forall (m :: * -&gt; *).
(Functor m, ReadTCState m) =&gt;
ModuleName -&gt; m (Maybe Section)
</span><a href="Agda.TypeChecking.Monad.Signature.html#getSection"><span class="hs-identifier hs-var">getSection</span></a></span><span> </span><span class="annot"><span class="annottext">ModuleName
</span><a href="#local-6989586621681545091"><span class="hs-identifier hs-var">modN</span></a></span><span>
</span><span id="line-251"></span><span>  </span><span class="hs-comment">-- The number of locals of the constraint.</span><span>
</span><span id="line-252"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681545103"><span class="annot"><span class="annottext">delta2 :: Int
</span><a href="#local-6989586621681545103"><span class="hs-identifier hs-var hs-var">delta2</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Context -&gt; Int
forall a. Sized a =&gt; a -&gt; Int
</span><a href="Agda.Utils.Size.html#size"><span class="hs-identifier hs-var">size</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621681545093"><span class="hs-identifier hs-var">delta</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">Tele (Dom Type) -&gt; Int
forall a. Sized a =&gt; a -&gt; Int
</span><a href="Agda.Utils.Size.html#size"><span class="hs-identifier hs-var">size</span></a></span><span> </span><span class="annot"><span class="annottext">Tele (Dom Type)
</span><a href="#local-6989586621681545094"><span class="hs-identifier hs-var">delta1</span></a></span><span>
</span><span id="line-253"></span><span>  </span><span class="annot"><span class="annottext">Bool -&gt; MaybeT (TCMT IO) () -&gt; MaybeT (TCMT IO) ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">unless</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681545103"><span class="hs-identifier hs-var">delta2</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;=</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">MaybeT (TCMT IO) ()
forall a. HasCallStack =&gt; a
</span><a href="Agda.Utils.Impossible.html#__IMPOSSIBLE__"><span class="hs-identifier hs-var">__IMPOSSIBLE__</span></a></span><span>
</span><span id="line-254"></span><span>
</span><span id="line-255"></span><span>  </span><span class="hs-comment">-- The current module M and context &#915;.</span><span>
</span><span id="line-256"></span><span>  </span><span id="local-6989586621681545105"><span class="annot"><span class="annottext">ModuleName
</span><a href="#local-6989586621681545105"><span class="hs-identifier hs-var">modM</span></a></span></span><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">MaybeT (TCMT IO) ModuleName
forall (m :: * -&gt; *). MonadTCEnv m =&gt; m ModuleName
</span><a href="Agda.TypeChecking.Monad.Env.html#currentModule"><span class="hs-identifier hs-var">currentModule</span></a></span><span>
</span><span id="line-257"></span><span>  </span><span id="local-6989586621681545107"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681545107"><span class="hs-identifier hs-var">gamma</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TCM Int -&gt; MaybeT (TCMT IO) Int
forall a. TCM a -&gt; MaybeT (TCMT IO) a
forall (tcm :: * -&gt; *) a. MonadTCM tcm =&gt; TCM a -&gt; tcm a
</span><a href="Agda.TypeChecking.Monad.Base.html#liftTCM"><span class="hs-identifier hs-var">liftTCM</span></a></span><span> </span><span class="annot"><span class="annottext">(TCM Int -&gt; MaybeT (TCMT IO) Int)
-&gt; TCM Int -&gt; MaybeT (TCMT IO) Int
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TCM Int
forall (m :: * -&gt; *). (Applicative m, MonadTCEnv m) =&gt; m Int
</span><a href="Agda.TypeChecking.Monad.Context.html#getContextSize"><span class="hs-identifier hs-var">getContextSize</span></a></span><span>
</span><span id="line-258"></span><span>  </span><span class="hs-comment">-- The current module telescope.</span><span>
</span><span id="line-259"></span><span>  </span><span class="hs-comment">-- Could also be empty, if we are in the front matter or telescope of the top-level module.</span><span>
</span><span id="line-260"></span><span>  </span><span id="local-6989586621681545109"><span class="annot"><span class="annottext">Tele (Dom Type)
</span><a href="#local-6989586621681545109"><span class="hs-identifier hs-var">gamma1</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span class="annot"><span class="annottext">TCMT IO (Tele (Dom Type)) -&gt; MaybeT (TCMT IO) (Tele (Dom Type))
forall a. TCM a -&gt; MaybeT (TCMT IO) a
forall (tcm :: * -&gt; *) a. MonadTCM tcm =&gt; TCM a -&gt; tcm a
</span><a href="Agda.TypeChecking.Monad.Base.html#liftTCM"><span class="hs-identifier hs-var">liftTCM</span></a></span><span> </span><span class="annot"><span class="annottext">(TCMT IO (Tele (Dom Type)) -&gt; MaybeT (TCMT IO) (Tele (Dom Type)))
-&gt; TCMT IO (Tele (Dom Type)) -&gt; MaybeT (TCMT IO) (Tele (Dom Type))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Tele (Dom Type)
-&gt; (Section -&gt; Tele (Dom Type)) -&gt; Maybe Section -&gt; Tele (Dom Type)
forall b a. b -&gt; (a -&gt; b) -&gt; Maybe a -&gt; b
</span><span class="hs-identifier hs-var">maybe</span></span><span> </span><span class="annot"><span class="annottext">Tele (Dom Type)
forall a. Null a =&gt; a
</span><a href="Agda.Utils.Null.html#empty"><span class="hs-identifier hs-var">empty</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Section -&gt; Lens' Section (Tele (Dom Type)) -&gt; Tele (Dom Type)
forall o i. o -&gt; Lens' o i -&gt; i
</span><a href="Agda.Utils.Lens.html#%5E."><span class="hs-operator hs-var">^.</span></a></span><span> </span><span class="annot"><span class="annottext">(Tele (Dom Type) -&gt; f (Tele (Dom Type))) -&gt; Section -&gt; f Section
Lens' Section (Tele (Dom Type))
</span><a href="Agda.TypeChecking.Monad.Base.html#secTelescope"><span class="hs-identifier hs-var">secTelescope</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Maybe Section -&gt; Tele (Dom Type))
-&gt; TCMT IO (Maybe Section) -&gt; TCMT IO (Tele (Dom Type))
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">ModuleName -&gt; TCMT IO (Maybe Section)
forall (m :: * -&gt; *).
(Functor m, ReadTCState m) =&gt;
ModuleName -&gt; m (Maybe Section)
</span><a href="Agda.TypeChecking.Monad.Signature.html#getSection"><span class="hs-identifier hs-var">getSection</span></a></span><span> </span><span class="annot"><span class="annottext">ModuleName
</span><a href="#local-6989586621681545105"><span class="hs-identifier hs-var">modM</span></a></span><span>
</span><span id="line-261"></span><span>  </span><span class="hs-comment">-- The current locals.</span><span>
</span><span id="line-262"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681545112"><span class="annot"><span class="annottext">gamma2 :: Int
</span><a href="#local-6989586621681545112"><span class="hs-identifier hs-var hs-var">gamma2</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681545107"><span class="hs-identifier hs-var">gamma</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">Tele (Dom Type) -&gt; Int
forall a. Sized a =&gt; a -&gt; Int
</span><a href="Agda.Utils.Size.html#size"><span class="hs-identifier hs-var">size</span></a></span><span> </span><span class="annot"><span class="annottext">Tele (Dom Type)
</span><a href="#local-6989586621681545109"><span class="hs-identifier hs-var">gamma1</span></a></span><span>
</span><span id="line-263"></span><span>
</span><span id="line-264"></span><span>  </span><span class="hs-comment">-- &#915; &#8866; &#963; : &#916;&#8321;</span><span>
</span><span id="line-265"></span><span>  </span><span id="local-6989586621681545113"><span class="annot"><span class="annottext">Substitution' Term
</span><a href="#local-6989586621681545113"><span class="hs-identifier hs-var">sigma</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TCM (Substitution' Term) -&gt; MaybeT (TCMT IO) (Substitution' Term)
forall a. TCM a -&gt; MaybeT (TCMT IO) a
forall (tcm :: * -&gt; *) a. MonadTCM tcm =&gt; TCM a -&gt; tcm a
</span><a href="Agda.TypeChecking.Monad.Base.html#liftTCM"><span class="hs-identifier hs-var">liftTCM</span></a></span><span> </span><span class="annot"><span class="annottext">(TCM (Substitution' Term) -&gt; MaybeT (TCMT IO) (Substitution' Term))
-&gt; TCM (Substitution' Term)
-&gt; MaybeT (TCMT IO) (Substitution' Term)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Substitution' Term
-&gt; Maybe (Substitution' Term) -&gt; Substitution' Term
forall a. a -&gt; Maybe a -&gt; a
</span><span class="hs-identifier hs-var">fromMaybe</span></span><span> </span><span class="annot"><span class="annottext">Substitution' Term
forall a. Substitution' a
</span><a href="Agda.TypeChecking.Substitute.Class.html#idS"><span class="hs-identifier hs-var">idS</span></a></span><span> </span><span class="annot"><span class="annottext">(Maybe (Substitution' Term) -&gt; Substitution' Term)
-&gt; TCMT IO (Maybe (Substitution' Term)) -&gt; TCM (Substitution' Term)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">ModuleName -&gt; TCMT IO (Maybe (Substitution' Term))
forall (m :: * -&gt; *).
(MonadTCEnv m, ReadTCState m) =&gt;
ModuleName -&gt; m (Maybe (Substitution' Term))
</span><a href="Agda.TypeChecking.Monad.Context.html#getModuleParameterSub"><span class="hs-identifier hs-var">getModuleParameterSub</span></a></span><span> </span><span class="annot"><span class="annottext">ModuleName
</span><a href="#local-6989586621681545091"><span class="hs-identifier hs-var">modN</span></a></span><span>
</span><span id="line-266"></span><span>
</span><span id="line-267"></span><span>  </span><span class="hs-comment">-- Debug printing.</span><span>
</span><span id="line-268"></span><span>  </span><span class="annot"><span class="annottext">String -&gt; Int -&gt; TCMT IO Doc -&gt; MaybeT (TCMT IO) ()
forall (m :: * -&gt; *).
MonadDebug m =&gt;
String -&gt; Int -&gt; TCMT IO Doc -&gt; m ()
</span><a href="Agda.TypeChecking.Monad.Debug.html#reportSDoc"><span class="hs-identifier hs-var">reportSDoc</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;tc.constr.cast&quot;</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">40</span></span><span> </span><span class="annot"><span class="annottext">(TCMT IO Doc -&gt; MaybeT (TCMT IO) ())
-&gt; TCMT IO Doc -&gt; MaybeT (TCMT IO) ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TCMT IO Doc
</span><span class="hs-string">&quot;casting constraint&quot;</span></span><span> </span><span class="annot"><span class="annottext">TCMT IO Doc -&gt; TCMT IO Doc -&gt; TCMT IO Doc
forall (m :: * -&gt; *). Applicative m =&gt; m Doc -&gt; m Doc -&gt; m Doc
</span><a href="Agda.TypeChecking.Pretty.html#%24%24"><span class="hs-operator hs-var">$$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-269"></span><span>    </span><span id="local-6989586621681545118"><span class="annot"><span class="annottext">Tele (Dom Type)
</span><a href="#local-6989586621681545118"><span class="hs-identifier hs-var">tel</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TCMT IO (Tele (Dom Type))
forall (m :: * -&gt; *).
(Applicative m, MonadTCEnv m) =&gt;
m (Tele (Dom Type))
</span><a href="Agda.TypeChecking.Monad.Context.html#getContextTelescope"><span class="hs-identifier hs-var">getContextTelescope</span></a></span><span>
</span><span id="line-270"></span><span>    </span><span class="annot"><span class="annottext">TCMT IO Doc -&gt; TCMT IO Doc
forall (tcm :: * -&gt; *) a.
(MonadTCEnv tcm, ReadTCState tcm) =&gt;
tcm a -&gt; tcm a
</span><a href="Agda.TypeChecking.Monad.Context.html#inTopContext"><span class="hs-identifier hs-var">inTopContext</span></a></span><span> </span><span class="annot"><span class="annottext">(TCMT IO Doc -&gt; TCMT IO Doc) -&gt; TCMT IO Doc -&gt; TCMT IO Doc
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; TCMT IO Doc -&gt; TCMT IO Doc
forall (m :: * -&gt; *). Functor m =&gt; Int -&gt; m Doc -&gt; m Doc
</span><a href="Agda.TypeChecking.Pretty.html#nest"><span class="hs-identifier hs-var">nest</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">2</span></span><span> </span><span class="annot"><span class="annottext">(TCMT IO Doc -&gt; TCMT IO Doc) -&gt; TCMT IO Doc -&gt; TCMT IO Doc
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[TCMT IO Doc] -&gt; TCMT IO Doc
forall (m :: * -&gt; *) (t :: * -&gt; *).
(Applicative m, Foldable t) =&gt;
t (m Doc) -&gt; m Doc
</span><a href="Agda.TypeChecking.Pretty.html#vcat"><span class="hs-identifier hs-var">vcat</span></a></span><span> </span><span class="annot"><span class="annottext">([TCMT IO Doc] -&gt; TCMT IO Doc) -&gt; [TCMT IO Doc] -&gt; TCMT IO Doc
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-271"></span><span>      </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">TCMT IO Doc
</span><span class="hs-string">&quot;current module                = &quot;</span></span><span> </span><span class="annot"><span class="annottext">TCMT IO Doc -&gt; TCMT IO Doc -&gt; TCMT IO Doc
forall (m :: * -&gt; *). Applicative m =&gt; m Doc -&gt; m Doc -&gt; m Doc
</span><a href="Agda.TypeChecking.Pretty.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">ModuleName -&gt; TCMT IO Doc
forall a (m :: * -&gt; *). (PrettyTCM a, MonadPretty m) =&gt; a -&gt; m Doc
forall (m :: * -&gt; *). MonadPretty m =&gt; ModuleName -&gt; m Doc
</span><a href="Agda.TypeChecking.Pretty.html#prettyTCM"><span class="hs-identifier hs-var">prettyTCM</span></a></span><span> </span><span class="annot"><span class="annottext">ModuleName
</span><a href="#local-6989586621681545105"><span class="hs-identifier hs-var">modM</span></a></span><span>
</span><span id="line-272"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">TCMT IO Doc
</span><span class="hs-string">&quot;current module telescope      = &quot;</span></span><span> </span><span class="annot"><span class="annottext">TCMT IO Doc -&gt; TCMT IO Doc -&gt; TCMT IO Doc
forall (m :: * -&gt; *). Applicative m =&gt; m Doc -&gt; m Doc -&gt; m Doc
</span><a href="Agda.TypeChecking.Pretty.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Tele (Dom Type) -&gt; TCMT IO Doc
forall a (m :: * -&gt; *). (PrettyTCM a, MonadPretty m) =&gt; a -&gt; m Doc
forall (m :: * -&gt; *). MonadPretty m =&gt; Tele (Dom Type) -&gt; m Doc
</span><a href="Agda.TypeChecking.Pretty.html#prettyTCM"><span class="hs-identifier hs-var">prettyTCM</span></a></span><span> </span><span class="annot"><span class="annottext">Tele (Dom Type)
</span><a href="#local-6989586621681545109"><span class="hs-identifier hs-var">gamma1</span></a></span><span>
</span><span id="line-273"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">TCMT IO Doc
</span><span class="hs-string">&quot;current context               = &quot;</span></span><span> </span><span class="annot"><span class="annottext">TCMT IO Doc -&gt; TCMT IO Doc -&gt; TCMT IO Doc
forall (m :: * -&gt; *). Applicative m =&gt; m Doc -&gt; m Doc -&gt; m Doc
</span><a href="Agda.TypeChecking.Pretty.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Tele (Dom Type) -&gt; TCMT IO Doc
forall a (m :: * -&gt; *). (PrettyTCM a, MonadPretty m) =&gt; a -&gt; m Doc
forall (m :: * -&gt; *). MonadPretty m =&gt; Tele (Dom Type) -&gt; m Doc
</span><a href="Agda.TypeChecking.Pretty.html#prettyTCM"><span class="hs-identifier hs-var">prettyTCM</span></a></span><span> </span><span class="annot"><span class="annottext">Tele (Dom Type)
</span><a href="#local-6989586621681545118"><span class="hs-identifier hs-var">tel</span></a></span><span>
</span><span id="line-274"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">TCMT IO Doc
</span><span class="hs-string">&quot;constraint module             = &quot;</span></span><span> </span><span class="annot"><span class="annottext">TCMT IO Doc -&gt; TCMT IO Doc -&gt; TCMT IO Doc
forall (m :: * -&gt; *). Applicative m =&gt; m Doc -&gt; m Doc -&gt; m Doc
</span><a href="Agda.TypeChecking.Pretty.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">ModuleName -&gt; TCMT IO Doc
forall a (m :: * -&gt; *). (PrettyTCM a, MonadPretty m) =&gt; a -&gt; m Doc
forall (m :: * -&gt; *). MonadPretty m =&gt; ModuleName -&gt; m Doc
</span><a href="Agda.TypeChecking.Pretty.html#prettyTCM"><span class="hs-identifier hs-var">prettyTCM</span></a></span><span> </span><span class="annot"><span class="annottext">ModuleName
</span><a href="#local-6989586621681545091"><span class="hs-identifier hs-var">modN</span></a></span><span>
</span><span id="line-275"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">TCMT IO Doc
</span><span class="hs-string">&quot;constraint module telescope   = &quot;</span></span><span> </span><span class="annot"><span class="annottext">TCMT IO Doc -&gt; TCMT IO Doc -&gt; TCMT IO Doc
forall (m :: * -&gt; *). Applicative m =&gt; m Doc -&gt; m Doc -&gt; m Doc
</span><a href="Agda.TypeChecking.Pretty.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Tele (Dom Type) -&gt; TCMT IO Doc
forall a (m :: * -&gt; *). (PrettyTCM a, MonadPretty m) =&gt; a -&gt; m Doc
forall (m :: * -&gt; *). MonadPretty m =&gt; Tele (Dom Type) -&gt; m Doc
</span><a href="Agda.TypeChecking.Pretty.html#prettyTCM"><span class="hs-identifier hs-var">prettyTCM</span></a></span><span> </span><span class="annot"><span class="annottext">Tele (Dom Type)
</span><a href="#local-6989586621681545094"><span class="hs-identifier hs-var">delta1</span></a></span><span>
</span><span id="line-276"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">TCMT IO Doc
</span><span class="hs-string">&quot;constraint context            = &quot;</span></span><span> </span><span class="annot"><span class="annottext">TCMT IO Doc -&gt; TCMT IO Doc -&gt; TCMT IO Doc
forall (m :: * -&gt; *). Applicative m =&gt; m Doc -&gt; m Doc -&gt; m Doc
</span><a href="Agda.TypeChecking.Pretty.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Tele (Dom Type) -&gt; TCMT IO Doc
forall a (m :: * -&gt; *). (PrettyTCM a, MonadPretty m) =&gt; a -&gt; m Doc
forall (m :: * -&gt; *). MonadPretty m =&gt; Tele (Dom Type) -&gt; m Doc
</span><a href="Agda.TypeChecking.Pretty.html#prettyTCM"><span class="hs-identifier hs-var">prettyTCM</span></a></span><span> </span><span class="annot"><span class="annottext">(Tele (Dom Type) -&gt; TCMT IO Doc)
-&gt; TCMT IO (Tele (Dom Type)) -&gt; TCMT IO Doc
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; m a -&gt; m b
</span><span class="hs-operator hs-var">=&lt;&lt;</span></span><span> </span><span class="annot"><span class="annottext">Closure Constraint
-&gt; (Constraint -&gt; TCMT IO (Tele (Dom Type)))
-&gt; TCMT IO (Tele (Dom Type))
forall (m :: * -&gt; *) c a b.
(MonadTCEnv m, ReadTCState m, LensClosure c a) =&gt;
c -&gt; (a -&gt; m b) -&gt; m b
</span><a href="Agda.TypeChecking.Monad.Closure.html#enterClosure"><span class="hs-identifier hs-var">enterClosure</span></a></span><span> </span><span class="annot"><span class="annottext">Closure Constraint
</span><a href="#local-6989586621681545090"><span class="hs-identifier hs-var">cl</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TCMT IO (Tele (Dom Type))
-&gt; Constraint -&gt; TCMT IO (Tele (Dom Type))
forall a b. a -&gt; b -&gt; a
</span><span class="hs-identifier hs-var">const</span></span><span> </span><span class="annot"><span class="annottext">(TCMT IO (Tele (Dom Type))
 -&gt; Constraint -&gt; TCMT IO (Tele (Dom Type)))
-&gt; TCMT IO (Tele (Dom Type))
-&gt; Constraint
-&gt; TCMT IO (Tele (Dom Type))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TCMT IO (Tele (Dom Type))
forall (m :: * -&gt; *).
(Applicative m, MonadTCEnv m) =&gt;
m (Tele (Dom Type))
</span><a href="Agda.TypeChecking.Monad.Context.html#getContextTelescope"><span class="hs-identifier hs-var">getContextTelescope</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-277"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">TCMT IO Doc
</span><span class="hs-string">&quot;constraint                    = &quot;</span></span><span> </span><span class="annot"><span class="annottext">TCMT IO Doc -&gt; TCMT IO Doc -&gt; TCMT IO Doc
forall (m :: * -&gt; *). Applicative m =&gt; m Doc -&gt; m Doc -&gt; m Doc
</span><a href="Agda.TypeChecking.Pretty.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Closure Constraint -&gt; (Constraint -&gt; TCMT IO Doc) -&gt; TCMT IO Doc
forall (m :: * -&gt; *) c a b.
(MonadTCEnv m, ReadTCState m, LensClosure c a) =&gt;
c -&gt; (a -&gt; m b) -&gt; m b
</span><a href="Agda.TypeChecking.Monad.Closure.html#enterClosure"><span class="hs-identifier hs-var">enterClosure</span></a></span><span> </span><span class="annot"><span class="annottext">Closure Constraint
</span><a href="#local-6989586621681545090"><span class="hs-identifier hs-var">cl</span></a></span><span> </span><span class="annot"><span class="annottext">Constraint -&gt; TCMT IO Doc
forall a (m :: * -&gt; *). (PrettyTCM a, MonadPretty m) =&gt; a -&gt; m Doc
forall (m :: * -&gt; *). MonadPretty m =&gt; Constraint -&gt; m Doc
</span><a href="Agda.TypeChecking.Pretty.html#prettyTCM"><span class="hs-identifier hs-var">prettyTCM</span></a></span><span>
</span><span id="line-278"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">TCMT IO Doc
</span><span class="hs-string">&quot;module parameter substitution = &quot;</span></span><span> </span><span class="annot"><span class="annottext">TCMT IO Doc -&gt; TCMT IO Doc -&gt; TCMT IO Doc
forall (m :: * -&gt; *). Applicative m =&gt; m Doc -&gt; m Doc -&gt; m Doc
</span><a href="Agda.TypeChecking.Pretty.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Substitution' Term -&gt; TCMT IO Doc
forall a (m :: * -&gt; *). (PrettyTCM a, MonadPretty m) =&gt; a -&gt; m Doc
forall (m :: * -&gt; *). MonadPretty m =&gt; Substitution' Term -&gt; m Doc
</span><a href="Agda.TypeChecking.Pretty.html#prettyTCM"><span class="hs-identifier hs-var">prettyTCM</span></a></span><span> </span><span class="annot"><span class="annottext">Substitution' Term
</span><a href="#local-6989586621681545113"><span class="hs-identifier hs-var">sigma</span></a></span><span>
</span><span id="line-279"></span><span>      </span><span class="hs-special">]</span><span>
</span><span id="line-280"></span><span>
</span><span id="line-281"></span><span>  </span><span class="hs-comment">-- If gamma2 &lt; 0, we must be in the wrong context.</span><span>
</span><span id="line-282"></span><span>  </span><span class="hs-comment">-- E.g. we could have switched to the empty context even though</span><span>
</span><span id="line-283"></span><span>  </span><span class="hs-comment">-- we are still inside a module with parameters.</span><span>
</span><span id="line-284"></span><span>  </span><span class="hs-comment">-- In this case, we cannot safely convert the constraint,</span><span>
</span><span id="line-285"></span><span>  </span><span class="hs-comment">-- since the module parameter substitution may be wrong.</span><span>
</span><span id="line-286"></span><span>  </span><span class="annot"><span class="annottext">Bool -&gt; MaybeT (TCMT IO) ()
forall (f :: * -&gt; *). Alternative f =&gt; Bool -&gt; f ()
</span><span class="hs-identifier hs-var">guard</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681545112"><span class="hs-identifier hs-var">gamma2</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;=</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span>
</span><span id="line-287"></span><span>
</span><span id="line-288"></span><span>  </span><span class="hs-comment">-- Shortcut for modN == modM:</span><span>
</span><span id="line-289"></span><span>  </span><span class="hs-comment">-- Raise constraint from &#916; to &#915;, if possible.</span><span>
</span><span id="line-290"></span><span>  </span><span class="hs-comment">-- This might save us some strengthening.</span><span>
</span><span id="line-291"></span><span>  </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">ModuleName
</span><a href="#local-6989586621681545091"><span class="hs-identifier hs-var">modN</span></a></span><span> </span><span class="annot"><span class="annottext">ModuleName -&gt; ModuleName -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">ModuleName
</span><a href="#local-6989586621681545105"><span class="hs-identifier hs-var">modM</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Constraint -&gt; MaybeT (TCMT IO) Constraint
forall {m :: * -&gt; *} {b}.
(Monad m, Alternative m, Free b, Subst b) =&gt;
Int -&gt; b -&gt; m b
</span><a href="#local-6989586621681545120"><span class="hs-identifier hs-var">raiseMaybe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681545107"><span class="hs-identifier hs-var">gamma</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">Context -&gt; Int
forall a. Sized a =&gt; a -&gt; Int
</span><a href="Agda.Utils.Size.html#size"><span class="hs-identifier hs-var">size</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621681545093"><span class="hs-identifier hs-var">delta</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Constraint -&gt; MaybeT (TCMT IO) Constraint)
-&gt; Constraint -&gt; MaybeT (TCMT IO) Constraint
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Closure Constraint -&gt; Constraint
forall a. Closure a -&gt; a
</span><a href="Agda.TypeChecking.Monad.Base.html#clValue"><span class="hs-identifier hs-var">clValue</span></a></span><span> </span><span class="annot"><span class="annottext">Closure Constraint
</span><a href="#local-6989586621681545090"><span class="hs-identifier hs-var">cl</span></a></span><span> </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-292"></span><span>
</span><span id="line-293"></span><span>  </span><span class="hs-comment">-- Strengthen constraint to &#916;&#8321; &#8866; c</span><span>
</span><span id="line-294"></span><span>  </span><span id="local-6989586621681545122"><span class="annot"><span class="annottext">Constraint
</span><a href="#local-6989586621681545122"><span class="hs-identifier hs-var">c</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Constraint -&gt; MaybeT (TCMT IO) Constraint
forall {m :: * -&gt; *} {b}.
(Monad m, Alternative m, Free b, Subst b) =&gt;
Int -&gt; b -&gt; m b
</span><a href="#local-6989586621681545120"><span class="hs-identifier hs-var">raiseMaybe</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">-</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681545103"><span class="hs-identifier hs-var">delta2</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Constraint -&gt; MaybeT (TCMT IO) Constraint)
-&gt; Constraint -&gt; MaybeT (TCMT IO) Constraint
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Closure Constraint -&gt; Constraint
forall a. Closure a -&gt; a
</span><a href="Agda.TypeChecking.Monad.Base.html#clValue"><span class="hs-identifier hs-var">clValue</span></a></span><span> </span><span class="annot"><span class="annottext">Closure Constraint
</span><a href="#local-6989586621681545090"><span class="hs-identifier hs-var">cl</span></a></span><span>
</span><span id="line-295"></span><span>
</span><span id="line-296"></span><span>  </span><span class="hs-comment">-- Ulf, 2016-11-09: I don't understand what this function does when M and N</span><span>
</span><span id="line-297"></span><span>  </span><span class="hs-comment">-- are not related. Certainly things can go terribly wrong (see</span><span>
</span><span id="line-298"></span><span>  </span><span class="hs-comment">-- test/Succeed/Issue2223b.agda)</span><span>
</span><span id="line-299"></span><span>  </span><span id="local-6989586621681545123"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681545123"><span class="hs-identifier hs-var">fv</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TCM Int -&gt; MaybeT (TCMT IO) Int
forall a. TCM a -&gt; MaybeT (TCMT IO) a
forall (tcm :: * -&gt; *) a. MonadTCM tcm =&gt; TCM a -&gt; tcm a
</span><a href="Agda.TypeChecking.Monad.Base.html#liftTCM"><span class="hs-identifier hs-var">liftTCM</span></a></span><span> </span><span class="annot"><span class="annottext">(TCM Int -&gt; MaybeT (TCMT IO) Int)
-&gt; TCM Int -&gt; MaybeT (TCMT IO) Int
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ModuleName -&gt; TCM Int
forall (m :: * -&gt; *).
(Functor m, Applicative m, MonadTCEnv m, ReadTCState m) =&gt;
ModuleName -&gt; m Int
</span><a href="Agda.TypeChecking.Monad.Signature.html#getModuleFreeVars"><span class="hs-identifier hs-var">getModuleFreeVars</span></a></span><span> </span><span class="annot"><span class="annottext">ModuleName
</span><a href="#local-6989586621681545091"><span class="hs-identifier hs-var">modN</span></a></span><span>
</span><span id="line-300"></span><span>  </span><span class="annot"><span class="annottext">Bool -&gt; MaybeT (TCMT IO) ()
forall (f :: * -&gt; *). Alternative f =&gt; Bool -&gt; f ()
</span><span class="hs-identifier hs-var">guard</span></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; MaybeT (TCMT IO) ()) -&gt; Bool -&gt; MaybeT (TCMT IO) ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681545123"><span class="hs-identifier hs-var">fv</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Tele (Dom Type) -&gt; Int
forall a. Sized a =&gt; a -&gt; Int
</span><a href="Agda.Utils.Size.html#size"><span class="hs-identifier hs-var">size</span></a></span><span> </span><span class="annot"><span class="annottext">Tele (Dom Type)
</span><a href="#local-6989586621681545094"><span class="hs-identifier hs-var">delta1</span></a></span><span>
</span><span id="line-301"></span><span>
</span><span id="line-302"></span><span>  </span><span class="hs-comment">-- &#915; &#8866; c[&#963;]</span><span>
</span><span id="line-303"></span><span>  </span><span class="annot"><span class="annottext">Constraint -&gt; MaybeT (TCMT IO) Constraint
forall a. a -&gt; MaybeT (TCMT IO) a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Constraint -&gt; MaybeT (TCMT IO) Constraint)
-&gt; Constraint -&gt; MaybeT (TCMT IO) Constraint
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Substitution' (SubstArg Constraint) -&gt; Constraint -&gt; Constraint
forall a. Subst a =&gt; Substitution' (SubstArg a) -&gt; a -&gt; a
</span><a href="Agda.TypeChecking.Substitute.Class.html#applySubst"><span class="hs-identifier hs-var">applySubst</span></a></span><span> </span><span class="annot"><span class="annottext">Substitution' Term
Substitution' (SubstArg Constraint)
</span><a href="#local-6989586621681545113"><span class="hs-identifier hs-var">sigma</span></a></span><span> </span><span class="annot"><span class="annottext">Constraint
</span><a href="#local-6989586621681545122"><span class="hs-identifier hs-var">c</span></a></span><span>
</span><span id="line-304"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-305"></span><span>    </span><span id="local-6989586621681545120"><span class="annot"><span class="annottext">raiseMaybe :: Int -&gt; b -&gt; m b
</span><a href="#local-6989586621681545120"><span class="hs-identifier hs-var hs-var">raiseMaybe</span></a></span></span><span> </span><span id="local-6989586621681545148"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681545148"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span id="local-6989586621681545149"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621681545149"><span class="hs-identifier hs-var">c</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-306"></span><span>      </span><span class="hs-comment">-- Fine if we have to weaken or strengthening is safe.</span><span>
</span><span id="line-307"></span><span>      </span><span class="annot"><span class="annottext">Bool -&gt; m ()
forall (f :: * -&gt; *). Alternative f =&gt; Bool -&gt; f ()
</span><span class="hs-identifier hs-var">guard</span></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; m ()) -&gt; Bool -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-308"></span><span>        </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681545148"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;=</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span>
</span><span id="line-309"></span><span>        </span><span class="hs-comment">-- Are all free variables at least -n?</span><span>
</span><span id="line-310"></span><span>        </span><span class="annot"><span class="annottext">IntSet -&gt; Bool
</span><span class="hs-identifier hs-var">IntSet.null</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(IntSet, IntSet) -&gt; IntSet
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="annot"><span class="annottext">((IntSet, IntSet) -&gt; IntSet) -&gt; (IntSet, IntSet) -&gt; IntSet
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; IntSet -&gt; (IntSet, IntSet)
</span><span class="hs-identifier hs-var">IntSet.split</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">-</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681545148"><span class="hs-identifier hs-var">n</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(IntSet -&gt; (IntSet, IntSet)) -&gt; IntSet -&gt; (IntSet, IntSet)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">b -&gt; IntSet
forall t. Free t =&gt; t -&gt; IntSet
</span><a href="Agda.TypeChecking.Free.html#allFreeVars"><span class="hs-identifier hs-var">allFreeVars</span></a></span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621681545149"><span class="hs-identifier hs-var">c</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-311"></span><span>      </span><span class="annot"><span class="annottext">b -&gt; m b
forall a. a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(b -&gt; m b) -&gt; b -&gt; m b
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; b -&gt; b
forall a. Subst a =&gt; Int -&gt; a -&gt; a
</span><a href="Agda.TypeChecking.Substitute.Class.html#raise"><span class="hs-identifier hs-var">raise</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681545148"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621681545149"><span class="hs-identifier hs-var">c</span></a></span><span>
</span><span id="line-312"></span><span>
</span><span id="line-313"></span><span>
</span><span id="line-314"></span><span class="hs-comment">-- | A hazardous hack, may the Gods have mercy on us.</span><span>
</span><span id="line-315"></span><span class="hs-comment">--</span><span>
</span><span id="line-316"></span><span class="hs-comment">--   To cast to the current context, we match the context of the</span><span>
</span><span id="line-317"></span><span class="hs-comment">--   given constraint by 'CtxId', and as fallback, by variable name (douh!).</span><span>
</span><span id="line-318"></span><span class="hs-comment">--</span><span>
</span><span id="line-319"></span><span class="hs-comment">--   This hack lets issue 2046 go through.</span><span>
</span><span id="line-320"></span><span>
</span><span id="line-321"></span><span class="annot"><a href="Agda.TypeChecking.SizedTypes.Solve.html#castConstraintToCurrentContext"><span class="hs-identifier hs-type">castConstraintToCurrentContext</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Agda.TypeChecking.Monad.Base.html#ProblemConstraint"><span class="hs-identifier hs-type">ProblemConstraint</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MaybeT</span></span><span> </span><span class="annot"><a href="Agda.TypeChecking.Monad.Base.html#TCM"><span class="hs-identifier hs-type">TCM</span></a></span><span> </span><span class="annot"><a href="Agda.TypeChecking.Monad.Base.html#ProblemConstraint"><span class="hs-identifier hs-type">ProblemConstraint</span></a></span><span>
</span><span id="line-322"></span><span id="castConstraintToCurrentContext"><span class="annot"><span class="annottext">castConstraintToCurrentContext :: ProblemConstraint -&gt; MaybeT (TCMT IO) ProblemConstraint
</span><a href="Agda.TypeChecking.SizedTypes.Solve.html#castConstraintToCurrentContext"><span class="hs-identifier hs-var hs-var">castConstraintToCurrentContext</span></a></span></span><span> </span><span id="local-6989586621681545156"><span class="annot"><span class="annottext">ProblemConstraint
</span><a href="#local-6989586621681545156"><span class="hs-identifier hs-var">c</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-323"></span><span>  </span><span class="hs-comment">-- The checkpoint of the contraint</span><span>
</span><span id="line-324"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681545157"><span class="annot"><span class="annottext">cl :: Closure Constraint
</span><a href="#local-6989586621681545157"><span class="hs-identifier hs-var hs-var">cl</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ProblemConstraint -&gt; Closure Constraint
</span><a href="Agda.TypeChecking.Monad.Base.html#theConstraint"><span class="hs-identifier hs-var">theConstraint</span></a></span><span> </span><span class="annot"><span class="annottext">ProblemConstraint
</span><a href="#local-6989586621681545156"><span class="hs-identifier hs-var">c</span></a></span><span>
</span><span id="line-325"></span><span>      </span><span id="local-6989586621681545158"><span class="annot"><span class="annottext">cp :: CheckpointId
</span><a href="#local-6989586621681545158"><span class="hs-identifier hs-var hs-var">cp</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TCEnv -&gt; CheckpointId
</span><a href="Agda.TypeChecking.Monad.Base.html#envCurrentCheckpoint"><span class="hs-identifier hs-var">envCurrentCheckpoint</span></a></span><span> </span><span class="annot"><span class="annottext">(TCEnv -&gt; CheckpointId) -&gt; TCEnv -&gt; CheckpointId
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Closure Constraint -&gt; TCEnv
forall a. Closure a -&gt; TCEnv
</span><a href="Agda.TypeChecking.Monad.Base.html#clEnv"><span class="hs-identifier hs-var">clEnv</span></a></span><span> </span><span class="annot"><span class="annottext">Closure Constraint
</span><a href="#local-6989586621681545157"><span class="hs-identifier hs-var">cl</span></a></span><span>
</span><span id="line-326"></span><span>  </span><span id="local-6989586621681545160"><span class="annot"><span class="annottext">Substitution' Term
</span><a href="#local-6989586621681545160"><span class="hs-identifier hs-var">sigma</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">MaybeT (TCMT IO) (Maybe (Substitution' Term))
-&gt; MaybeT (TCMT IO) (Substitution' Term)
-&gt; (Substitution' Term -&gt; MaybeT (TCMT IO) (Substitution' Term))
-&gt; MaybeT (TCMT IO) (Substitution' Term)
forall (m :: * -&gt; *) a b.
Monad m =&gt;
m (Maybe a) -&gt; m b -&gt; (a -&gt; m b) -&gt; m b
</span><a href="Agda.Utils.Maybe.html#caseMaybeM"><span class="hs-identifier hs-var">caseMaybeM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Lens' TCEnv (Maybe (Substitution' Term))
-&gt; MaybeT (TCMT IO) (Maybe (Substitution' Term))
forall (m :: * -&gt; *) a. MonadTCEnv m =&gt; Lens' TCEnv a -&gt; m a
</span><a href="Agda.TypeChecking.Monad.Base.html#viewTC"><span class="hs-identifier hs-var">viewTC</span></a></span><span> </span><span class="annot"><span class="annottext">(Lens' TCEnv (Maybe (Substitution' Term))
 -&gt; MaybeT (TCMT IO) (Maybe (Substitution' Term)))
-&gt; Lens' TCEnv (Maybe (Substitution' Term))
-&gt; MaybeT (TCMT IO) (Maybe (Substitution' Term))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(Map CheckpointId (Substitution' Term)
 -&gt; f (Map CheckpointId (Substitution' Term)))
-&gt; TCEnv -&gt; f TCEnv
Lens' TCEnv (Map CheckpointId (Substitution' Term))
</span><a href="Agda.TypeChecking.Monad.Base.html#eCheckpoints"><span class="hs-identifier hs-var">eCheckpoints</span></a></span><span> </span><span class="annot"><span class="annottext">((Map CheckpointId (Substitution' Term)
  -&gt; f (Map CheckpointId (Substitution' Term)))
 -&gt; TCEnv -&gt; f TCEnv)
-&gt; ((Maybe (Substitution' Term) -&gt; f (Maybe (Substitution' Term)))
    -&gt; Map CheckpointId (Substitution' Term)
    -&gt; f (Map CheckpointId (Substitution' Term)))
-&gt; (Maybe (Substitution' Term) -&gt; f (Maybe (Substitution' Term)))
-&gt; TCEnv
-&gt; f TCEnv
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">CheckpointId
-&gt; Lens'
     (Map CheckpointId (Substitution' Term))
     (Maybe (Substitution' Term))
forall k v. Ord k =&gt; k -&gt; Lens' (Map k v) (Maybe v)
</span><a href="Agda.Utils.Lens.html#key"><span class="hs-identifier hs-var">key</span></a></span><span> </span><span class="annot"><span class="annottext">CheckpointId
</span><a href="#local-6989586621681545158"><span class="hs-identifier hs-var">cp</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-327"></span><span>          </span><span class="hs-special">(</span><span class="hs-keyword">do</span><span>
</span><span id="line-328"></span><span>            </span><span class="hs-comment">-- We are not in a descendant of the constraint checkpoint.</span><span>
</span><span id="line-329"></span><span>            </span><span class="hs-comment">-- Here be dragons!!</span><span>
</span><span id="line-330"></span><span>            </span><span id="local-6989586621681545170"><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621681545170"><span class="hs-identifier hs-var">gamma</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(TCEnv -&gt; Context) -&gt; MaybeT (TCMT IO) Context
forall (m :: * -&gt; *) a. MonadTCEnv m =&gt; (TCEnv -&gt; a) -&gt; m a
</span><a href="Agda.TypeChecking.Monad.Base.html#asksTC"><span class="hs-identifier hs-var">asksTC</span></a></span><span> </span><span class="annot"><span class="annottext">TCEnv -&gt; Context
</span><a href="Agda.TypeChecking.Monad.Base.html#envContext"><span class="hs-identifier hs-var">envContext</span></a></span><span> </span><span class="hs-comment">-- The target context</span><span>
</span><span id="line-331"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681545172"><span class="annot"><span class="annottext">findInGamma :: Dom' Term (Name, Type) -&gt; Maybe Int
</span><a href="#local-6989586621681545172"><span class="hs-identifier hs-var hs-var">findInGamma</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Agda.Syntax.Internal.html#Dom"><span class="hs-identifier hs-type">Dom</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">unDom :: forall t e. Dom' t e -&gt; e
</span><a href="Agda.Syntax.Internal.html#unDom"><span class="hs-identifier hs-var">unDom</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681545175"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681545175"><span class="hs-identifier hs-var">x</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681545176"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681545176"><span class="hs-identifier hs-var">t</span></a></span></span><span class="hs-special">)</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-332"></span><span>                  </span><span class="hs-comment">-- match by name (hazardous)</span><span>
</span><span id="line-333"></span><span>                  </span><span class="hs-comment">-- This is one of the seven deadly sins (not respecting alpha).</span><span>
</span><span id="line-334"></span><span>                  </span><span class="annot"><span class="annottext">(Dom' Term (Name, Type) -&gt; Bool) -&gt; Context -&gt; Maybe Int
forall a. (a -&gt; Bool) -&gt; [a] -&gt; Maybe Int
</span><span class="hs-identifier hs-var">List.findIndex</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681545175"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">Name -&gt; Name -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Name -&gt; Bool)
-&gt; (Dom' Term (Name, Type) -&gt; Name)
-&gt; Dom' Term (Name, Type)
-&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(Name, Type) -&gt; Name
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="annot"><span class="annottext">((Name, Type) -&gt; Name)
-&gt; (Dom' Term (Name, Type) -&gt; (Name, Type))
-&gt; Dom' Term (Name, Type)
-&gt; Name
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Dom' Term (Name, Type) -&gt; (Name, Type)
forall t e. Dom' t e -&gt; e
</span><a href="Agda.Syntax.Internal.html#unDom"><span class="hs-identifier hs-var">unDom</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621681545170"><span class="hs-identifier hs-var">gamma</span></a></span><span>
</span><span id="line-335"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681545178"><span class="annot"><span class="annottext">delta :: Context
</span><a href="#local-6989586621681545178"><span class="hs-identifier hs-var hs-var">delta</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TCEnv -&gt; Context
</span><a href="Agda.TypeChecking.Monad.Base.html#envContext"><span class="hs-identifier hs-var">envContext</span></a></span><span> </span><span class="annot"><span class="annottext">(TCEnv -&gt; Context) -&gt; TCEnv -&gt; Context
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Closure Constraint -&gt; TCEnv
forall a. Closure a -&gt; TCEnv
</span><a href="Agda.TypeChecking.Monad.Base.html#clEnv"><span class="hs-identifier hs-var">clEnv</span></a></span><span> </span><span class="annot"><span class="annottext">Closure Constraint
</span><a href="#local-6989586621681545157"><span class="hs-identifier hs-var">cl</span></a></span><span>
</span><span id="line-336"></span><span>                </span><span id="local-6989586621681545179"><span class="annot"><span class="annottext">cand :: [Maybe Int]
</span><a href="#local-6989586621681545179"><span class="hs-identifier hs-var hs-var">cand</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Dom' Term (Name, Type) -&gt; Maybe Int) -&gt; Context -&gt; [Maybe Int]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Dom' Term (Name, Type) -&gt; Maybe Int
</span><a href="#local-6989586621681545172"><span class="hs-identifier hs-var">findInGamma</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621681545178"><span class="hs-identifier hs-var">delta</span></a></span><span>
</span><span id="line-337"></span><span>            </span><span class="hs-comment">-- The domain of our substitution</span><span>
</span><span id="line-338"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681545180"><span class="annot"><span class="annottext">coveredVars :: IntSet
</span><a href="#local-6989586621681545180"><span class="hs-identifier hs-var hs-var">coveredVars</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Int] -&gt; IntSet
</span><span class="hs-identifier hs-var">VarSet.fromList</span></span><span> </span><span class="annot"><span class="annottext">([Int] -&gt; IntSet) -&gt; [Int] -&gt; IntSet
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Maybe Int] -&gt; [Int]
forall a. [Maybe a] -&gt; [a]
</span><span class="hs-identifier hs-var">catMaybes</span></span><span> </span><span class="annot"><span class="annottext">([Maybe Int] -&gt; [Int]) -&gt; [Maybe Int] -&gt; [Int]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(Maybe Int -&gt; Int -&gt; Maybe Int)
-&gt; [Maybe Int] -&gt; [Int] -&gt; [Maybe Int]
forall a b c. (a -&gt; b -&gt; c) -&gt; [a] -&gt; [b] -&gt; [c]
</span><span class="hs-identifier hs-var">zipWith</span></span><span> </span><span class="annot"><span class="annottext">Maybe Int -&gt; Int -&gt; Maybe Int
forall (f :: * -&gt; *) a b. Functor f =&gt; f a -&gt; b -&gt; f b
</span><span class="hs-operator hs-var">($&gt;)</span></span><span> </span><span class="annot"><span class="annottext">[Maybe Int]
</span><a href="#local-6989586621681545179"><span class="hs-identifier hs-var">cand</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span class="hs-glyph">..</span><span class="hs-special">]</span><span>
</span><span id="line-339"></span><span>            </span><span class="hs-comment">-- Check that all the free variables of the constraint are contained in</span><span>
</span><span id="line-340"></span><span>            </span><span class="hs-comment">-- coveredVars.</span><span>
</span><span id="line-341"></span><span>            </span><span class="hs-comment">-- We ignore the free variables occurring in sorts.</span><span>
</span><span id="line-342"></span><span>            </span><span class="annot"><span class="annottext">Bool -&gt; MaybeT (TCMT IO) ()
forall (f :: * -&gt; *). Alternative f =&gt; Bool -&gt; f ()
</span><span class="hs-identifier hs-var">guard</span></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; MaybeT (TCMT IO) ()) -&gt; Bool -&gt; MaybeT (TCMT IO) ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">All -&gt; Bool
</span><span class="hs-identifier hs-var">getAll</span></span><span> </span><span class="annot"><span class="annottext">(All -&gt; Bool) -&gt; All -&gt; Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SingleVar All -&gt; IgnoreSorts -&gt; Constraint -&gt; All
forall a c t.
(IsVarSet a c, Free t) =&gt;
SingleVar c -&gt; IgnoreSorts -&gt; t -&gt; c
</span><a href="Agda.TypeChecking.Free.html#runFree"><span class="hs-identifier hs-var">runFree</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; All
</span><span class="hs-identifier hs-var">All</span></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; All) -&gt; (Int -&gt; Bool) -&gt; SingleVar All
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; IntSet -&gt; Bool
</span><span class="hs-operator hs-var">`VarSet.member`</span></span><span> </span><span class="annot"><span class="annottext">IntSet
</span><a href="#local-6989586621681545180"><span class="hs-identifier hs-var">coveredVars</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">IgnoreSorts
</span><a href="Agda.TypeChecking.Free.Lazy.html#IgnoreAll"><span class="hs-identifier hs-var">IgnoreAll</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Closure Constraint -&gt; Constraint
forall a. Closure a -&gt; a
</span><a href="Agda.TypeChecking.Monad.Base.html#clValue"><span class="hs-identifier hs-var">clValue</span></a></span><span> </span><span class="annot"><span class="annottext">Closure Constraint
</span><a href="#local-6989586621681545157"><span class="hs-identifier hs-var">cl</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-343"></span><span>            </span><span class="hs-comment">-- Turn cand into a substitution.</span><span>
</span><span id="line-344"></span><span>            </span><span class="hs-comment">-- Since we ignored the free variables in sorts, we better patch up</span><span>
</span><span id="line-345"></span><span>            </span><span class="hs-comment">-- the substitution with some dummy term rather than __IMPOSSIBLE__.</span><span>
</span><span id="line-346"></span><span>            </span><span class="annot"><span class="annottext">Substitution' Term -&gt; MaybeT (TCMT IO) (Substitution' Term)
forall a. a -&gt; MaybeT (TCMT IO) a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Substitution' Term -&gt; MaybeT (TCMT IO) (Substitution' Term))
-&gt; Substitution' Term -&gt; MaybeT (TCMT IO) (Substitution' Term)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Term] -&gt; Substitution' Term
forall a. DeBruijn a =&gt; [a] -&gt; Substitution' a
</span><a href="Agda.TypeChecking.Substitute.Class.html#parallelS"><span class="hs-identifier hs-var">parallelS</span></a></span><span> </span><span class="annot"><span class="annottext">([Term] -&gt; Substitution' Term) -&gt; [Term] -&gt; Substitution' Term
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(Maybe Int -&gt; Term) -&gt; [Maybe Int] -&gt; [Term]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Term -&gt; (Int -&gt; Term) -&gt; Maybe Int -&gt; Term
forall b a. b -&gt; (a -&gt; b) -&gt; Maybe a -&gt; b
</span><span class="hs-identifier hs-var">maybe</span></span><span> </span><span class="annot"><span class="annottext">Term
HasCallStack =&gt; Term
</span><a href="Agda.Syntax.Internal.html#__DUMMY_TERM__"><span class="hs-identifier hs-var">__DUMMY_TERM__</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Term
</span><a href="Agda.Syntax.Internal.html#var"><span class="hs-identifier hs-var">var</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Maybe Int]
</span><a href="#local-6989586621681545179"><span class="hs-identifier hs-var">cand</span></a></span><span>
</span><span id="line-347"></span><span>          </span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Substitution' Term -&gt; MaybeT (TCMT IO) (Substitution' Term)
forall a. a -&gt; MaybeT (TCMT IO) a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-comment">-- Phew, we've got the checkpoint! All is well.</span><span>
</span><span id="line-348"></span><span>  </span><span class="hs-comment">-- Apply substitution to constraint and pray that the Gods are merciful on us.</span><span>
</span><span id="line-349"></span><span>  </span><span id="local-6989586621681545193"><span class="annot"><span class="annottext">Closure Constraint
</span><a href="#local-6989586621681545193"><span class="hs-identifier hs-var">cl'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Constraint -&gt; MaybeT (TCMT IO) (Closure Constraint)
forall (m :: * -&gt; *) a.
(MonadTCEnv m, ReadTCState m) =&gt;
a -&gt; m (Closure a)
</span><a href="Agda.TypeChecking.Monad.Base.html#buildClosure"><span class="hs-identifier hs-var">buildClosure</span></a></span><span> </span><span class="annot"><span class="annottext">(Constraint -&gt; MaybeT (TCMT IO) (Closure Constraint))
-&gt; Constraint -&gt; MaybeT (TCMT IO) (Closure Constraint)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Substitution' (SubstArg Constraint) -&gt; Constraint -&gt; Constraint
forall a. Subst a =&gt; Substitution' (SubstArg a) -&gt; a -&gt; a
</span><a href="Agda.TypeChecking.Substitute.Class.html#applySubst"><span class="hs-identifier hs-var">applySubst</span></a></span><span> </span><span class="annot"><span class="annottext">Substitution' Term
Substitution' (SubstArg Constraint)
</span><a href="#local-6989586621681545160"><span class="hs-identifier hs-var">sigma</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Closure Constraint -&gt; Constraint
forall a. Closure a -&gt; a
</span><a href="Agda.TypeChecking.Monad.Base.html#clValue"><span class="hs-identifier hs-var">clValue</span></a></span><span> </span><span class="annot"><span class="annottext">Closure Constraint
</span><a href="#local-6989586621681545157"><span class="hs-identifier hs-var">cl</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-350"></span><span>  </span><span class="annot"><span class="annottext">ProblemConstraint -&gt; MaybeT (TCMT IO) ProblemConstraint
forall a. a -&gt; MaybeT (TCMT IO) a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(ProblemConstraint -&gt; MaybeT (TCMT IO) ProblemConstraint)
-&gt; ProblemConstraint -&gt; MaybeT (TCMT IO) ProblemConstraint
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ProblemConstraint
</span><a href="#local-6989586621681545156"><span class="hs-identifier hs-var">c</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="Agda.TypeChecking.Monad.Base.html#theConstraint"><span class="hs-identifier hs-var">theConstraint</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621681545193"><span class="hs-identifier hs-type">cl'</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-351"></span><span>  </span><span class="hs-comment">-- Note: the resulting constraint may not well-typed.</span><span>
</span><span id="line-352"></span><span>  </span><span class="hs-comment">-- Even if it is, it may map variables to their wrong counterpart.</span><span>
</span><span id="line-353"></span><span>
</span><span id="line-354"></span><span class="hs-comment">-- | Return the size metas occurring in the simplified constraints.</span><span>
</span><span id="line-355"></span><span class="hs-comment">--   A constraint like @&#8593; _j =&lt; &#8734; : Size@ simplifies to nothing,</span><span>
</span><span id="line-356"></span><span class="hs-comment">--   so @_j@ would not be in this set.</span><span>
</span><span id="line-357"></span><span class="annot"><a href="Agda.TypeChecking.SizedTypes.Solve.html#solveSizeConstraints_"><span class="hs-identifier hs-type">solveSizeConstraints_</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Agda.TypeChecking.SizedTypes.Solve.html#DefaultToInfty"><span class="hs-identifier hs-type">DefaultToInfty</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Agda.TypeChecking.SizedTypes.Solve.html#CC"><span class="hs-identifier hs-type">CC</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Agda.TypeChecking.Monad.Base.html#TCM"><span class="hs-identifier hs-type">TCM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Set</span></span><span> </span><span class="annot"><a href="Agda.Syntax.Common.html#MetaId"><span class="hs-identifier hs-type">MetaId</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-358"></span><span id="solveSizeConstraints_"><span class="annot"><span class="annottext">solveSizeConstraints_ :: DefaultToInfty -&gt; [ProblemConstraint] -&gt; TCMT IO (Set MetaId)
</span><a href="Agda.TypeChecking.SizedTypes.Solve.html#solveSizeConstraints_"><span class="hs-identifier hs-var hs-var">solveSizeConstraints_</span></a></span></span><span> </span><span id="local-6989586621681545195"><span class="annot"><span class="annottext">DefaultToInfty
</span><a href="#local-6989586621681545195"><span class="hs-identifier hs-var">flag</span></a></span></span><span> </span><span id="local-6989586621681545196"><span class="annot"><span class="annottext">[ProblemConstraint]
</span><a href="#local-6989586621681545196"><span class="hs-identifier hs-var">cs0</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-359"></span><span>  </span><span class="hs-comment">-- Pair constraints with their representation as size constraints.</span><span>
</span><span id="line-360"></span><span>  </span><span class="hs-comment">-- Discard constraints that do not have such a representation.</span><span>
</span><span id="line-361"></span><span>  </span><span id="local-6989586621681545197"><span class="annot"><span class="annottext">[(ProblemConstraint, HypSizeConstraint)]
</span><a href="#local-6989586621681545197"><span class="hs-identifier hs-var">ccs</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="Agda.TypeChecking.SizedTypes.Solve.html#CC"><span class="hs-identifier hs-type">CC</span></a></span><span class="hs-special">,</span><span class="annot"><a href="Agda.TypeChecking.SizedTypes.Solve.html#HypSizeConstraint"><span class="hs-identifier hs-type">HypSizeConstraint</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Maybe (ProblemConstraint, HypSizeConstraint)]
-&gt; [(ProblemConstraint, HypSizeConstraint)]
forall a. [Maybe a] -&gt; [a]
</span><span class="hs-identifier hs-var">catMaybes</span></span><span> </span><span class="annot"><span class="annottext">([Maybe (ProblemConstraint, HypSizeConstraint)]
 -&gt; [(ProblemConstraint, HypSizeConstraint)])
-&gt; TCMT IO [Maybe (ProblemConstraint, HypSizeConstraint)]
-&gt; TCMT IO [(ProblemConstraint, HypSizeConstraint)]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-362"></span><span>    </span><span class="annot"><span class="annottext">[ProblemConstraint]
-&gt; (ProblemConstraint
    -&gt; TCMT IO (Maybe (ProblemConstraint, HypSizeConstraint)))
-&gt; TCMT IO [Maybe (ProblemConstraint, HypSizeConstraint)]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m (t b)
</span><span class="hs-identifier hs-var">forM</span></span><span> </span><span class="annot"><span class="annottext">[ProblemConstraint]
</span><a href="#local-6989586621681545196"><span class="hs-identifier hs-var">cs0</span></a></span><span> </span><span class="annot"><span class="annottext">((ProblemConstraint
  -&gt; TCMT IO (Maybe (ProblemConstraint, HypSizeConstraint)))
 -&gt; TCMT IO [Maybe (ProblemConstraint, HypSizeConstraint)])
-&gt; (ProblemConstraint
    -&gt; TCMT IO (Maybe (ProblemConstraint, HypSizeConstraint)))
-&gt; TCMT IO [Maybe (ProblemConstraint, HypSizeConstraint)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span> </span><span id="local-6989586621681545198"><span class="annot"><span class="annottext">ProblemConstraint
</span><a href="#local-6989586621681545198"><span class="hs-identifier hs-var">c0</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(HypSizeConstraint -&gt; (ProblemConstraint, HypSizeConstraint))
-&gt; Maybe HypSizeConstraint
-&gt; Maybe (ProblemConstraint, HypSizeConstraint)
forall a b. (a -&gt; b) -&gt; Maybe a -&gt; Maybe b
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ProblemConstraint
</span><a href="#local-6989586621681545198"><span class="hs-identifier hs-var">c0</span></a></span><span class="hs-special">,</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Maybe HypSizeConstraint
 -&gt; Maybe (ProblemConstraint, HypSizeConstraint))
-&gt; TCMT IO (Maybe HypSizeConstraint)
-&gt; TCMT IO (Maybe (ProblemConstraint, HypSizeConstraint))
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">ProblemConstraint -&gt; TCMT IO (Maybe HypSizeConstraint)
</span><a href="Agda.TypeChecking.SizedTypes.Solve.html#computeSizeConstraint"><span class="hs-identifier hs-var">computeSizeConstraint</span></a></span><span> </span><span class="annot"><span class="annottext">ProblemConstraint
</span><a href="#local-6989586621681545198"><span class="hs-identifier hs-var">c0</span></a></span><span>
</span><span id="line-363"></span><span>
</span><span id="line-364"></span><span>  </span><span class="hs-comment">-- Simplify constraints and check for obvious inconsistencies.</span><span>
</span><span id="line-365"></span><span>  </span><span id="local-6989586621681545200"><span class="annot"><span class="annottext">[(ProblemConstraint, HypSizeConstraint)]
</span><a href="#local-6989586621681545200"><span class="hs-identifier hs-var">ccs'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[[(ProblemConstraint, HypSizeConstraint)]]
-&gt; [(ProblemConstraint, HypSizeConstraint)]
forall (t :: * -&gt; *) a. Foldable t =&gt; t [a] -&gt; [a]
</span><span class="hs-identifier hs-var">concat</span></span><span> </span><span class="annot"><span class="annottext">([[(ProblemConstraint, HypSizeConstraint)]]
 -&gt; [(ProblemConstraint, HypSizeConstraint)])
-&gt; TCMT IO [[(ProblemConstraint, HypSizeConstraint)]]
-&gt; TCMT IO [(ProblemConstraint, HypSizeConstraint)]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-366"></span><span>    </span><span class="annot"><span class="annottext">[(ProblemConstraint, HypSizeConstraint)]
-&gt; ((ProblemConstraint, HypSizeConstraint)
    -&gt; TCMT IO [(ProblemConstraint, HypSizeConstraint)])
-&gt; TCMT IO [[(ProblemConstraint, HypSizeConstraint)]]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m (t b)
</span><span class="hs-identifier hs-var">forM</span></span><span> </span><span class="annot"><span class="annottext">[(ProblemConstraint, HypSizeConstraint)]
</span><a href="#local-6989586621681545197"><span class="hs-identifier hs-var">ccs</span></a></span><span> </span><span class="annot"><span class="annottext">(((ProblemConstraint, HypSizeConstraint)
  -&gt; TCMT IO [(ProblemConstraint, HypSizeConstraint)])
 -&gt; TCMT IO [[(ProblemConstraint, HypSizeConstraint)]])
-&gt; ((ProblemConstraint, HypSizeConstraint)
    -&gt; TCMT IO [(ProblemConstraint, HypSizeConstraint)])
-&gt; TCMT IO [[(ProblemConstraint, HypSizeConstraint)]]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681545202"><span class="annot"><span class="annottext">ProblemConstraint
</span><a href="#local-6989586621681545202"><span class="hs-identifier hs-var">c0</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Agda.TypeChecking.SizedTypes.Solve.html#HypSizeConstraint"><span class="hs-identifier hs-type">HypSizeConstraint</span></a></span><span> </span><span id="local-6989586621681545204"><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621681545204"><span class="hs-identifier hs-var">cxt</span></a></span></span><span> </span><span id="local-6989586621681545205"><span class="annot"><span class="annottext">[Int]
</span><a href="#local-6989586621681545205"><span class="hs-identifier hs-var">hids</span></a></span></span><span> </span><span id="local-6989586621681545206"><span class="annot"><span class="annottext">[SizeConstraint]
</span><a href="#local-6989586621681545206"><span class="hs-identifier hs-var">hs</span></a></span></span><span> </span><span id="local-6989586621681545207"><span class="annot"><span class="annottext">SizeConstraint
</span><a href="#local-6989586621681545207"><span class="hs-identifier hs-var">sc</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-367"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">CTrans NamedRigid SizeMeta -&gt; CTrans NamedRigid SizeMeta
forall f r. (Pretty f, Pretty r, Eq r) =&gt; CTrans r f -&gt; CTrans r f
</span><a href="Agda.TypeChecking.SizedTypes.Syntax.html#simplify1"><span class="hs-identifier hs-var">simplify1</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span> </span><span id="local-6989586621681545209"><span class="annot"><span class="annottext">SizeConstraint
</span><a href="#local-6989586621681545209"><span class="hs-identifier hs-var">sc</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[SizeConstraint] -&gt; Either (TCMT IO Doc) [SizeConstraint]
forall a. a -&gt; Either (TCMT IO Doc) a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">SizeConstraint
</span><a href="#local-6989586621681545209"><span class="hs-identifier hs-var">sc</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SizeConstraint
</span><a href="#local-6989586621681545207"><span class="hs-identifier hs-var">sc</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-368"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span class="annot"><span class="annottext">TCMT IO Doc
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TypeError -&gt; TCMT IO [(ProblemConstraint, HypSizeConstraint)]
forall (m :: * -&gt; *) a.
(HasCallStack, MonadTCError m) =&gt;
TypeError -&gt; m a
</span><a href="Agda.TypeChecking.Monad.Base.html#typeError"><span class="hs-identifier hs-var">typeError</span></a></span><span> </span><span class="annot"><span class="annottext">(TypeError -&gt; TCMT IO [(ProblemConstraint, HypSizeConstraint)])
-&gt; (Doc -&gt; TypeError)
-&gt; Doc
-&gt; TCMT IO [(ProblemConstraint, HypSizeConstraint)]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; TypeError
</span><a href="Agda.TypeChecking.Monad.Base.html#GenericDocError"><span class="hs-identifier hs-var">GenericDocError</span></a></span><span> </span><span class="annot"><span class="annottext">(Doc -&gt; TCMT IO [(ProblemConstraint, HypSizeConstraint)])
-&gt; TCMT IO Doc -&gt; TCMT IO [(ProblemConstraint, HypSizeConstraint)]
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; m a -&gt; m b
</span><span class="hs-operator hs-var">=&lt;&lt;</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-369"></span><span>          </span><span class="annot"><span class="annottext">TCMT IO Doc
</span><span class="hs-string">&quot;Contradictory size constraint&quot;</span></span><span> </span><span class="annot"><span class="annottext">TCMT IO Doc -&gt; TCMT IO Doc -&gt; TCMT IO Doc
forall (m :: * -&gt; *). Applicative m =&gt; m Doc -&gt; m Doc -&gt; m Doc
</span><a href="Agda.TypeChecking.Pretty.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">ProblemConstraint -&gt; TCMT IO Doc
forall a (m :: * -&gt; *). (PrettyTCM a, MonadPretty m) =&gt; a -&gt; m Doc
forall (m :: * -&gt; *). MonadPretty m =&gt; ProblemConstraint -&gt; m Doc
</span><a href="Agda.TypeChecking.Pretty.html#prettyTCM"><span class="hs-identifier hs-var">prettyTCM</span></a></span><span> </span><span class="annot"><span class="annottext">ProblemConstraint
</span><a href="#local-6989586621681545202"><span class="hs-identifier hs-var">c0</span></a></span><span>
</span><span id="line-370"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span id="local-6989586621681545210"><span class="annot"><span class="annottext">[SizeConstraint]
</span><a href="#local-6989586621681545210"><span class="hs-identifier hs-var">cs</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[(ProblemConstraint, HypSizeConstraint)]
-&gt; TCMT IO [(ProblemConstraint, HypSizeConstraint)]
forall a. a -&gt; TCMT IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">([(ProblemConstraint, HypSizeConstraint)]
 -&gt; TCMT IO [(ProblemConstraint, HypSizeConstraint)])
-&gt; [(ProblemConstraint, HypSizeConstraint)]
-&gt; TCMT IO [(ProblemConstraint, HypSizeConstraint)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ProblemConstraint
</span><a href="#local-6989586621681545202"><span class="hs-identifier hs-var">c0</span></a></span><span class="hs-special">,</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(HypSizeConstraint -&gt; (ProblemConstraint, HypSizeConstraint))
-&gt; (SizeConstraint -&gt; HypSizeConstraint)
-&gt; SizeConstraint
-&gt; (ProblemConstraint, HypSizeConstraint)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Context
-&gt; [Int] -&gt; [SizeConstraint] -&gt; SizeConstraint -&gt; HypSizeConstraint
</span><a href="Agda.TypeChecking.SizedTypes.Solve.html#HypSizeConstraint"><span class="hs-identifier hs-var">HypSizeConstraint</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621681545204"><span class="hs-identifier hs-var">cxt</span></a></span><span> </span><span class="annot"><span class="annottext">[Int]
</span><a href="#local-6989586621681545205"><span class="hs-identifier hs-var">hids</span></a></span><span> </span><span class="annot"><span class="annottext">[SizeConstraint]
</span><a href="#local-6989586621681545206"><span class="hs-identifier hs-var">hs</span></a></span><span> </span><span class="annot"><span class="annottext">(SizeConstraint -&gt; (ProblemConstraint, HypSizeConstraint))
-&gt; [SizeConstraint] -&gt; [(ProblemConstraint, HypSizeConstraint)]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">[SizeConstraint]
</span><a href="#local-6989586621681545210"><span class="hs-identifier hs-var">cs</span></a></span><span>
</span><span id="line-371"></span><span>
</span><span id="line-372"></span><span>  </span><span class="hs-comment">-- Cluster constraints according to the meta variables they mention.</span><span>
</span><span id="line-373"></span><span>  </span><span class="hs-comment">-- @csNoM@ are the constraints that do not mention any meta.</span><span>
</span><span id="line-374"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681545211"><span class="annot"><span class="annottext">[(ProblemConstraint, HypSizeConstraint)]
</span><a href="#local-6989586621681545211"><span class="hs-identifier hs-var">csNoM</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681545212"><span class="annot"><span class="annottext">[((ProblemConstraint, HypSizeConstraint), List1 MetaId)]
</span><a href="#local-6989586621681545212"><span class="hs-identifier hs-var">csMs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">((ProblemConstraint, HypSizeConstraint)
 -&gt; Maybe ((ProblemConstraint, HypSizeConstraint), List1 MetaId))
-&gt; [(ProblemConstraint, HypSizeConstraint)]
-&gt; ([(ProblemConstraint, HypSizeConstraint)],
    [((ProblemConstraint, HypSizeConstraint), List1 MetaId)])
forall a b. (a -&gt; Maybe b) -&gt; [a] -&gt; ([a], [b])
</span><a href="Agda.Utils.List.html#partitionMaybe"><span class="hs-operator hs-var">`List.partitionMaybe`</span></a></span><span> </span><span class="annot"><span class="annottext">[(ProblemConstraint, HypSizeConstraint)]
</span><a href="#local-6989586621681545200"><span class="hs-identifier hs-var">ccs'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((ProblemConstraint, HypSizeConstraint)
  -&gt; Maybe ((ProblemConstraint, HypSizeConstraint), List1 MetaId))
 -&gt; ([(ProblemConstraint, HypSizeConstraint)],
     [((ProblemConstraint, HypSizeConstraint), List1 MetaId)]))
-&gt; ((ProblemConstraint, HypSizeConstraint)
    -&gt; Maybe ((ProblemConstraint, HypSizeConstraint), List1 MetaId))
-&gt; ([(ProblemConstraint, HypSizeConstraint)],
    [((ProblemConstraint, HypSizeConstraint), List1 MetaId)])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span> </span><span id="local-6989586621681545214"><span class="annot"><span class="annottext">p :: (ProblemConstraint, HypSizeConstraint)
</span><a href="#local-6989586621681545214"><span class="hs-identifier hs-var">p</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span id="local-6989586621681545215"><span class="annot"><span class="annottext">ProblemConstraint
</span><a href="#local-6989586621681545215"><span class="hs-identifier hs-var">c0</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681545216"><span class="annot"><span class="annottext">HypSizeConstraint
</span><a href="#local-6989586621681545216"><span class="hs-identifier hs-var">c</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-375"></span><span>        </span><span class="annot"><span class="annottext">(List1 MetaId
 -&gt; ((ProblemConstraint, HypSizeConstraint), List1 MetaId))
-&gt; Maybe (List1 MetaId)
-&gt; Maybe ((ProblemConstraint, HypSizeConstraint), List1 MetaId)
forall a b. (a -&gt; b) -&gt; Maybe a -&gt; Maybe b
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(ProblemConstraint, HypSizeConstraint)
</span><a href="#local-6989586621681545214"><span class="hs-identifier hs-var">p</span></a></span><span class="hs-special">,</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Maybe (List1 MetaId)
 -&gt; Maybe ((ProblemConstraint, HypSizeConstraint), List1 MetaId))
-&gt; Maybe (List1 MetaId)
-&gt; Maybe ((ProblemConstraint, HypSizeConstraint), List1 MetaId)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[MetaId] -&gt; Maybe (List1 MetaId)
forall a. [a] -&gt; Maybe (NonEmpty a)
</span><span class="hs-identifier hs-var">nonEmpty</span></span><span> </span><span class="annot"><span class="annottext">([MetaId] -&gt; Maybe (List1 MetaId))
-&gt; [MetaId] -&gt; Maybe (List1 MetaId)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(SizeMeta -&gt; MetaId) -&gt; [SizeMeta] -&gt; [MetaId]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">SizeMeta -&gt; MetaId
</span><a href="Agda.TypeChecking.SizedTypes.Solve.html#sizeMetaId"><span class="hs-identifier hs-var">sizeMetaId</span></a></span><span> </span><span class="annot"><span class="annottext">([SizeMeta] -&gt; [MetaId]) -&gt; [SizeMeta] -&gt; [MetaId]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Set SizeMeta -&gt; [SizeMeta]
forall a. Set a -&gt; [a]
</span><span class="hs-identifier hs-var">Set.toList</span></span><span> </span><span class="annot"><span class="annottext">(Set SizeMeta -&gt; [SizeMeta]) -&gt; Set SizeMeta -&gt; [SizeMeta]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">HypSizeConstraint -&gt; Set (FlexOf HypSizeConstraint)
forall a. Flexs a =&gt; a -&gt; Set (FlexOf a)
</span><a href="Agda.TypeChecking.SizedTypes.Syntax.html#flexs"><span class="hs-identifier hs-var">flexs</span></a></span><span> </span><span class="annot"><span class="annottext">HypSizeConstraint
</span><a href="#local-6989586621681545216"><span class="hs-identifier hs-var">c</span></a></span><span>
</span><span id="line-376"></span><span>  </span><span class="hs-comment">-- @css@ are the clusters of constraints.</span><span>
</span><span id="line-377"></span><span>      </span><span class="annot"><a href="#local-6989586621681545219"><span class="hs-identifier hs-type">css</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Agda.Utils.List1.html#List1"><span class="hs-identifier hs-type">List1</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Agda.TypeChecking.SizedTypes.Solve.html#CC"><span class="hs-identifier hs-type">CC</span></a></span><span class="hs-special">,</span><span class="annot"><a href="Agda.TypeChecking.SizedTypes.Solve.html#HypSizeConstraint"><span class="hs-identifier hs-type">HypSizeConstraint</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-378"></span><span>      </span><span id="local-6989586621681545219"><span class="annot"><span class="annottext">css :: [List1 (ProblemConstraint, HypSizeConstraint)]
</span><a href="#local-6989586621681545219"><span class="hs-identifier hs-var hs-var">css</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[((ProblemConstraint, HypSizeConstraint), List1 MetaId)]
-&gt; [List1 (ProblemConstraint, HypSizeConstraint)]
forall c a. Ord c =&gt; [(a, NonEmpty c)] -&gt; [NonEmpty a]
</span><a href="Agda.Utils.Cluster.html#cluster%27"><span class="hs-identifier hs-var">cluster'</span></a></span><span> </span><span class="annot"><span class="annottext">[((ProblemConstraint, HypSizeConstraint), List1 MetaId)]
</span><a href="#local-6989586621681545212"><span class="hs-identifier hs-var">csMs</span></a></span><span>
</span><span id="line-379"></span><span>
</span><span id="line-380"></span><span>  </span><span class="hs-comment">-- Check that the closed constraints are valid.</span><span>
</span><span id="line-381"></span><span>  </span><span class="annot"><span class="annottext">Maybe (List1 (ProblemConstraint, HypSizeConstraint))
-&gt; (List1 (ProblemConstraint, HypSizeConstraint) -&gt; TCM ())
-&gt; TCM ()
forall (m :: * -&gt; *) a. Monad m =&gt; Maybe a -&gt; (a -&gt; m ()) -&gt; m ()
</span><a href="Agda.Utils.Maybe.html#whenJust"><span class="hs-identifier hs-var">whenJust</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[(ProblemConstraint, HypSizeConstraint)]
-&gt; Maybe (List1 (ProblemConstraint, HypSizeConstraint))
forall a. [a] -&gt; Maybe (NonEmpty a)
</span><span class="hs-identifier hs-var">nonEmpty</span></span><span> </span><span class="annot"><span class="annottext">[(ProblemConstraint, HypSizeConstraint)]
</span><a href="#local-6989586621681545211"><span class="hs-identifier hs-var">csNoM</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((List1 (ProblemConstraint, HypSizeConstraint) -&gt; TCM ())
 -&gt; TCM ())
-&gt; (List1 (ProblemConstraint, HypSizeConstraint) -&gt; TCM ())
-&gt; TCM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">DefaultToInfty
-&gt; List1 (ProblemConstraint, HypSizeConstraint) -&gt; TCM ()
</span><a href="Agda.TypeChecking.SizedTypes.Solve.html#solveCluster"><span class="hs-identifier hs-var">solveCluster</span></a></span><span> </span><span class="annot"><span class="annottext">DefaultToInfty
</span><a href="#local-6989586621681545195"><span class="hs-identifier hs-var">flag</span></a></span><span>
</span><span id="line-382"></span><span>
</span><span id="line-383"></span><span>  </span><span class="hs-comment">-- Now, process the clusters.</span><span>
</span><span id="line-384"></span><span>  </span><span class="annot"><span class="annottext">[List1 (ProblemConstraint, HypSizeConstraint)]
-&gt; (List1 (ProblemConstraint, HypSizeConstraint) -&gt; TCM ())
-&gt; TCM ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="annot"><span class="annottext">[List1 (ProblemConstraint, HypSizeConstraint)]
</span><a href="#local-6989586621681545219"><span class="hs-identifier hs-var">css</span></a></span><span> </span><span class="annot"><span class="annottext">((List1 (ProblemConstraint, HypSizeConstraint) -&gt; TCM ())
 -&gt; TCM ())
-&gt; (List1 (ProblemConstraint, HypSizeConstraint) -&gt; TCM ())
-&gt; TCM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">DefaultToInfty
-&gt; List1 (ProblemConstraint, HypSizeConstraint) -&gt; TCM ()
</span><a href="Agda.TypeChecking.SizedTypes.Solve.html#solveCluster"><span class="hs-identifier hs-var">solveCluster</span></a></span><span> </span><span class="annot"><span class="annottext">DefaultToInfty
</span><a href="#local-6989586621681545195"><span class="hs-identifier hs-var">flag</span></a></span><span>
</span><span id="line-385"></span><span>
</span><span id="line-386"></span><span>  </span><span class="annot"><span class="annottext">Set MetaId -&gt; TCMT IO (Set MetaId)
forall a. a -&gt; TCMT IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Set MetaId -&gt; TCMT IO (Set MetaId))
-&gt; Set MetaId -&gt; TCMT IO (Set MetaId)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(SizeMeta -&gt; MetaId) -&gt; Set SizeMeta -&gt; Set MetaId
forall a b. (a -&gt; b) -&gt; Set a -&gt; Set b
</span><span class="hs-identifier hs-var">Set.mapMonotonic</span></span><span> </span><span class="annot"><span class="annottext">SizeMeta -&gt; MetaId
</span><a href="Agda.TypeChecking.SizedTypes.Solve.html#sizeMetaId"><span class="hs-identifier hs-var">sizeMetaId</span></a></span><span> </span><span class="annot"><span class="annottext">(Set SizeMeta -&gt; Set MetaId) -&gt; Set SizeMeta -&gt; Set MetaId
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[HypSizeConstraint] -&gt; Set (FlexOf [HypSizeConstraint])
forall a. Flexs a =&gt; a -&gt; Set (FlexOf a)
</span><a href="Agda.TypeChecking.SizedTypes.Syntax.html#flexs"><span class="hs-identifier hs-var">flexs</span></a></span><span> </span><span class="annot"><span class="annottext">([HypSizeConstraint] -&gt; Set (FlexOf [HypSizeConstraint]))
-&gt; [HypSizeConstraint] -&gt; Set (FlexOf [HypSizeConstraint])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(((ProblemConstraint, HypSizeConstraint), List1 MetaId)
 -&gt; HypSizeConstraint)
-&gt; [((ProblemConstraint, HypSizeConstraint), List1 MetaId)]
-&gt; [HypSizeConstraint]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(ProblemConstraint, HypSizeConstraint) -&gt; HypSizeConstraint
forall a b. (a, b) -&gt; b
</span><span class="hs-identifier hs-var">snd</span></span><span> </span><span class="annot"><span class="annottext">((ProblemConstraint, HypSizeConstraint) -&gt; HypSizeConstraint)
-&gt; (((ProblemConstraint, HypSizeConstraint), List1 MetaId)
    -&gt; (ProblemConstraint, HypSizeConstraint))
-&gt; ((ProblemConstraint, HypSizeConstraint), List1 MetaId)
-&gt; HypSizeConstraint
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">((ProblemConstraint, HypSizeConstraint), List1 MetaId)
-&gt; (ProblemConstraint, HypSizeConstraint)
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[((ProblemConstraint, HypSizeConstraint), List1 MetaId)]
</span><a href="#local-6989586621681545212"><span class="hs-identifier hs-var">csMs</span></a></span><span>
</span><span id="line-387"></span><span>
</span><span id="line-388"></span><span class="hs-comment">-- | Solve a cluster of constraints sharing some metas.</span><span>
</span><span id="line-389"></span><span class="hs-comment">--</span><span>
</span><span id="line-390"></span><span class="annot"><a href="Agda.TypeChecking.SizedTypes.Solve.html#solveCluster"><span class="hs-identifier hs-type">solveCluster</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Agda.TypeChecking.SizedTypes.Solve.html#DefaultToInfty"><span class="hs-identifier hs-type">DefaultToInfty</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Agda.Utils.List1.html#List1"><span class="hs-identifier hs-type">List1</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Agda.TypeChecking.SizedTypes.Solve.html#CC"><span class="hs-identifier hs-type">CC</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Agda.TypeChecking.SizedTypes.Solve.html#HypSizeConstraint"><span class="hs-identifier hs-type">HypSizeConstraint</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Agda.TypeChecking.Monad.Base.html#TCM"><span class="hs-identifier hs-type">TCM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-391"></span><span id="solveCluster"><span class="annot"><span class="annottext">solveCluster :: DefaultToInfty
-&gt; List1 (ProblemConstraint, HypSizeConstraint) -&gt; TCM ()
</span><a href="Agda.TypeChecking.SizedTypes.Solve.html#solveCluster"><span class="hs-identifier hs-var hs-var">solveCluster</span></a></span></span><span> </span><span id="local-6989586621681545224"><span class="annot"><span class="annottext">DefaultToInfty
</span><a href="#local-6989586621681545224"><span class="hs-identifier hs-var">flag</span></a></span></span><span> </span><span id="local-6989586621681545225"><span class="annot"><span class="annottext">List1 (ProblemConstraint, HypSizeConstraint)
</span><a href="#local-6989586621681545225"><span class="hs-identifier hs-var">ccs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-392"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681545226"><span class="annot"><span class="annottext">cs :: NonEmpty HypSizeConstraint
</span><a href="#local-6989586621681545226"><span class="hs-identifier hs-var hs-var">cs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((ProblemConstraint, HypSizeConstraint) -&gt; HypSizeConstraint)
-&gt; List1 (ProblemConstraint, HypSizeConstraint)
-&gt; NonEmpty HypSizeConstraint
forall a b. (a -&gt; b) -&gt; NonEmpty a -&gt; NonEmpty b
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">(ProblemConstraint, HypSizeConstraint) -&gt; HypSizeConstraint
forall a b. (a, b) -&gt; b
</span><span class="hs-identifier hs-var">snd</span></span><span> </span><span class="annot"><span class="annottext">List1 (ProblemConstraint, HypSizeConstraint)
</span><a href="#local-6989586621681545225"><span class="hs-identifier hs-var">ccs</span></a></span><span>
</span><span id="line-393"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681545227"><span class="annot"><span class="annottext">prettyCs :: [TCMT IO Doc]
</span><a href="#local-6989586621681545227"><span class="hs-identifier hs-var hs-var">prettyCs</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(HypSizeConstraint -&gt; TCMT IO Doc)
-&gt; [HypSizeConstraint] -&gt; [TCMT IO Doc]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">HypSizeConstraint -&gt; TCMT IO Doc
forall a (m :: * -&gt; *). (PrettyTCM a, MonadPretty m) =&gt; a -&gt; m Doc
forall (m :: * -&gt; *). MonadPretty m =&gt; HypSizeConstraint -&gt; m Doc
</span><a href="Agda.TypeChecking.Pretty.html#prettyTCM"><span class="hs-identifier hs-var">prettyTCM</span></a></span><span> </span><span class="annot"><span class="annottext">([HypSizeConstraint] -&gt; [TCMT IO Doc])
-&gt; [HypSizeConstraint] -&gt; [TCMT IO Doc]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">NonEmpty HypSizeConstraint -&gt; [Item (NonEmpty HypSizeConstraint)]
forall l. IsList l =&gt; l -&gt; [Item l]
</span><span class="hs-identifier hs-var">List1.toList</span></span><span> </span><span class="annot"><span class="annottext">NonEmpty HypSizeConstraint
</span><a href="#local-6989586621681545226"><span class="hs-identifier hs-var">cs</span></a></span><span>
</span><span id="line-394"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681545228"><span class="annot"><span class="annottext">err :: TCMT IO Doc -&gt; TCMT IO (Solution NamedRigid MetaId)
</span><a href="#local-6989586621681545228"><span class="hs-identifier hs-var hs-var">err</span></a></span></span><span> </span><span id="local-6989586621681545229"><span class="annot"><span class="annottext">TCMT IO Doc
</span><a href="#local-6989586621681545229"><span class="hs-identifier hs-var">reason</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TypeError -&gt; TCMT IO (Solution NamedRigid MetaId)
forall (m :: * -&gt; *) a.
(HasCallStack, MonadTCError m) =&gt;
TypeError -&gt; m a
</span><a href="Agda.TypeChecking.Monad.Base.html#typeError"><span class="hs-identifier hs-var">typeError</span></a></span><span> </span><span class="annot"><span class="annottext">(TypeError -&gt; TCMT IO (Solution NamedRigid MetaId))
-&gt; (Doc -&gt; TypeError)
-&gt; Doc
-&gt; TCMT IO (Solution NamedRigid MetaId)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; TypeError
</span><a href="Agda.TypeChecking.Monad.Base.html#GenericDocError"><span class="hs-identifier hs-var">GenericDocError</span></a></span><span> </span><span class="annot"><span class="annottext">(Doc -&gt; TCMT IO (Solution NamedRigid MetaId))
-&gt; TCMT IO Doc -&gt; TCMT IO (Solution NamedRigid MetaId)
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; m a -&gt; m b
</span><span class="hs-operator hs-var">=&lt;&lt;</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-395"></span><span>        </span><span class="annot"><span class="annottext">[TCMT IO Doc] -&gt; TCMT IO Doc
forall (m :: * -&gt; *) (t :: * -&gt; *).
(Applicative m, Foldable t) =&gt;
t (m Doc) -&gt; m Doc
</span><a href="Agda.TypeChecking.Pretty.html#vcat"><span class="hs-identifier hs-var">vcat</span></a></span><span> </span><span class="annot"><span class="annottext">([TCMT IO Doc] -&gt; TCMT IO Doc) -&gt; [TCMT IO Doc] -&gt; TCMT IO Doc
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-396"></span><span>          </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">String -&gt; TCMT IO Doc
forall (m :: * -&gt; *). Applicative m =&gt; String -&gt; m Doc
</span><a href="Agda.TypeChecking.Pretty.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">(String -&gt; TCMT IO Doc) -&gt; String -&gt; TCMT IO Doc
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Cannot solve size constraints&quot;</span></span><span> </span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">[TCMT IO Doc] -&gt; [TCMT IO Doc] -&gt; [TCMT IO Doc]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[TCMT IO Doc]
</span><a href="#local-6989586621681545227"><span class="hs-identifier hs-var">prettyCs</span></a></span><span> </span><span class="annot"><span class="annottext">[TCMT IO Doc] -&gt; [TCMT IO Doc] -&gt; [TCMT IO Doc]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span>
</span><span id="line-397"></span><span>          </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">TCMT IO Doc
</span><span class="hs-string">&quot;Reason:&quot;</span></span><span> </span><span class="annot"><span class="annottext">TCMT IO Doc -&gt; TCMT IO Doc -&gt; TCMT IO Doc
forall (m :: * -&gt; *). Applicative m =&gt; m Doc -&gt; m Doc -&gt; m Doc
</span><a href="Agda.TypeChecking.Pretty.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">TCMT IO Doc
</span><a href="#local-6989586621681545229"><span class="hs-identifier hs-var">reason</span></a></span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-398"></span><span>  </span><span class="annot"><span class="annottext">String -&gt; Int -&gt; TCMT IO Doc -&gt; TCM ()
forall (m :: * -&gt; *).
MonadDebug m =&gt;
String -&gt; Int -&gt; TCMT IO Doc -&gt; m ()
</span><a href="Agda.TypeChecking.Monad.Debug.html#reportSDoc"><span class="hs-identifier hs-var">reportSDoc</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;tc.size.solve&quot;</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">20</span></span><span> </span><span class="annot"><span class="annottext">(TCMT IO Doc -&gt; TCM ()) -&gt; TCMT IO Doc -&gt; TCM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[TCMT IO Doc] -&gt; TCMT IO Doc
forall (m :: * -&gt; *) (t :: * -&gt; *).
(Applicative m, Foldable t) =&gt;
t (m Doc) -&gt; m Doc
</span><a href="Agda.TypeChecking.Pretty.html#vcat"><span class="hs-identifier hs-var">vcat</span></a></span><span> </span><span class="annot"><span class="annottext">([TCMT IO Doc] -&gt; TCMT IO Doc) -&gt; [TCMT IO Doc] -&gt; TCMT IO Doc
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-399"></span><span>    </span><span class="annot"><span class="annottext">TCMT IO Doc
</span><span class="hs-string">&quot;Solving constraint cluster&quot;</span></span><span> </span><span class="annot"><span class="annottext">TCMT IO Doc -&gt; [TCMT IO Doc] -&gt; [TCMT IO Doc]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[TCMT IO Doc]
</span><a href="#local-6989586621681545227"><span class="hs-identifier hs-var">prettyCs</span></a></span><span>
</span><span id="line-400"></span><span>  </span><span class="hs-comment">-- Find the super context of all contexts.</span><span>
</span><span id="line-401"></span><span class="hs-comment">{-
  -- We use the @'ctxId'@s.
  let cis@(ci:cis') = for cs $ \ c -&gt; (c, reverse $ map ctxId $ sizeContext c)
--  let cis@(ci:cis') = for cs $ \ c -&gt; (c, reverse $ sizeHypIds c)
      max a@Left{}            _            = a
      max a@(Right ci@(c,is)) ci'@(c',is') =
        case preOrSuffix is is' of
          -- No common context:
          IsNofix    -&gt; Left (ci, ci')
          IsPrefix{} -&gt; Right ci'
          _          -&gt; a
      res = foldl' max (Right ci) cis'
      noContext ((c,is),(c',is')) = typeError . GenericDocError =&lt;&lt; vcat
        [ &quot;Cannot solve size constraints; the following constraints have no common typing context:&quot;
        , prettyTCM c
        , prettyTCM c'
        ]
  flip (either noContext) res $ \ (HypSizeConstraint gamma hids hs _, _) -&gt; do
-}</span><span>
</span><span id="line-420"></span><span>  </span><span class="hs-comment">-- We rely on the fact that contexts are only extended...</span><span>
</span><span id="line-421"></span><span>  </span><span class="hs-comment">-- Just take the longest context.</span><span>
</span><span id="line-422"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="Agda.TypeChecking.SizedTypes.Solve.html#HypSizeConstraint"><span class="hs-identifier hs-type">HypSizeConstraint</span></a></span><span> </span><span id="local-6989586621681545230"><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621681545230"><span class="hs-identifier hs-var">gamma</span></a></span></span><span> </span><span id="local-6989586621681545231"><span class="annot"><span class="annottext">[Int]
</span><a href="#local-6989586621681545231"><span class="hs-identifier hs-var">hids</span></a></span></span><span> </span><span id="local-6989586621681545232"><span class="annot"><span class="annottext">[SizeConstraint]
</span><a href="#local-6989586621681545232"><span class="hs-identifier hs-var">hs</span></a></span></span><span> </span><span class="annot"><span class="annottext">SizeConstraint
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(HypSizeConstraint -&gt; HypSizeConstraint -&gt; Ordering)
-&gt; NonEmpty HypSizeConstraint -&gt; HypSizeConstraint
forall (t :: * -&gt; *) a.
Foldable t =&gt;
(a -&gt; a -&gt; Ordering) -&gt; t a -&gt; a
</span><span class="hs-identifier hs-var">Fold.maximumBy</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Ordering
forall a. Ord a =&gt; a -&gt; a -&gt; Ordering
</span><span class="hs-identifier hs-var">compare</span></span><span> </span><span class="annot"><span class="annottext">(Int -&gt; Int -&gt; Ordering)
-&gt; (HypSizeConstraint -&gt; Int)
-&gt; HypSizeConstraint
-&gt; HypSizeConstraint
-&gt; Ordering
forall b c a. (b -&gt; b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; a -&gt; c
</span><span class="hs-operator hs-var">`on`</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Context -&gt; Int
forall a. [a] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">(Context -&gt; Int)
-&gt; (HypSizeConstraint -&gt; Context) -&gt; HypSizeConstraint -&gt; Int
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">HypSizeConstraint -&gt; Context
</span><a href="Agda.TypeChecking.SizedTypes.Solve.html#sizeContext"><span class="hs-identifier hs-var">sizeContext</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">NonEmpty HypSizeConstraint
</span><a href="#local-6989586621681545226"><span class="hs-identifier hs-var">cs</span></a></span><span>
</span><span id="line-423"></span><span>  </span><span class="hs-comment">-- Length of longest context.</span><span>
</span><span id="line-424"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681545234"><span class="annot"><span class="annottext">n :: Int
</span><a href="#local-6989586621681545234"><span class="hs-identifier hs-var hs-var">n</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Context -&gt; Int
forall a. Sized a =&gt; a -&gt; Int
</span><a href="Agda.Utils.Size.html#size"><span class="hs-identifier hs-var">size</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621681545230"><span class="hs-identifier hs-var">gamma</span></a></span><span>
</span><span id="line-425"></span><span>
</span><span id="line-426"></span><span>  </span><span class="hs-comment">-- Now convert all size constraints to the largest context.</span><span>
</span><span id="line-427"></span><span>      </span><span id="local-6989586621681545235"><span class="annot"><span class="annottext">csL :: NonEmpty SizeConstraint
</span><a href="#local-6989586621681545235"><span class="hs-identifier hs-var hs-var">csL</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">NonEmpty HypSizeConstraint
-&gt; (HypSizeConstraint -&gt; SizeConstraint) -&gt; NonEmpty SizeConstraint
forall (f :: * -&gt; *) a b. Functor f =&gt; f a -&gt; (a -&gt; b) -&gt; f b
</span><a href="Agda.Utils.Functor.html#for"><span class="hs-identifier hs-var">for</span></a></span><span> </span><span class="annot"><span class="annottext">NonEmpty HypSizeConstraint
</span><a href="#local-6989586621681545226"><span class="hs-identifier hs-var">cs</span></a></span><span> </span><span class="annot"><span class="annottext">((HypSizeConstraint -&gt; SizeConstraint) -&gt; NonEmpty SizeConstraint)
-&gt; (HypSizeConstraint -&gt; SizeConstraint) -&gt; NonEmpty SizeConstraint
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Agda.TypeChecking.SizedTypes.Solve.html#HypSizeConstraint"><span class="hs-identifier hs-type">HypSizeConstraint</span></a></span><span> </span><span id="local-6989586621681545237"><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621681545237"><span class="hs-identifier hs-var">cxt</span></a></span></span><span> </span><span class="annot"><span class="annottext">[Int]
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">[SizeConstraint]
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621681545238"><span class="annot"><span class="annottext">SizeConstraint
</span><a href="#local-6989586621681545238"><span class="hs-identifier hs-var">c</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Int -&gt; SizeConstraint -&gt; SizeConstraint
forall a. Subst a =&gt; Int -&gt; a -&gt; a
</span><a href="Agda.TypeChecking.Substitute.Class.html#raise"><span class="hs-identifier hs-var">raise</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681545234"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">Context -&gt; Int
forall a. Sized a =&gt; a -&gt; Int
</span><a href="Agda.Utils.Size.html#size"><span class="hs-identifier hs-var">size</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621681545237"><span class="hs-identifier hs-var">cxt</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SizeConstraint
</span><a href="#local-6989586621681545238"><span class="hs-identifier hs-var">c</span></a></span><span>
</span><span id="line-428"></span><span>  </span><span class="hs-comment">-- Canonicalize the constraints.</span><span>
</span><span id="line-429"></span><span>  </span><span class="hs-comment">-- This is unsound in the presence of hypotheses.</span><span>
</span><span id="line-430"></span><span>      </span><span class="annot"><a href="#local-6989586621681545239"><span class="hs-identifier hs-type">csC</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Agda.TypeChecking.SizedTypes.Solve.html#SizeConstraint"><span class="hs-identifier hs-type">SizeConstraint</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-431"></span><span>      </span><span id="local-6989586621681545239"><span class="annot"><span class="annottext">csC :: [SizeConstraint]
</span><a href="#local-6989586621681545239"><span class="hs-identifier hs-var hs-var">csC</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
-&gt; ([SizeConstraint] -&gt; [SizeConstraint])
-&gt; [SizeConstraint]
-&gt; [SizeConstraint]
forall b a. IsBool b =&gt; b -&gt; (a -&gt; a) -&gt; a -&gt; a
</span><a href="Agda.Utils.Function.html#applyWhen"><span class="hs-identifier hs-var">applyWhen</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SizeConstraint] -&gt; Bool
forall a. Null a =&gt; a -&gt; Bool
</span><a href="Agda.Utils.Null.html#null"><span class="hs-identifier hs-var">null</span></a></span><span> </span><span class="annot"><span class="annottext">[SizeConstraint]
</span><a href="#local-6989586621681545232"><span class="hs-identifier hs-var">hs</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(SizeConstraint -&gt; Maybe SizeConstraint)
-&gt; [SizeConstraint] -&gt; [SizeConstraint]
forall a b. (a -&gt; Maybe b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">mapMaybe</span></span><span> </span><span class="annot"><span class="annottext">SizeConstraint -&gt; Maybe SizeConstraint
</span><a href="Agda.TypeChecking.SizedTypes.Solve.html#canonicalizeSizeConstraint"><span class="hs-identifier hs-var">canonicalizeSizeConstraint</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([SizeConstraint] -&gt; [SizeConstraint])
-&gt; [SizeConstraint] -&gt; [SizeConstraint]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">NonEmpty SizeConstraint -&gt; [Item (NonEmpty SizeConstraint)]
forall l. IsList l =&gt; l -&gt; [Item l]
</span><span class="hs-identifier hs-var">List1.toList</span></span><span> </span><span class="annot"><span class="annottext">NonEmpty SizeConstraint
</span><a href="#local-6989586621681545235"><span class="hs-identifier hs-var">csL</span></a></span><span>
</span><span id="line-432"></span><span>  </span><span class="annot"><span class="annottext">String -&gt; Int -&gt; TCMT IO Doc -&gt; TCM ()
forall (m :: * -&gt; *).
MonadDebug m =&gt;
String -&gt; Int -&gt; TCMT IO Doc -&gt; m ()
</span><a href="Agda.TypeChecking.Monad.Debug.html#reportSDoc"><span class="hs-identifier hs-var">reportSDoc</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;tc.size.solve&quot;</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">30</span></span><span> </span><span class="annot"><span class="annottext">(TCMT IO Doc -&gt; TCM ()) -&gt; TCMT IO Doc -&gt; TCM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[TCMT IO Doc] -&gt; TCMT IO Doc
forall (m :: * -&gt; *) (t :: * -&gt; *).
(Applicative m, Foldable t) =&gt;
t (m Doc) -&gt; m Doc
</span><a href="Agda.TypeChecking.Pretty.html#vcat"><span class="hs-identifier hs-var">vcat</span></a></span><span> </span><span class="annot"><span class="annottext">([TCMT IO Doc] -&gt; TCMT IO Doc) -&gt; [TCMT IO Doc] -&gt; TCMT IO Doc
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-433"></span><span>    </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">TCMT IO Doc
</span><span class="hs-string">&quot;Size hypotheses&quot;</span></span><span> </span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">[TCMT IO Doc] -&gt; [TCMT IO Doc] -&gt; [TCMT IO Doc]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span>
</span><span id="line-434"></span><span>    </span><span class="annot"><span class="annottext">(SizeConstraint -&gt; TCMT IO Doc)
-&gt; [SizeConstraint] -&gt; [TCMT IO Doc]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HypSizeConstraint -&gt; TCMT IO Doc
forall a (m :: * -&gt; *). (PrettyTCM a, MonadPretty m) =&gt; a -&gt; m Doc
forall (m :: * -&gt; *). MonadPretty m =&gt; HypSizeConstraint -&gt; m Doc
</span><a href="Agda.TypeChecking.Pretty.html#prettyTCM"><span class="hs-identifier hs-var">prettyTCM</span></a></span><span> </span><span class="annot"><span class="annottext">(HypSizeConstraint -&gt; TCMT IO Doc)
-&gt; (SizeConstraint -&gt; HypSizeConstraint)
-&gt; SizeConstraint
-&gt; TCMT IO Doc
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Context
-&gt; [Int] -&gt; [SizeConstraint] -&gt; SizeConstraint -&gt; HypSizeConstraint
</span><a href="Agda.TypeChecking.SizedTypes.Solve.html#HypSizeConstraint"><span class="hs-identifier hs-var">HypSizeConstraint</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621681545230"><span class="hs-identifier hs-var">gamma</span></a></span><span> </span><span class="annot"><span class="annottext">[Int]
</span><a href="#local-6989586621681545231"><span class="hs-identifier hs-var">hids</span></a></span><span> </span><span class="annot"><span class="annottext">[SizeConstraint]
</span><a href="#local-6989586621681545232"><span class="hs-identifier hs-var">hs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[SizeConstraint]
</span><a href="#local-6989586621681545232"><span class="hs-identifier hs-var">hs</span></a></span><span> </span><span class="annot"><span class="annottext">[TCMT IO Doc] -&gt; [TCMT IO Doc] -&gt; [TCMT IO Doc]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span>
</span><span id="line-435"></span><span>    </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">TCMT IO Doc
</span><span class="hs-string">&quot;Canonicalized constraints&quot;</span></span><span> </span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">[TCMT IO Doc] -&gt; [TCMT IO Doc] -&gt; [TCMT IO Doc]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span>
</span><span id="line-436"></span><span>    </span><span class="annot"><span class="annottext">(SizeConstraint -&gt; TCMT IO Doc)
-&gt; [SizeConstraint] -&gt; [TCMT IO Doc]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HypSizeConstraint -&gt; TCMT IO Doc
forall a (m :: * -&gt; *). (PrettyTCM a, MonadPretty m) =&gt; a -&gt; m Doc
forall (m :: * -&gt; *). MonadPretty m =&gt; HypSizeConstraint -&gt; m Doc
</span><a href="Agda.TypeChecking.Pretty.html#prettyTCM"><span class="hs-identifier hs-var">prettyTCM</span></a></span><span> </span><span class="annot"><span class="annottext">(HypSizeConstraint -&gt; TCMT IO Doc)
-&gt; (SizeConstraint -&gt; HypSizeConstraint)
-&gt; SizeConstraint
-&gt; TCMT IO Doc
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Context
-&gt; [Int] -&gt; [SizeConstraint] -&gt; SizeConstraint -&gt; HypSizeConstraint
</span><a href="Agda.TypeChecking.SizedTypes.Solve.html#HypSizeConstraint"><span class="hs-identifier hs-var">HypSizeConstraint</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621681545230"><span class="hs-identifier hs-var">gamma</span></a></span><span> </span><span class="annot"><span class="annottext">[Int]
</span><a href="#local-6989586621681545231"><span class="hs-identifier hs-var">hids</span></a></span><span> </span><span class="annot"><span class="annottext">[SizeConstraint]
</span><a href="#local-6989586621681545232"><span class="hs-identifier hs-var">hs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[SizeConstraint]
</span><a href="#local-6989586621681545239"><span class="hs-identifier hs-var">csC</span></a></span><span>
</span><span id="line-437"></span><span>
</span><span id="line-438"></span><span>  </span><span class="hs-comment">-- -- ALT:</span><span>
</span><span id="line-439"></span><span>  </span><span class="hs-comment">-- -- Now convert all size constraints to de Bruijn levels.</span><span>
</span><span id="line-440"></span><span>
</span><span id="line-441"></span><span>  </span><span class="hs-comment">-- -- To get from indices in a context of length m &lt;= n</span><span>
</span><span id="line-442"></span><span>  </span><span class="hs-comment">-- -- to levels into the target context of length n,</span><span>
</span><span id="line-443"></span><span>  </span><span class="hs-comment">-- -- we apply the following substitution:</span><span>
</span><span id="line-444"></span><span>  </span><span class="hs-comment">-- -- Index m-1 needs to be mapped to level 0,</span><span>
</span><span id="line-445"></span><span>  </span><span class="hs-comment">-- -- index m-2 needs to be mapped to level 1,</span><span>
</span><span id="line-446"></span><span>  </span><span class="hs-comment">-- -- index 0 needs to be mapped to level m-1,</span><span>
</span><span id="line-447"></span><span>  </span><span class="hs-comment">-- -- so the desired substitution is @downFrom m@.</span><span>
</span><span id="line-448"></span><span>  </span><span class="hs-comment">-- let sub m = applySubst $ parallelS $ map var $ downFrom m</span><span>
</span><span id="line-449"></span><span>
</span><span id="line-450"></span><span>  </span><span class="hs-comment">-- -- We simply reverse the context to get to de Bruijn levels.</span><span>
</span><span id="line-451"></span><span>  </span><span class="hs-comment">-- -- Of course, all types in the context are broken, but</span><span>
</span><span id="line-452"></span><span>  </span><span class="hs-comment">-- -- only need it for pretty printing constraints.</span><span>
</span><span id="line-453"></span><span>  </span><span class="hs-comment">-- gamma &lt;- return $ reverse gamma</span><span>
</span><span id="line-454"></span><span>
</span><span id="line-455"></span><span>  </span><span class="hs-comment">-- -- We convert the hypotheses to de Bruijn levels.</span><span>
</span><span id="line-456"></span><span>  </span><span class="hs-comment">-- hs &lt;- return $ sub n hs</span><span>
</span><span id="line-457"></span><span>
</span><span id="line-458"></span><span>  </span><span class="hs-comment">-- -- We get a form for pretty-printing</span><span>
</span><span id="line-459"></span><span>  </span><span class="hs-comment">-- let prettyC = prettyTCM . HypSizeConstraint gamma hids hs</span><span>
</span><span id="line-460"></span><span>
</span><span id="line-461"></span><span>  </span><span class="hs-comment">-- -- We convert the constraints to de Bruijn level format.</span><span>
</span><span id="line-462"></span><span>  </span><span class="hs-comment">-- let csC :: [SizeConstraint]</span><span>
</span><span id="line-463"></span><span>  </span><span class="hs-comment">--     csC = for cs $ \ (HypSizeConstraint cxt _ _ c) -&gt; sub (size cxt) c</span><span>
</span><span id="line-464"></span><span>
</span><span id="line-465"></span><span>  </span><span class="hs-comment">-- reportSDoc &quot;tc.size.solve&quot; 30 $ vcat $</span><span>
</span><span id="line-466"></span><span>  </span><span class="hs-comment">--   [ &quot;Size hypotheses&quot; ]           ++ map prettyC hs ++</span><span>
</span><span id="line-467"></span><span>  </span><span class="hs-comment">--   [ &quot;Canonicalized constraints&quot; ] ++ map prettyC csC</span><span>
</span><span id="line-468"></span><span>
</span><span id="line-469"></span><span>  </span><span class="hs-comment">-- Convert size metas to flexible vars.</span><span>
</span><span id="line-470"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="#local-6989586621681545243"><span class="hs-identifier hs-type">metas</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Agda.TypeChecking.SizedTypes.Solve.html#SizeMeta"><span class="hs-identifier hs-type">SizeMeta</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-471"></span><span>      </span><span id="local-6989586621681545243"><span class="annot"><span class="annottext">metas :: [SizeMeta]
</span><a href="#local-6989586621681545243"><span class="hs-identifier hs-var hs-var">metas</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(SizeConstraint -&gt; [SizeMeta]) -&gt; [SizeConstraint] -&gt; [SizeMeta]
forall (t :: * -&gt; *) a b. Foldable t =&gt; (a -&gt; [b]) -&gt; t a -&gt; [b]
</span><span class="hs-identifier hs-var">concatMap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(SizeMeta -&gt; [SizeMeta]) -&gt; SizeConstraint -&gt; [SizeMeta]
forall m a. Monoid m =&gt; (a -&gt; m) -&gt; Constraint' NamedRigid a -&gt; m
forall (t :: * -&gt; *) m a.
(Foldable t, Monoid m) =&gt;
(a -&gt; m) -&gt; t a -&gt; m
</span><span class="hs-identifier hs-var">foldMap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SizeMeta -&gt; [SizeMeta] -&gt; [SizeMeta]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[SizeConstraint]
</span><a href="#local-6989586621681545239"><span class="hs-identifier hs-var">csC</span></a></span><span>
</span><span id="line-472"></span><span>      </span><span class="annot"><a href="#local-6989586621681545246"><span class="hs-identifier hs-type">csF</span></a></span><span>   </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Agda.TypeChecking.SizedTypes.Syntax.html#Constraint%27"><span class="hs-identifier hs-type">Size.Constraint'</span></a></span><span> </span><span class="annot"><a href="Agda.TypeChecking.SizedTypes.Solve.html#NamedRigid"><span class="hs-identifier hs-type">NamedRigid</span></a></span><span> </span><span class="annot"><a href="Agda.Syntax.Common.html#MetaId"><span class="hs-identifier hs-type">MetaId</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-473"></span><span>      </span><span id="local-6989586621681545246"><span class="annot"><span class="annottext">csF :: [Constraint' NamedRigid MetaId]
</span><a href="#local-6989586621681545246"><span class="hs-identifier hs-var hs-var">csF</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(SizeConstraint -&gt; Constraint' NamedRigid MetaId)
-&gt; [SizeConstraint] -&gt; [Constraint' NamedRigid MetaId]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(SizeMeta -&gt; MetaId)
-&gt; SizeConstraint -&gt; Constraint' NamedRigid MetaId
forall a b.
(a -&gt; b) -&gt; Constraint' NamedRigid a -&gt; Constraint' NamedRigid b
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">SizeMeta -&gt; MetaId
</span><a href="Agda.TypeChecking.SizedTypes.Solve.html#sizeMetaId"><span class="hs-identifier hs-var">sizeMetaId</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[SizeConstraint]
</span><a href="#local-6989586621681545239"><span class="hs-identifier hs-var">csC</span></a></span><span>
</span><span id="line-474"></span><span>
</span><span id="line-475"></span><span>  </span><span class="hs-comment">-- Construct the hypotheses graph.</span><span>
</span><span id="line-476"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681545247"><span class="annot"><span class="annottext">hyps :: [Constraint' NamedRigid MetaId]
</span><a href="#local-6989586621681545247"><span class="hs-identifier hs-var hs-var">hyps</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(SizeConstraint -&gt; Constraint' NamedRigid MetaId)
-&gt; [SizeConstraint] -&gt; [Constraint' NamedRigid MetaId]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(SizeMeta -&gt; MetaId)
-&gt; SizeConstraint -&gt; Constraint' NamedRigid MetaId
forall a b.
(a -&gt; b) -&gt; Constraint' NamedRigid a -&gt; Constraint' NamedRigid b
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">SizeMeta -&gt; MetaId
</span><a href="Agda.TypeChecking.SizedTypes.Solve.html#sizeMetaId"><span class="hs-identifier hs-var">sizeMetaId</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[SizeConstraint]
</span><a href="#local-6989586621681545232"><span class="hs-identifier hs-var">hs</span></a></span><span>
</span><span id="line-477"></span><span>  </span><span class="hs-comment">-- There cannot be negative cycles in hypotheses graph due to scoping.</span><span>
</span><span id="line-478"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681545248"><span class="annot"><span class="annottext">hg :: HypGraph NamedRigid MetaId
</span><a href="#local-6989586621681545248"><span class="hs-identifier hs-var hs-var">hg</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(TCMT IO Doc -&gt; HypGraph NamedRigid MetaId)
-&gt; (HypGraph NamedRigid MetaId -&gt; HypGraph NamedRigid MetaId)
-&gt; Either (TCMT IO Doc) (HypGraph NamedRigid MetaId)
-&gt; HypGraph NamedRigid MetaId
forall a c b. (a -&gt; c) -&gt; (b -&gt; c) -&gt; Either a b -&gt; c
</span><span class="hs-identifier hs-var">either</span></span><span> </span><span class="annot"><span class="annottext">TCMT IO Doc -&gt; HypGraph NamedRigid MetaId
forall a. HasCallStack =&gt; a
</span><a href="Agda.Utils.Impossible.html#__IMPOSSIBLE__"><span class="hs-identifier hs-var">__IMPOSSIBLE__</span></a></span><span> </span><span class="annot"><span class="annottext">HypGraph NamedRigid MetaId -&gt; HypGraph NamedRigid MetaId
forall a. a -&gt; a
</span><span class="hs-identifier hs-var">id</span></span><span> </span><span class="annot"><span class="annottext">(Either (TCMT IO Doc) (HypGraph NamedRigid MetaId)
 -&gt; HypGraph NamedRigid MetaId)
-&gt; Either (TCMT IO Doc) (HypGraph NamedRigid MetaId)
-&gt; HypGraph NamedRigid MetaId
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Set NamedRigid
-&gt; [Constraint' NamedRigid MetaId]
-&gt; Either (TCMT IO Doc) (HypGraph NamedRigid MetaId)
forall rigid flex.
(Ord rigid, Ord flex, Pretty rigid, Pretty flex) =&gt;
Set rigid
-&gt; [Hyp' rigid flex] -&gt; Either (TCMT IO Doc) (HypGraph rigid flex)
</span><a href="Agda.TypeChecking.SizedTypes.WarshallSolver.html#hypGraph"><span class="hs-identifier hs-var">hypGraph</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Constraint' NamedRigid MetaId]
-&gt; Set (RigidOf [Constraint' NamedRigid MetaId])
forall a. Rigids a =&gt; a -&gt; Set (RigidOf a)
</span><a href="Agda.TypeChecking.SizedTypes.Syntax.html#rigids"><span class="hs-identifier hs-var">rigids</span></a></span><span> </span><span class="annot"><span class="annottext">[Constraint' NamedRigid MetaId]
</span><a href="#local-6989586621681545246"><span class="hs-identifier hs-var">csF</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Constraint' NamedRigid MetaId]
</span><a href="#local-6989586621681545247"><span class="hs-identifier hs-var">hyps</span></a></span><span>
</span><span id="line-479"></span><span>
</span><span id="line-480"></span><span>  </span><span class="hs-comment">-- -- Construct the constraint graph.</span><span>
</span><span id="line-481"></span><span>  </span><span class="hs-comment">-- --    g :: Size.Graph NamedRigid Int Label</span><span>
</span><span id="line-482"></span><span>  </span><span class="hs-comment">-- g &lt;- either err return $ constraintGraph csF hg</span><span>
</span><span id="line-483"></span><span>  </span><span class="hs-comment">-- reportSDoc &quot;tc.size.solve&quot; 40 $ vcat $</span><span>
</span><span id="line-484"></span><span>  </span><span class="hs-comment">--   [ &quot;Constraint graph&quot;</span><span>
</span><span id="line-485"></span><span>  </span><span class="hs-comment">--   , text (show g)</span><span>
</span><span id="line-486"></span><span>  </span><span class="hs-comment">--   ]</span><span>
</span><span id="line-487"></span><span>
</span><span id="line-488"></span><span>  </span><span class="hs-comment">-- sol :: Solution NamedRigid Int &lt;- either err return $ solveGraph Map.empty hg g</span><span>
</span><span id="line-489"></span><span>  </span><span class="hs-comment">-- either err return $ verifySolution hg csF sol</span><span>
</span><span id="line-490"></span><span>
</span><span id="line-491"></span><span>  </span><span class="hs-comment">-- Andreas, 2016-07-13, issue 2096.</span><span>
</span><span id="line-492"></span><span>  </span><span class="hs-comment">-- Running the solver once might result in unsolvable left-over constraints.</span><span>
</span><span id="line-493"></span><span>  </span><span class="hs-comment">-- We need to iterate the solver to detect this.</span><span>
</span><span id="line-494"></span><span>  </span><span id="local-6989586621681545253"><span class="annot"><span class="annottext">Solution NamedRigid MetaId
</span><a href="#local-6989586621681545253"><span class="hs-identifier hs-var">sol</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Agda.TypeChecking.SizedTypes.Syntax.html#Solution"><span class="hs-identifier hs-type">Solution</span></a></span><span> </span><span class="annot"><a href="Agda.TypeChecking.SizedTypes.Solve.html#NamedRigid"><span class="hs-identifier hs-type">NamedRigid</span></a></span><span> </span><span class="annot"><a href="Agda.Syntax.Common.html#MetaId"><span class="hs-identifier hs-type">MetaId</span></a></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(TCMT IO Doc -&gt; TCMT IO (Solution NamedRigid MetaId))
-&gt; (Solution NamedRigid MetaId
    -&gt; TCMT IO (Solution NamedRigid MetaId))
-&gt; Either (TCMT IO Doc) (Solution NamedRigid MetaId)
-&gt; TCMT IO (Solution NamedRigid MetaId)
forall a c b. (a -&gt; c) -&gt; (b -&gt; c) -&gt; Either a b -&gt; c
</span><span class="hs-identifier hs-var">either</span></span><span> </span><span class="annot"><span class="annottext">TCMT IO Doc -&gt; TCMT IO (Solution NamedRigid MetaId)
</span><a href="#local-6989586621681545228"><span class="hs-identifier hs-var">err</span></a></span><span> </span><span class="annot"><span class="annottext">Solution NamedRigid MetaId -&gt; TCMT IO (Solution NamedRigid MetaId)
forall a. a -&gt; TCMT IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Either (TCMT IO Doc) (Solution NamedRigid MetaId)
 -&gt; TCMT IO (Solution NamedRigid MetaId))
-&gt; Either (TCMT IO Doc) (Solution NamedRigid MetaId)
-&gt; TCMT IO (Solution NamedRigid MetaId)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-495"></span><span>    </span><span class="annot"><span class="annottext">Polarities MetaId
-&gt; HypGraph NamedRigid MetaId
-&gt; [Constraint' NamedRigid MetaId]
-&gt; Solution NamedRigid MetaId
-&gt; Either (TCMT IO Doc) (Solution NamedRigid MetaId)
forall r f.
(Ord r, Ord f, Pretty r, Pretty f, PrettyTCM f, Show r, Show f) =&gt;
Polarities f
-&gt; HypGraph r f
-&gt; [Constraint' r f]
-&gt; Solution r f
-&gt; Either (TCMT IO Doc) (Solution r f)
</span><a href="Agda.TypeChecking.SizedTypes.WarshallSolver.html#iterateSolver"><span class="hs-identifier hs-var">iterateSolver</span></a></span><span> </span><span class="annot"><span class="annottext">Polarities MetaId
forall k a. Map k a
</span><span class="hs-identifier hs-var">Map.empty</span></span><span> </span><span class="annot"><span class="annottext">HypGraph NamedRigid MetaId
</span><a href="#local-6989586621681545248"><span class="hs-identifier hs-var">hg</span></a></span><span> </span><span class="annot"><span class="annottext">[Constraint' NamedRigid MetaId]
</span><a href="#local-6989586621681545246"><span class="hs-identifier hs-var">csF</span></a></span><span> </span><span class="annot"><span class="annottext">Solution NamedRigid MetaId
forall r f. Solution r f
</span><a href="Agda.TypeChecking.SizedTypes.Syntax.html#emptySolution"><span class="hs-identifier hs-var">emptySolution</span></a></span><span>
</span><span id="line-496"></span><span>
</span><span id="line-497"></span><span>  </span><span class="hs-comment">-- Convert solution to meta instantiation.</span><span>
</span><span id="line-498"></span><span>  </span><span id="local-6989586621681545257"><span class="annot"><span class="annottext">Set MetaId
</span><a href="#local-6989586621681545257"><span class="hs-identifier hs-var">solved</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">([Set MetaId] -&gt; Set MetaId)
-&gt; TCMT IO [Set MetaId] -&gt; TCMT IO (Set MetaId)
forall a b. (a -&gt; b) -&gt; TCMT IO a -&gt; TCMT IO b
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">[Set MetaId] -&gt; Set MetaId
forall (f :: * -&gt; *) a. (Foldable f, Ord a) =&gt; f (Set a) -&gt; Set a
</span><span class="hs-identifier hs-var">Set.unions</span></span><span> </span><span class="annot"><span class="annottext">(TCMT IO [Set MetaId] -&gt; TCMT IO (Set MetaId))
-&gt; TCMT IO [Set MetaId] -&gt; TCMT IO (Set MetaId)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[(MetaId, SizeExpr' NamedRigid MetaId)]
-&gt; ((MetaId, SizeExpr' NamedRigid MetaId) -&gt; TCMT IO (Set MetaId))
-&gt; TCMT IO [Set MetaId]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m (t b)
</span><span class="hs-identifier hs-var">forM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Map MetaId (SizeExpr' NamedRigid MetaId)
-&gt; [(MetaId, SizeExpr' NamedRigid MetaId)]
forall k a. Map k a -&gt; [(k, a)]
</span><span class="hs-identifier hs-var">Map.assocs</span></span><span> </span><span class="annot"><span class="annottext">(Map MetaId (SizeExpr' NamedRigid MetaId)
 -&gt; [(MetaId, SizeExpr' NamedRigid MetaId)])
-&gt; Map MetaId (SizeExpr' NamedRigid MetaId)
-&gt; [(MetaId, SizeExpr' NamedRigid MetaId)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Solution NamedRigid MetaId
-&gt; Map MetaId (SizeExpr' NamedRigid MetaId)
forall rigid flex.
Solution rigid flex -&gt; Map flex (SizeExpr' rigid flex)
</span><a href="Agda.TypeChecking.SizedTypes.Syntax.html#theSolution"><span class="hs-identifier hs-var">theSolution</span></a></span><span> </span><span class="annot"><span class="annottext">Solution NamedRigid MetaId
</span><a href="#local-6989586621681545253"><span class="hs-identifier hs-var">sol</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((MetaId, SizeExpr' NamedRigid MetaId) -&gt; TCMT IO (Set MetaId))
 -&gt; TCMT IO [Set MetaId])
-&gt; ((MetaId, SizeExpr' NamedRigid MetaId) -&gt; TCMT IO (Set MetaId))
-&gt; TCMT IO [Set MetaId]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681545260"><span class="annot"><span class="annottext">MetaId
</span><a href="#local-6989586621681545260"><span class="hs-identifier hs-var">m</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681545261"><span class="annot"><span class="annottext">SizeExpr' NamedRigid MetaId
</span><a href="#local-6989586621681545261"><span class="hs-identifier hs-var">a</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-499"></span><span>    </span><span class="annot"><span class="annottext">Bool -&gt; TCM () -&gt; TCM ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">unless</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SizeExpr' NamedRigid MetaId -&gt; Bool
forall a. ValidOffset a =&gt; a -&gt; Bool
</span><a href="Agda.TypeChecking.SizedTypes.Syntax.html#validOffset"><span class="hs-identifier hs-var">validOffset</span></a></span><span> </span><span class="annot"><span class="annottext">SizeExpr' NamedRigid MetaId
</span><a href="#local-6989586621681545261"><span class="hs-identifier hs-var">a</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TCM ()
forall a. HasCallStack =&gt; a
</span><a href="Agda.Utils.Impossible.html#__IMPOSSIBLE__"><span class="hs-identifier hs-var">__IMPOSSIBLE__</span></a></span><span>
</span><span id="line-500"></span><span>    </span><span class="hs-comment">-- Solution does not contain metas</span><span>
</span><span id="line-501"></span><span>    </span><span id="local-6989586621681545263"><span class="annot"><span class="annottext">Term
</span><a href="#local-6989586621681545263"><span class="hs-identifier hs-var">u</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">DBSizeExpr -&gt; TCMT IO Term
forall (m :: * -&gt; *). HasBuiltins m =&gt; DBSizeExpr -&gt; m Term
</span><a href="Agda.TypeChecking.SizedTypes.Solve.html#unSizeExpr"><span class="hs-identifier hs-var">unSizeExpr</span></a></span><span> </span><span class="annot"><span class="annottext">(DBSizeExpr -&gt; TCMT IO Term) -&gt; DBSizeExpr -&gt; TCMT IO Term
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(MetaId -&gt; SizeMeta) -&gt; SizeExpr' NamedRigid MetaId -&gt; DBSizeExpr
forall a b.
(a -&gt; b) -&gt; SizeExpr' NamedRigid a -&gt; SizeExpr' NamedRigid b
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">MetaId -&gt; SizeMeta
forall a. HasCallStack =&gt; a
</span><a href="Agda.Utils.Impossible.html#__IMPOSSIBLE__"><span class="hs-identifier hs-var">__IMPOSSIBLE__</span></a></span><span> </span><span class="annot"><span class="annottext">SizeExpr' NamedRigid MetaId
</span><a href="#local-6989586621681545261"><span class="hs-identifier hs-var">a</span></a></span><span>
</span><span id="line-502"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="Agda.TypeChecking.SizedTypes.Solve.html#SizeMeta"><span class="hs-identifier hs-type">SizeMeta</span></a></span><span> </span><span class="annot"><span class="annottext">MetaId
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621681545266"><span class="annot"><span class="annottext">[Int]
</span><a href="#local-6989586621681545266"><span class="hs-identifier hs-var">xs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SizeMeta -&gt; Maybe SizeMeta -&gt; SizeMeta
forall a. a -&gt; Maybe a -&gt; a
</span><span class="hs-identifier hs-var">fromMaybe</span></span><span> </span><span class="annot"><span class="annottext">SizeMeta
forall a. HasCallStack =&gt; a
</span><a href="Agda.Utils.Impossible.html#__IMPOSSIBLE__"><span class="hs-identifier hs-var">__IMPOSSIBLE__</span></a></span><span> </span><span class="annot"><span class="annottext">(Maybe SizeMeta -&gt; SizeMeta) -&gt; Maybe SizeMeta -&gt; SizeMeta
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-503"></span><span>          </span><span class="annot"><span class="annottext">(SizeMeta -&gt; Bool) -&gt; [SizeMeta] -&gt; Maybe SizeMeta
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Maybe a
</span><span class="hs-identifier hs-var">List.find</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">MetaId
</span><a href="#local-6989586621681545260"><span class="hs-identifier hs-var">m</span></a></span><span> </span><span class="annot"><span class="annottext">MetaId -&gt; MetaId -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(MetaId -&gt; Bool) -&gt; (SizeMeta -&gt; MetaId) -&gt; SizeMeta -&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">SizeMeta -&gt; MetaId
</span><a href="Agda.TypeChecking.SizedTypes.Solve.html#sizeMetaId"><span class="hs-identifier hs-var">sizeMetaId</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[SizeMeta]
</span><a href="#local-6989586621681545243"><span class="hs-identifier hs-var">metas</span></a></span><span>
</span><span id="line-504"></span><span>    </span><span class="hs-comment">-- Check that solution is well-scoped</span><span>
</span><span id="line-505"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681545268"><span class="annot"><span class="annottext">ys :: [Int]
</span><a href="#local-6989586621681545268"><span class="hs-identifier hs-var hs-var">ys</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">NamedRigid -&gt; Int
</span><a href="Agda.TypeChecking.SizedTypes.Solve.html#rigidIndex"><span class="hs-identifier hs-var">rigidIndex</span></a></span><span> </span><span class="annot"><span class="annottext">(NamedRigid -&gt; Int) -&gt; [NamedRigid] -&gt; [Int]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Set NamedRigid -&gt; [NamedRigid]
forall a. Set a -&gt; [a]
</span><span class="hs-identifier hs-var">Set.toList</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SizeExpr' NamedRigid MetaId
-&gt; Set (RigidOf (SizeExpr' NamedRigid MetaId))
forall a. Rigids a =&gt; a -&gt; Set (RigidOf a)
</span><a href="Agda.TypeChecking.SizedTypes.Syntax.html#rigids"><span class="hs-identifier hs-var">rigids</span></a></span><span> </span><span class="annot"><span class="annottext">SizeExpr' NamedRigid MetaId
</span><a href="#local-6989586621681545261"><span class="hs-identifier hs-var">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-506"></span><span>        </span><span id="local-6989586621681545270"><span class="annot"><span class="annottext">ok :: Bool
</span><a href="#local-6989586621681545270"><span class="hs-identifier hs-var hs-var">ok</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Int -&gt; Bool) -&gt; [Int] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">all</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; [Int] -&gt; Bool
forall a. Eq a =&gt; a -&gt; [a] -&gt; Bool
forall (t :: * -&gt; *) a. (Foldable t, Eq a) =&gt; a -&gt; t a -&gt; Bool
</span><span class="hs-operator hs-var">`elem`</span></span><span> </span><span class="annot"><span class="annottext">[Int]
</span><a href="#local-6989586621681545266"><span class="hs-identifier hs-var">xs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Int]
</span><a href="#local-6989586621681545268"><span class="hs-identifier hs-var">ys</span></a></span><span> </span><span class="hs-comment">-- TODO: more efficient</span><span>
</span><span id="line-507"></span><span>    </span><span class="hs-comment">-- unless ok $ err &quot;ill-scoped solution for size meta variable&quot;</span><span>
</span><span id="line-508"></span><span>    </span><span id="local-6989586621681545273"><span class="annot"><span class="annottext">Term
</span><a href="#local-6989586621681545273"><span class="hs-identifier hs-var">u</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681545270"><span class="hs-identifier hs-var">ok</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">Term -&gt; TCMT IO Term
forall a. a -&gt; TCMT IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Term
</span><a href="#local-6989586621681545263"><span class="hs-identifier hs-var">u</span></a></span><span> </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">TCMT IO Term
forall (m :: * -&gt; *).
(HasBuiltins m, MonadError TCErr m, MonadTCEnv m, ReadTCState m) =&gt;
m Term
</span><a href="Agda.TypeChecking.Monad.Builtin.html#primSizeInf"><span class="hs-identifier hs-var">primSizeInf</span></a></span><span>
</span><span id="line-509"></span><span>    </span><span id="local-6989586621681545274"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681545274"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">MetaId -&gt; TCMT IO Type
forall (m :: * -&gt; *). ReadTCState m =&gt; MetaId -&gt; m Type
</span><a href="Agda.TypeChecking.Monad.MetaVars.html#getMetaType"><span class="hs-identifier hs-var">getMetaType</span></a></span><span> </span><span class="annot"><span class="annottext">MetaId
</span><a href="#local-6989586621681545260"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-510"></span><span>    </span><span class="annot"><span class="annottext">String -&gt; Int -&gt; TCMT IO Doc -&gt; TCM ()
forall (m :: * -&gt; *).
MonadDebug m =&gt;
String -&gt; Int -&gt; TCMT IO Doc -&gt; m ()
</span><a href="Agda.TypeChecking.Monad.Debug.html#reportSDoc"><span class="hs-identifier hs-var">reportSDoc</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;tc.size.solve&quot;</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">20</span></span><span> </span><span class="annot"><span class="annottext">(TCMT IO Doc -&gt; TCM ()) -&gt; TCMT IO Doc -&gt; TCM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(Context -&gt; Context) -&gt; TCMT IO Doc -&gt; TCMT IO Doc
forall (tcm :: * -&gt; *) a.
MonadTCEnv tcm =&gt;
(Context -&gt; Context) -&gt; tcm a -&gt; tcm a
</span><a href="Agda.TypeChecking.Monad.Context.html#unsafeModifyContext"><span class="hs-identifier hs-var">unsafeModifyContext</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Context -&gt; Context -&gt; Context
forall a b. a -&gt; b -&gt; a
</span><span class="hs-identifier hs-var">const</span></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621681545230"><span class="hs-identifier hs-var">gamma</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(TCMT IO Doc -&gt; TCMT IO Doc) -&gt; TCMT IO Doc -&gt; TCMT IO Doc
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-511"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681545277"><span class="annot"><span class="annottext">args :: Elims
</span><a href="#local-6989586621681545277"><span class="hs-identifier hs-var hs-var">args</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Int -&gt; Elim' Term) -&gt; [Int] -&gt; Elims
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Arg Term -&gt; Elim' Term
forall a. Arg a -&gt; Elim' a
</span><a href="Agda.Syntax.Internal.Elim.html#Apply"><span class="hs-identifier hs-var">Apply</span></a></span><span> </span><span class="annot"><span class="annottext">(Arg Term -&gt; Elim' Term) -&gt; (Int -&gt; Arg Term) -&gt; Int -&gt; Elim' Term
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Term -&gt; Arg Term
forall a. a -&gt; Arg a
</span><a href="Agda.Syntax.Common.html#defaultArg"><span class="hs-identifier hs-var">defaultArg</span></a></span><span> </span><span class="annot"><span class="annottext">(Term -&gt; Arg Term) -&gt; (Int -&gt; Term) -&gt; Int -&gt; Arg Term
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Term
</span><a href="Agda.Syntax.Internal.html#var"><span class="hs-identifier hs-var">var</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Int]
</span><a href="#local-6989586621681545266"><span class="hs-identifier hs-var">xs</span></a></span><span>
</span><span id="line-512"></span><span>      </span><span class="annot"><span class="annottext">TCMT IO Doc
</span><span class="hs-string">&quot;solution &quot;</span></span><span> </span><span class="annot"><span class="annottext">TCMT IO Doc -&gt; TCMT IO Doc -&gt; TCMT IO Doc
forall (m :: * -&gt; *). Applicative m =&gt; m Doc -&gt; m Doc -&gt; m Doc
</span><a href="Agda.TypeChecking.Pretty.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Term -&gt; TCMT IO Doc
forall a (m :: * -&gt; *). (PrettyTCM a, MonadPretty m) =&gt; a -&gt; m Doc
forall (m :: * -&gt; *). MonadPretty m =&gt; Term -&gt; m Doc
</span><a href="Agda.TypeChecking.Pretty.html#prettyTCM"><span class="hs-identifier hs-var">prettyTCM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MetaId -&gt; Elims -&gt; Term
</span><a href="Agda.Syntax.Internal.html#MetaV"><span class="hs-identifier hs-var">MetaV</span></a></span><span> </span><span class="annot"><span class="annottext">MetaId
</span><a href="#local-6989586621681545260"><span class="hs-identifier hs-var">m</span></a></span><span> </span><span class="annot"><span class="annottext">Elims
</span><a href="#local-6989586621681545277"><span class="hs-identifier hs-var">args</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TCMT IO Doc -&gt; TCMT IO Doc -&gt; TCMT IO Doc
forall (m :: * -&gt; *). Applicative m =&gt; m Doc -&gt; m Doc -&gt; m Doc
</span><a href="Agda.TypeChecking.Pretty.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">TCMT IO Doc
</span><span class="hs-string">&quot; := &quot;</span></span><span> </span><span class="annot"><span class="annottext">TCMT IO Doc -&gt; TCMT IO Doc -&gt; TCMT IO Doc
forall (m :: * -&gt; *). Applicative m =&gt; m Doc -&gt; m Doc -&gt; m Doc
</span><a href="Agda.TypeChecking.Pretty.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Term -&gt; TCMT IO Doc
forall a (m :: * -&gt; *). (PrettyTCM a, MonadPretty m) =&gt; a -&gt; m Doc
forall (m :: * -&gt; *). MonadPretty m =&gt; Term -&gt; m Doc
</span><a href="Agda.TypeChecking.Pretty.html#prettyTCM"><span class="hs-identifier hs-var">prettyTCM</span></a></span><span> </span><span class="annot"><span class="annottext">Term
</span><a href="#local-6989586621681545273"><span class="hs-identifier hs-var">u</span></a></span><span>
</span><span id="line-513"></span><span>    </span><span class="annot"><span class="annottext">String -&gt; Int -&gt; TCMT IO Doc -&gt; TCM ()
forall (m :: * -&gt; *).
MonadDebug m =&gt;
String -&gt; Int -&gt; TCMT IO Doc -&gt; m ()
</span><a href="Agda.TypeChecking.Monad.Debug.html#reportSDoc"><span class="hs-identifier hs-var">reportSDoc</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;tc.size.solve&quot;</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">60</span></span><span> </span><span class="annot"><span class="annottext">(TCMT IO Doc -&gt; TCM ()) -&gt; TCMT IO Doc -&gt; TCM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[TCMT IO Doc] -&gt; TCMT IO Doc
forall (m :: * -&gt; *) (t :: * -&gt; *).
(Applicative m, Foldable t) =&gt;
t (m Doc) -&gt; m Doc
</span><a href="Agda.TypeChecking.Pretty.html#vcat"><span class="hs-identifier hs-var">vcat</span></a></span><span>
</span><span id="line-514"></span><span>      </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">String -&gt; TCMT IO Doc
forall (m :: * -&gt; *). Applicative m =&gt; String -&gt; m Doc
</span><a href="Agda.TypeChecking.Pretty.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">(String -&gt; TCMT IO Doc) -&gt; String -&gt; TCMT IO Doc
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;  xs = &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[Int] -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">[Int]
</span><a href="#local-6989586621681545266"><span class="hs-identifier hs-var">xs</span></a></span><span>
</span><span id="line-515"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String -&gt; TCMT IO Doc
forall (m :: * -&gt; *). Applicative m =&gt; String -&gt; m Doc
</span><a href="Agda.TypeChecking.Pretty.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">(String -&gt; TCMT IO Doc) -&gt; String -&gt; TCMT IO Doc
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;  u  = &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">Term -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Term
</span><a href="#local-6989586621681545273"><span class="hs-identifier hs-var">u</span></a></span><span>
</span><span id="line-516"></span><span>      </span><span class="hs-special">]</span><span>
</span><span id="line-517"></span><span>    </span><span class="annot"><span class="annottext">TCMT IO Bool
-&gt; TCMT IO (Set MetaId)
-&gt; TCMT IO (Set MetaId)
-&gt; TCMT IO (Set MetaId)
forall (m :: * -&gt; *) a. Monad m =&gt; m Bool -&gt; m a -&gt; m a -&gt; m a
</span><a href="Agda.Utils.Monad.html#ifM"><span class="hs-identifier hs-var">ifM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MetaId -&gt; TCMT IO Bool
forall (m :: * -&gt; *).
(HasCallStack, MonadDebug m, ReadTCState m) =&gt;
MetaId -&gt; m Bool
</span><a href="Agda.TypeChecking.Monad.MetaVars.html#isFrozen"><span class="hs-identifier hs-var">isFrozen</span></a></span><span> </span><span class="annot"><span class="annottext">MetaId
</span><a href="#local-6989586621681545260"><span class="hs-identifier hs-var">m</span></a></span><span> </span><span class="annot"><span class="annottext">TCMT IO Bool -&gt; TCMT IO Bool -&gt; TCMT IO Bool
forall (m :: * -&gt; *). Monad m =&gt; m Bool -&gt; m Bool -&gt; m Bool
</span><a href="Agda.Utils.Monad.html#or2M"><span class="hs-operator hs-var">`or2M`</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; Bool) -&gt; TCMT IO Bool -&gt; TCMT IO Bool
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">(TCEnv -&gt; Bool) -&gt; TCMT IO Bool
forall (m :: * -&gt; *) a. MonadTCEnv m =&gt; (TCEnv -&gt; a) -&gt; m a
</span><a href="Agda.TypeChecking.Monad.Base.html#asksTC"><span class="hs-identifier hs-var">asksTC</span></a></span><span> </span><span class="annot"><span class="annottext">TCEnv -&gt; Bool
</span><a href="Agda.TypeChecking.Monad.Base.html#envAssignMetas"><span class="hs-identifier hs-var">envAssignMetas</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Set MetaId -&gt; TCMT IO (Set MetaId)
forall a. a -&gt; TCMT IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Set MetaId
forall a. Set a
</span><span class="hs-identifier hs-var">Set.empty</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(TCMT IO (Set MetaId) -&gt; TCMT IO (Set MetaId))
-&gt; TCMT IO (Set MetaId) -&gt; TCMT IO (Set MetaId)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-518"></span><span>      </span><span class="annot"><span class="annottext">Int -&gt; MetaId -&gt; Type -&gt; [Int] -&gt; Term -&gt; TCM ()
</span><a href="Agda.TypeChecking.MetaVars.html#assignMeta"><span class="hs-identifier hs-var">assignMeta</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681545234"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">MetaId
</span><a href="#local-6989586621681545260"><span class="hs-identifier hs-var">m</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681545274"><span class="hs-identifier hs-var">t</span></a></span><span> </span><span class="annot"><span class="annottext">[Int]
</span><a href="#local-6989586621681545266"><span class="hs-identifier hs-var">xs</span></a></span><span> </span><span class="annot"><span class="annottext">Term
</span><a href="#local-6989586621681545273"><span class="hs-identifier hs-var">u</span></a></span><span>
</span><span id="line-519"></span><span>      </span><span class="annot"><span class="annottext">Set MetaId -&gt; TCMT IO (Set MetaId)
forall a. a -&gt; TCMT IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Set MetaId -&gt; TCMT IO (Set MetaId))
-&gt; Set MetaId -&gt; TCMT IO (Set MetaId)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">MetaId -&gt; Set MetaId
forall a. a -&gt; Set a
</span><span class="hs-identifier hs-var">Set.singleton</span></span><span> </span><span class="annot"><span class="annottext">MetaId
</span><a href="#local-6989586621681545260"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-520"></span><span>    </span><span class="hs-comment">-- WRONG:</span><span>
</span><span id="line-521"></span><span>    </span><span class="hs-comment">-- let partialSubst = List.sort $ zip xs $ map var $ downFrom n</span><span>
</span><span id="line-522"></span><span>    </span><span class="hs-comment">-- assignMeta' n m t (length xs) partialSubst u</span><span>
</span><span id="line-523"></span><span>    </span><span class="hs-comment">-- WRONG: assign DirEq m (map (defaultArg . var) xs) u</span><span>
</span><span id="line-524"></span><span>
</span><span id="line-525"></span><span>  </span><span class="hs-comment">-- Possibly set remaining size metas to &#8734; (issue 1862)</span><span>
</span><span id="line-526"></span><span>  </span><span class="hs-comment">-- unless we have an interaction meta in the cluster (issue 2095).</span><span>
</span><span id="line-527"></span><span>
</span><span id="line-528"></span><span>  </span><span id="local-6989586621681545286"><span class="annot"><span class="annottext">Set MetaId
</span><a href="#local-6989586621681545286"><span class="hs-identifier hs-var">ims</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[MetaId] -&gt; Set MetaId
forall a. Ord a =&gt; [a] -&gt; Set a
</span><span class="hs-identifier hs-var">Set.fromList</span></span><span> </span><span class="annot"><span class="annottext">([MetaId] -&gt; Set MetaId)
-&gt; TCMT IO [MetaId] -&gt; TCMT IO (Set MetaId)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">TCMT IO [MetaId]
forall (m :: * -&gt; *). ReadTCState m =&gt; m [MetaId]
</span><a href="Agda.TypeChecking.Monad.MetaVars.html#getInteractionMetas"><span class="hs-identifier hs-var">getInteractionMetas</span></a></span><span>
</span><span id="line-529"></span><span>
</span><span id="line-530"></span><span>  </span><span class="hs-comment">--  ms = unsolved size metas from cluster</span><span>
</span><span id="line-531"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681545288"><span class="annot"><span class="annottext">ms :: Set MetaId
</span><a href="#local-6989586621681545288"><span class="hs-identifier hs-var hs-var">ms</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[MetaId] -&gt; Set MetaId
forall a. Ord a =&gt; [a] -&gt; Set a
</span><span class="hs-identifier hs-var">Set.fromList</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(SizeMeta -&gt; MetaId) -&gt; [SizeMeta] -&gt; [MetaId]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">SizeMeta -&gt; MetaId
</span><a href="Agda.TypeChecking.SizedTypes.Solve.html#sizeMetaId"><span class="hs-identifier hs-var">sizeMetaId</span></a></span><span> </span><span class="annot"><span class="annottext">[SizeMeta]
</span><a href="#local-6989586621681545243"><span class="hs-identifier hs-var">metas</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Set MetaId -&gt; Set MetaId -&gt; Set MetaId
forall a. Ord a =&gt; Set a -&gt; Set a -&gt; Set a
</span><span class="hs-operator hs-var">Set.\\</span></span><span> </span><span class="annot"><span class="annottext">Set MetaId
</span><a href="#local-6989586621681545257"><span class="hs-identifier hs-var">solved</span></a></span><span>
</span><span id="line-532"></span><span>  </span><span class="hs-comment">--  Make sure they do not contain an interaction point</span><span>
</span><span id="line-533"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681545290"><span class="annot"><span class="annottext">noIP :: Bool
</span><a href="#local-6989586621681545290"><span class="hs-identifier hs-var hs-var">noIP</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Set MetaId -&gt; Set MetaId -&gt; Bool
forall a. Ord a =&gt; Set a -&gt; Set a -&gt; Bool
</span><span class="hs-identifier hs-var">Set.disjoint</span></span><span> </span><span class="annot"><span class="annottext">Set MetaId
</span><a href="#local-6989586621681545286"><span class="hs-identifier hs-var">ims</span></a></span><span> </span><span class="annot"><span class="annottext">Set MetaId
</span><a href="#local-6989586621681545288"><span class="hs-identifier hs-var">ms</span></a></span><span>
</span><span id="line-534"></span><span>
</span><span id="line-535"></span><span>  </span><span class="annot"><span class="annottext">Bool -&gt; TCM () -&gt; TCM ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">unless</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Set MetaId -&gt; Bool
forall a. Null a =&gt; a -&gt; Bool
</span><a href="Agda.Utils.Null.html#null"><span class="hs-identifier hs-var">null</span></a></span><span> </span><span class="annot"><span class="annottext">Set MetaId
</span><a href="#local-6989586621681545288"><span class="hs-identifier hs-var">ms</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(TCM () -&gt; TCM ()) -&gt; TCM () -&gt; TCM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; Int -&gt; TCMT IO Doc -&gt; TCM ()
forall (m :: * -&gt; *).
MonadDebug m =&gt;
String -&gt; Int -&gt; TCMT IO Doc -&gt; m ()
</span><a href="Agda.TypeChecking.Monad.Debug.html#reportSDoc"><span class="hs-identifier hs-var">reportSDoc</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;tc.size.solve&quot;</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">30</span></span><span> </span><span class="annot"><span class="annottext">(TCMT IO Doc -&gt; TCM ()) -&gt; TCMT IO Doc -&gt; TCM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[TCMT IO Doc] -&gt; TCMT IO Doc
forall (m :: * -&gt; *) (t :: * -&gt; *).
(Applicative m, Foldable t) =&gt;
t (m Doc) -&gt; m Doc
</span><a href="Agda.TypeChecking.Pretty.html#fsep"><span class="hs-identifier hs-var">fsep</span></a></span><span> </span><span class="annot"><span class="annottext">([TCMT IO Doc] -&gt; TCMT IO Doc) -&gt; [TCMT IO Doc] -&gt; TCMT IO Doc
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-536"></span><span>    </span><span class="annot"><span class="annottext">TCMT IO Doc
</span><span class="hs-string">&quot;cluster did not solve these size metas: &quot;</span></span><span> </span><span class="annot"><span class="annottext">TCMT IO Doc -&gt; [TCMT IO Doc] -&gt; [TCMT IO Doc]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">(MetaId -&gt; TCMT IO Doc) -&gt; [MetaId] -&gt; [TCMT IO Doc]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">MetaId -&gt; TCMT IO Doc
forall a (m :: * -&gt; *). (PrettyTCM a, MonadPretty m) =&gt; a -&gt; m Doc
forall (m :: * -&gt; *). MonadPretty m =&gt; MetaId -&gt; m Doc
</span><a href="Agda.TypeChecking.Pretty.html#prettyTCM"><span class="hs-identifier hs-var">prettyTCM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Set MetaId -&gt; [MetaId]
forall a. Set a -&gt; [a]
</span><span class="hs-identifier hs-var">Set.toList</span></span><span> </span><span class="annot"><span class="annottext">Set MetaId
</span><a href="#local-6989586621681545288"><span class="hs-identifier hs-var">ms</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-537"></span><span>
</span><span id="line-538"></span><span>  </span><span id="local-6989586621681545293"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681545293"><span class="hs-identifier hs-var">solvedAll</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-539"></span><span>    </span><span class="hs-comment">-- If no metas are left, we have solved this cluster completely.</span><span>
</span><span id="line-540"></span><span>    </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Set MetaId -&gt; Bool
forall a. Set a -&gt; Bool
</span><span class="hs-identifier hs-var">Set.null</span></span><span> </span><span class="annot"><span class="annottext">Set MetaId
</span><a href="#local-6989586621681545288"><span class="hs-identifier hs-var">ms</span></a></span><span>                </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; TCMT IO Bool
forall a. a -&gt; TCMT IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>  </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-541"></span><span>    </span><span class="hs-comment">-- Otherwise, we can solve it completely if we are allowed to set to &#8734;.</span><span>
</span><span id="line-542"></span><span>    </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">DefaultToInfty
</span><a href="#local-6989586621681545224"><span class="hs-identifier hs-var">flag</span></a></span><span> </span><span class="annot"><span class="annottext">DefaultToInfty -&gt; DefaultToInfty -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">DefaultToInfty
</span><a href="Agda.TypeChecking.SizedTypes.Solve.html#DontDefaultToInfty"><span class="hs-identifier hs-var">DontDefaultToInfty</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; TCMT IO Bool
forall a. a -&gt; TCMT IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span> </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-543"></span><span>    </span><span class="hs-comment">-- Which is only the case when we have no interaction points in the cluster.</span><span>
</span><span id="line-544"></span><span>    </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681545290"><span class="hs-identifier hs-var">noIP</span></a></span><span>                   </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; TCMT IO Bool
forall a. a -&gt; TCMT IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span> </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-545"></span><span>    </span><span class="hs-comment">-- Try to set all unconstrained size metas to &#8734;.</span><span>
</span><span id="line-546"></span><span>    </span><span id="local-6989586621681545295"><span class="annot"><span class="annottext">Term
</span><a href="#local-6989586621681545295"><span class="hs-identifier hs-var">inf</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TCMT IO Term
forall (m :: * -&gt; *).
(HasBuiltins m, MonadError TCErr m, MonadTCEnv m, ReadTCState m) =&gt;
m Term
</span><a href="Agda.TypeChecking.Monad.Builtin.html#primSizeInf"><span class="hs-identifier hs-var">primSizeInf</span></a></span><span>
</span><span id="line-547"></span><span>    </span><span class="annot"><span class="annottext">[Bool] -&gt; Bool
forall (t :: * -&gt; *). Foldable t =&gt; t Bool -&gt; Bool
</span><span class="hs-identifier hs-var">and</span></span><span> </span><span class="annot"><span class="annottext">([Bool] -&gt; Bool) -&gt; TCMT IO [Bool] -&gt; TCMT IO Bool
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-548"></span><span>      </span><span class="annot"><span class="annottext">[MetaId] -&gt; (MetaId -&gt; TCMT IO Bool) -&gt; TCMT IO [Bool]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m (t b)
</span><span class="hs-identifier hs-var">forM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Set MetaId -&gt; [MetaId]
forall a. Set a -&gt; [a]
</span><span class="hs-identifier hs-var">Set.toList</span></span><span> </span><span class="annot"><span class="annottext">Set MetaId
</span><a href="#local-6989586621681545288"><span class="hs-identifier hs-var">ms</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((MetaId -&gt; TCMT IO Bool) -&gt; TCMT IO [Bool])
-&gt; (MetaId -&gt; TCMT IO Bool) -&gt; TCMT IO [Bool]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span> </span><span id="local-6989586621681545297"><span class="annot"><span class="annottext">MetaId
</span><a href="#local-6989586621681545297"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-549"></span><span>        </span><span class="hs-comment">-- If one variable is frozen, we cannot set it (and hence not all) to &#8734;</span><span>
</span><span id="line-550"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681545298"><span class="annot"><span class="annottext">no :: TCMT IO Bool
</span><a href="#local-6989586621681545298"><span class="hs-identifier hs-var hs-var">no</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-551"></span><span>              </span><span class="annot"><span class="annottext">String -&gt; Int -&gt; TCMT IO Doc -&gt; TCM ()
forall (m :: * -&gt; *).
MonadDebug m =&gt;
String -&gt; Int -&gt; TCMT IO Doc -&gt; m ()
</span><a href="Agda.TypeChecking.Monad.Debug.html#reportSDoc"><span class="hs-identifier hs-var">reportSDoc</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;tc.size.solve&quot;</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">30</span></span><span> </span><span class="annot"><span class="annottext">(TCMT IO Doc -&gt; TCM ()) -&gt; TCMT IO Doc -&gt; TCM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-552"></span><span>                </span><span class="annot"><span class="annottext">Term -&gt; TCMT IO Doc
forall a (m :: * -&gt; *). (PrettyTCM a, MonadPretty m) =&gt; a -&gt; m Doc
forall (m :: * -&gt; *). MonadPretty m =&gt; Term -&gt; m Doc
</span><a href="Agda.TypeChecking.Pretty.html#prettyTCM"><span class="hs-identifier hs-var">prettyTCM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MetaId -&gt; Elims -&gt; Term
</span><a href="Agda.Syntax.Internal.html#MetaV"><span class="hs-identifier hs-var">MetaV</span></a></span><span> </span><span class="annot"><span class="annottext">MetaId
</span><a href="#local-6989586621681545297"><span class="hs-identifier hs-var">m</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TCMT IO Doc -&gt; TCMT IO Doc -&gt; TCMT IO Doc
forall (m :: * -&gt; *). Applicative m =&gt; m Doc -&gt; m Doc -&gt; m Doc
</span><a href="Agda.TypeChecking.Pretty.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">TCMT IO Doc
</span><span class="hs-string">&quot;is frozen, cannot set it to &#8734;&quot;</span></span><span>
</span><span id="line-553"></span><span>              </span><span class="annot"><span class="annottext">Bool -&gt; TCMT IO Bool
forall a. a -&gt; TCMT IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-554"></span><span>        </span><span class="annot"><span class="annottext">TCMT IO Bool -&gt; TCMT IO Bool -&gt; TCMT IO Bool -&gt; TCMT IO Bool
forall (m :: * -&gt; *) a. Monad m =&gt; m Bool -&gt; m a -&gt; m a -&gt; m a
</span><a href="Agda.Utils.Monad.html#ifM"><span class="hs-identifier hs-var">ifM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MetaId -&gt; TCMT IO Bool
forall (m :: * -&gt; *).
(HasCallStack, MonadDebug m, ReadTCState m) =&gt;
MetaId -&gt; m Bool
</span><a href="Agda.TypeChecking.Monad.MetaVars.html#isFrozen"><span class="hs-identifier hs-var">isFrozen</span></a></span><span> </span><span class="annot"><span class="annottext">MetaId
</span><a href="#local-6989586621681545297"><span class="hs-identifier hs-var">m</span></a></span><span> </span><span class="annot"><span class="annottext">TCMT IO Bool -&gt; TCMT IO Bool -&gt; TCMT IO Bool
forall (m :: * -&gt; *). Monad m =&gt; m Bool -&gt; m Bool -&gt; m Bool
</span><a href="Agda.Utils.Monad.html#or2M"><span class="hs-operator hs-var">`or2M`</span></a></span><span> </span><span class="hs-keyword">do</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; Bool) -&gt; TCMT IO Bool -&gt; TCMT IO Bool
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">(TCEnv -&gt; Bool) -&gt; TCMT IO Bool
forall (m :: * -&gt; *) a. MonadTCEnv m =&gt; (TCEnv -&gt; a) -&gt; m a
</span><a href="Agda.TypeChecking.Monad.Base.html#asksTC"><span class="hs-identifier hs-var">asksTC</span></a></span><span> </span><span class="annot"><span class="annottext">TCEnv -&gt; Bool
</span><a href="Agda.TypeChecking.Monad.Base.html#envAssignMetas"><span class="hs-identifier hs-var">envAssignMetas</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TCMT IO Bool
</span><a href="#local-6989586621681545298"><span class="hs-identifier hs-var">no</span></a></span><span> </span><span class="annot"><span class="annottext">(TCMT IO Bool -&gt; TCMT IO Bool) -&gt; TCMT IO Bool -&gt; TCMT IO Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-comment">{-else-}</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-555"></span><span>          </span><span class="annot"><span class="annottext">String -&gt; Int -&gt; TCMT IO Doc -&gt; TCM ()
forall (m :: * -&gt; *).
MonadDebug m =&gt;
String -&gt; Int -&gt; TCMT IO Doc -&gt; m ()
</span><a href="Agda.TypeChecking.Monad.Debug.html#reportSDoc"><span class="hs-identifier hs-var">reportSDoc</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;tc.size.solve&quot;</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">20</span></span><span> </span><span class="annot"><span class="annottext">(TCMT IO Doc -&gt; TCM ()) -&gt; TCMT IO Doc -&gt; TCM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-556"></span><span>            </span><span class="annot"><span class="annottext">TCMT IO Doc
</span><span class="hs-string">&quot;solution &quot;</span></span><span> </span><span class="annot"><span class="annottext">TCMT IO Doc -&gt; TCMT IO Doc -&gt; TCMT IO Doc
forall (m :: * -&gt; *). Applicative m =&gt; m Doc -&gt; m Doc -&gt; m Doc
</span><a href="Agda.TypeChecking.Pretty.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Term -&gt; TCMT IO Doc
forall a (m :: * -&gt; *). (PrettyTCM a, MonadPretty m) =&gt; a -&gt; m Doc
forall (m :: * -&gt; *). MonadPretty m =&gt; Term -&gt; m Doc
</span><a href="Agda.TypeChecking.Pretty.html#prettyTCM"><span class="hs-identifier hs-var">prettyTCM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MetaId -&gt; Elims -&gt; Term
</span><a href="Agda.Syntax.Internal.html#MetaV"><span class="hs-identifier hs-var">MetaV</span></a></span><span> </span><span class="annot"><span class="annottext">MetaId
</span><a href="#local-6989586621681545297"><span class="hs-identifier hs-var">m</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TCMT IO Doc -&gt; TCMT IO Doc -&gt; TCMT IO Doc
forall (m :: * -&gt; *). Applicative m =&gt; m Doc -&gt; m Doc -&gt; m Doc
</span><a href="Agda.TypeChecking.Pretty.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span>
</span><span id="line-557"></span><span>            </span><span class="annot"><span class="annottext">TCMT IO Doc
</span><span class="hs-string">&quot; := &quot;</span></span><span>      </span><span class="annot"><span class="annottext">TCMT IO Doc -&gt; TCMT IO Doc -&gt; TCMT IO Doc
forall (m :: * -&gt; *). Applicative m =&gt; m Doc -&gt; m Doc -&gt; m Doc
</span><a href="Agda.TypeChecking.Pretty.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Term -&gt; TCMT IO Doc
forall a (m :: * -&gt; *). (PrettyTCM a, MonadPretty m) =&gt; a -&gt; m Doc
forall (m :: * -&gt; *). MonadPretty m =&gt; Term -&gt; m Doc
</span><a href="Agda.TypeChecking.Pretty.html#prettyTCM"><span class="hs-identifier hs-var">prettyTCM</span></a></span><span> </span><span class="annot"><span class="annottext">Term
</span><a href="#local-6989586621681545295"><span class="hs-identifier hs-var">inf</span></a></span><span>
</span><span id="line-558"></span><span>          </span><span id="local-6989586621681545299"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681545299"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">MetaId -&gt; TCMT IO Type
forall (m :: * -&gt; *). ReadTCState m =&gt; MetaId -&gt; m Type
</span><a href="Agda.TypeChecking.Monad.MetaVars.html#metaType"><span class="hs-identifier hs-var">metaType</span></a></span><span> </span><span class="annot"><span class="annottext">MetaId
</span><a href="#local-6989586621681545297"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-559"></span><span>          </span><span class="annot"><a href="Agda.TypeChecking.Substitute.html#TelV"><span class="hs-identifier hs-type">TelV</span></a></span><span> </span><span id="local-6989586621681545302"><span class="annot"><span class="annottext">Tele (Dom Type)
</span><a href="#local-6989586621681545302"><span class="hs-identifier hs-var">tel</span></a></span></span><span> </span><span id="local-6989586621681545303"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681545303"><span class="hs-identifier hs-var">core</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Type -&gt; TCMT IO (TelV Type)
forall (m :: * -&gt; *).
(MonadReduce m, MonadAddContext m) =&gt;
Type -&gt; m (TelV Type)
</span><a href="Agda.TypeChecking.Telescope.html#telView"><span class="hs-identifier hs-var">telView</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681545299"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-560"></span><span>          </span><span class="annot"><span class="annottext">TCMT IO Bool -&gt; TCM () -&gt; TCM ()
forall (m :: * -&gt; *). Monad m =&gt; m Bool -&gt; m () -&gt; m ()
</span><a href="Agda.Utils.Monad.html#unlessM"><span class="hs-identifier hs-var">unlessM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe BoundedSize -&gt; Bool
forall a. Maybe a -&gt; Bool
</span><span class="hs-identifier hs-var">isJust</span></span><span> </span><span class="annot"><span class="annottext">(Maybe BoundedSize -&gt; Bool)
-&gt; TCMT IO (Maybe BoundedSize) -&gt; TCMT IO Bool
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Type -&gt; TCMT IO (Maybe BoundedSize)
forall a (m :: * -&gt; *).
(IsSizeType a, HasOptions m, HasBuiltins m) =&gt;
a -&gt; m (Maybe BoundedSize)
forall (m :: * -&gt; *).
(HasOptions m, HasBuiltins m) =&gt;
Type -&gt; m (Maybe BoundedSize)
</span><a href="Agda.TypeChecking.Monad.SizedTypes.html#isSizeType"><span class="hs-identifier hs-var">isSizeType</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681545303"><span class="hs-identifier hs-var">core</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TCM ()
forall a. HasCallStack =&gt; a
</span><a href="Agda.Utils.Impossible.html#__IMPOSSIBLE__"><span class="hs-identifier hs-var">__IMPOSSIBLE__</span></a></span><span>
</span><span id="line-561"></span><span>          </span><span class="annot"><span class="annottext">Int -&gt; MetaId -&gt; Type -&gt; [Int] -&gt; Term -&gt; TCM ()
</span><a href="Agda.TypeChecking.MetaVars.html#assignMeta"><span class="hs-identifier hs-var">assignMeta</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">MetaId
</span><a href="#local-6989586621681545297"><span class="hs-identifier hs-var">m</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681545299"><span class="hs-identifier hs-var">t</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; [Int]
forall a. Integral a =&gt; a -&gt; [a]
</span><a href="Agda.Utils.List.html#downFrom"><span class="hs-identifier hs-var">List.downFrom</span></a></span><span> </span><span class="annot"><span class="annottext">(Int -&gt; [Int]) -&gt; Int -&gt; [Int]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Tele (Dom Type) -&gt; Int
forall a. Sized a =&gt; a -&gt; Int
</span><a href="Agda.Utils.Size.html#size"><span class="hs-identifier hs-var">size</span></a></span><span> </span><span class="annot"><span class="annottext">Tele (Dom Type)
</span><a href="#local-6989586621681545302"><span class="hs-identifier hs-var">tel</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Term
</span><a href="#local-6989586621681545295"><span class="hs-identifier hs-var">inf</span></a></span><span>
</span><span id="line-562"></span><span>          </span><span class="annot"><span class="annottext">Bool -&gt; TCMT IO Bool
forall a. a -&gt; TCMT IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-563"></span><span>
</span><span id="line-564"></span><span>  </span><span class="hs-comment">-- Double check.</span><span>
</span><span id="line-565"></span><span>  </span><span class="annot"><span class="annottext">Bool -&gt; TCM () -&gt; TCM ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681545293"><span class="hs-identifier hs-var">solvedAll</span></a></span><span> </span><span class="annot"><span class="annottext">(TCM () -&gt; TCM ()) -&gt; TCM () -&gt; TCM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-566"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681545307"><span class="annot"><span class="annottext">cs0 :: NonEmpty ProblemConstraint
</span><a href="#local-6989586621681545307"><span class="hs-identifier hs-var hs-var">cs0</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((ProblemConstraint, HypSizeConstraint) -&gt; ProblemConstraint)
-&gt; List1 (ProblemConstraint, HypSizeConstraint)
-&gt; NonEmpty ProblemConstraint
forall a b. (a -&gt; b) -&gt; NonEmpty a -&gt; NonEmpty b
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">(ProblemConstraint, HypSizeConstraint) -&gt; ProblemConstraint
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="annot"><span class="annottext">List1 (ProblemConstraint, HypSizeConstraint)
</span><a href="#local-6989586621681545225"><span class="hs-identifier hs-var">ccs</span></a></span><span>
</span><span id="line-567"></span><span>        </span><span class="hs-comment">-- Error for giving up</span><span>
</span><span id="line-568"></span><span>        </span><span id="local-6989586621681545308"><span class="annot"><span class="annottext">cannotSolve :: TCM ()
</span><a href="#local-6989586621681545308"><span class="hs-identifier hs-var hs-var">cannotSolve</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TypeError -&gt; TCM ()
forall (m :: * -&gt; *) a.
(HasCallStack, MonadTCError m) =&gt;
TypeError -&gt; m a
</span><a href="Agda.TypeChecking.Monad.Base.html#typeError"><span class="hs-identifier hs-var">typeError</span></a></span><span> </span><span class="annot"><span class="annottext">(TypeError -&gt; TCM ()) -&gt; (Doc -&gt; TypeError) -&gt; Doc -&gt; TCM ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; TypeError
</span><a href="Agda.TypeChecking.Monad.Base.html#GenericDocError"><span class="hs-identifier hs-var">GenericDocError</span></a></span><span> </span><span class="annot"><span class="annottext">(Doc -&gt; TCM ()) -&gt; TCMT IO Doc -&gt; TCM ()
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; m a -&gt; m b
</span><span class="hs-operator hs-var">=&lt;&lt;</span></span><span>
</span><span id="line-569"></span><span>          </span><span class="annot"><span class="annottext">NonEmpty (TCMT IO Doc) -&gt; TCMT IO Doc
forall (m :: * -&gt; *) (t :: * -&gt; *).
(Applicative m, Foldable t) =&gt;
t (m Doc) -&gt; m Doc
</span><a href="Agda.TypeChecking.Pretty.html#vcat"><span class="hs-identifier hs-var">vcat</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TCMT IO Doc
</span><span class="hs-string">&quot;Cannot solve size constraints&quot;</span></span><span> </span><span class="annot"><span class="annottext">TCMT IO Doc -&gt; NonEmpty (TCMT IO Doc) -&gt; NonEmpty (TCMT IO Doc)
forall a. a -&gt; NonEmpty a -&gt; NonEmpty a
</span><span class="hs-operator hs-var">&lt;|</span></span><span> </span><span class="annot"><span class="annottext">(ProblemConstraint -&gt; TCMT IO Doc)
-&gt; NonEmpty ProblemConstraint -&gt; NonEmpty (TCMT IO Doc)
forall a b. (a -&gt; b) -&gt; NonEmpty a -&gt; NonEmpty b
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">ProblemConstraint -&gt; TCMT IO Doc
forall a (m :: * -&gt; *). (PrettyTCM a, MonadPretty m) =&gt; a -&gt; m Doc
forall (m :: * -&gt; *). MonadPretty m =&gt; ProblemConstraint -&gt; m Doc
</span><a href="Agda.TypeChecking.Pretty.html#prettyTCM"><span class="hs-identifier hs-var">prettyTCM</span></a></span><span> </span><span class="annot"><span class="annottext">NonEmpty ProblemConstraint
</span><a href="#local-6989586621681545307"><span class="hs-identifier hs-var">cs0</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-570"></span><span>    </span><span class="annot"><span class="annottext">(TCM () -&gt; (TCErr -&gt; TCM ()) -&gt; TCM ())
-&gt; (TCErr -&gt; TCM ()) -&gt; TCM () -&gt; TCM ()
forall a b c. (a -&gt; b -&gt; c) -&gt; b -&gt; a -&gt; c
</span><span class="hs-identifier hs-var">flip</span></span><span> </span><span class="annot"><span class="annottext">TCM () -&gt; (TCErr -&gt; TCM ()) -&gt; TCM ()
forall a. TCMT IO a -&gt; (TCErr -&gt; TCMT IO a) -&gt; TCMT IO a
forall e (m :: * -&gt; *) a.
MonadError e m =&gt;
m a -&gt; (e -&gt; m a) -&gt; m a
</span><span class="hs-identifier hs-var">catchError</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TCM () -&gt; TCErr -&gt; TCM ()
forall a b. a -&gt; b -&gt; a
</span><span class="hs-identifier hs-var">const</span></span><span> </span><span class="annot"><span class="annottext">TCM ()
</span><a href="#local-6989586621681545308"><span class="hs-identifier hs-var">cannotSolve</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(TCM () -&gt; TCM ()) -&gt; TCM () -&gt; TCM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-571"></span><span>      </span><span class="annot"><span class="annottext">TCM () -&gt; TCM ()
forall (m :: * -&gt; *) a.
(MonadConstraint m, MonadWarning m, MonadError TCErr m,
 MonadFresh ProblemId m) =&gt;
m a -&gt; m a
</span><a href="Agda.TypeChecking.Constraints.html#noConstraints"><span class="hs-identifier hs-var">noConstraints</span></a></span><span> </span><span class="annot"><span class="annottext">(TCM () -&gt; TCM ()) -&gt; TCM () -&gt; TCM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-572"></span><span>        </span><span class="annot"><span class="annottext">NonEmpty ProblemConstraint
-&gt; (ProblemConstraint -&gt; TCM ()) -&gt; TCM ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="annot"><span class="annottext">NonEmpty ProblemConstraint
</span><a href="#local-6989586621681545307"><span class="hs-identifier hs-var">cs0</span></a></span><span> </span><span class="annot"><span class="annottext">((ProblemConstraint -&gt; TCM ()) -&gt; TCM ())
-&gt; (ProblemConstraint -&gt; TCM ()) -&gt; TCM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(Constraint -&gt; TCM ()) -&gt; ProblemConstraint -&gt; TCM ()
forall (m :: * -&gt; *) a.
MonadConstraint m =&gt;
(Constraint -&gt; m a) -&gt; ProblemConstraint -&gt; m a
</span><a href="Agda.TypeChecking.Monad.Constraints.html#withConstraint"><span class="hs-identifier hs-var">withConstraint</span></a></span><span> </span><span class="annot"><span class="annottext">Constraint -&gt; TCM ()
forall (m :: * -&gt; *). MonadConstraint m =&gt; Constraint -&gt; m ()
</span><a href="Agda.TypeChecking.Monad.Constraints.html#solveConstraint"><span class="hs-identifier hs-var">solveConstraint</span></a></span><span>
</span><span id="line-573"></span><span>
</span><span id="line-574"></span><span class="annot"><span class="hs-comment">-- | Collect constraints from a typing context, looking for SIZELT hypotheses.</span></span><span>
</span><span id="line-575"></span><span class="annot"><a href="Agda.TypeChecking.SizedTypes.Solve.html#getSizeHypotheses"><span class="hs-identifier hs-type">getSizeHypotheses</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Agda.TypeChecking.Monad.Base.html#Context"><span class="hs-identifier hs-type">Context</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Agda.TypeChecking.Monad.Base.html#TCM"><span class="hs-identifier hs-type">TCM</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="Agda.Syntax.Common.html#Nat"><span class="hs-identifier hs-type">Nat</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Agda.TypeChecking.SizedTypes.Solve.html#SizeConstraint"><span class="hs-identifier hs-type">SizeConstraint</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-576"></span><span id="getSizeHypotheses"><span class="annot"><span class="annottext">getSizeHypotheses :: Context -&gt; TCM [(Int, SizeConstraint)]
</span><a href="Agda.TypeChecking.SizedTypes.Solve.html#getSizeHypotheses"><span class="hs-identifier hs-var hs-var">getSizeHypotheses</span></a></span></span><span> </span><span id="local-6989586621681545314"><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621681545314"><span class="hs-identifier hs-var">gamma</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Context -&gt; Context)
-&gt; TCM [(Int, SizeConstraint)] -&gt; TCM [(Int, SizeConstraint)]
forall (tcm :: * -&gt; *) a.
MonadTCEnv tcm =&gt;
(Context -&gt; Context) -&gt; tcm a -&gt; tcm a
</span><a href="Agda.TypeChecking.Monad.Context.html#unsafeModifyContext"><span class="hs-identifier hs-var">unsafeModifyContext</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Context -&gt; Context -&gt; Context
forall a b. a -&gt; b -&gt; a
</span><span class="hs-identifier hs-var">const</span></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621681545314"><span class="hs-identifier hs-var">gamma</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(TCM [(Int, SizeConstraint)] -&gt; TCM [(Int, SizeConstraint)])
-&gt; TCM [(Int, SizeConstraint)] -&gt; TCM [(Int, SizeConstraint)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-577"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe QName
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681545315"><span class="annot"><span class="annottext">Maybe QName
</span><a href="#local-6989586621681545315"><span class="hs-identifier hs-var">msizelt</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TCMT IO (Maybe QName, Maybe QName)
forall (m :: * -&gt; *). HasBuiltins m =&gt; m (Maybe QName, Maybe QName)
</span><a href="Agda.TypeChecking.Monad.SizedTypes.html#getBuiltinSize"><span class="hs-identifier hs-var">getBuiltinSize</span></a></span><span>
</span><span id="line-578"></span><span>  </span><span class="annot"><span class="annottext">Maybe QName
-&gt; TCM [(Int, SizeConstraint)]
-&gt; (QName -&gt; TCM [(Int, SizeConstraint)])
-&gt; TCM [(Int, SizeConstraint)]
forall a b. Maybe a -&gt; b -&gt; (a -&gt; b) -&gt; b
</span><a href="Agda.Utils.Maybe.html#caseMaybe"><span class="hs-identifier hs-var">caseMaybe</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe QName
</span><a href="#local-6989586621681545315"><span class="hs-identifier hs-var">msizelt</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[(Int, SizeConstraint)] -&gt; TCM [(Int, SizeConstraint)]
forall a. a -&gt; TCMT IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((QName -&gt; TCM [(Int, SizeConstraint)])
 -&gt; TCM [(Int, SizeConstraint)])
-&gt; (QName -&gt; TCM [(Int, SizeConstraint)])
-&gt; TCM [(Int, SizeConstraint)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span> </span><span id="local-6989586621681545318"><span class="annot"><span class="annottext">QName
</span><a href="#local-6989586621681545318"><span class="hs-identifier hs-var">sizelt</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-579"></span><span>    </span><span class="hs-comment">-- Traverse the context from newest to oldest de Bruijn Index</span><span>
</span><span id="line-580"></span><span>    </span><span class="annot"><span class="annottext">[Maybe (Int, SizeConstraint)] -&gt; [(Int, SizeConstraint)]
forall a. [Maybe a] -&gt; [a]
</span><span class="hs-identifier hs-var">catMaybes</span></span><span> </span><span class="annot"><span class="annottext">([Maybe (Int, SizeConstraint)] -&gt; [(Int, SizeConstraint)])
-&gt; TCMT IO [Maybe (Int, SizeConstraint)]
-&gt; TCM [(Int, SizeConstraint)]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-581"></span><span>      </span><span class="annot"><span class="annottext">[(Int, Dom' Term (Name, Type))]
-&gt; ((Int, Dom' Term (Name, Type))
    -&gt; TCMT IO (Maybe (Int, SizeConstraint)))
-&gt; TCMT IO [Maybe (Int, SizeConstraint)]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m (t b)
</span><span class="hs-identifier hs-var">forM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Int] -&gt; Context -&gt; [(Int, Dom' Term (Name, Type))]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span class="hs-glyph">..</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621681545314"><span class="hs-identifier hs-var">gamma</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((Int, Dom' Term (Name, Type))
  -&gt; TCMT IO (Maybe (Int, SizeConstraint)))
 -&gt; TCMT IO [Maybe (Int, SizeConstraint)])
-&gt; ((Int, Dom' Term (Name, Type))
    -&gt; TCMT IO (Maybe (Int, SizeConstraint)))
-&gt; TCMT IO [Maybe (Int, SizeConstraint)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681545319"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681545319"><span class="hs-identifier hs-var">i</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681545320"><span class="annot"><span class="annottext">Dom' Term (Name, Type)
</span><a href="#local-6989586621681545320"><span class="hs-identifier hs-var">ce</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-582"></span><span>        </span><span class="hs-comment">-- Get name and type of variable i.</span><span>
</span><span id="line-583"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681545321"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681545321"><span class="hs-identifier hs-var">x</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681545322"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681545322"><span class="hs-identifier hs-var">t</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Dom' Term (Name, Type) -&gt; (Name, Type)
forall t e. Dom' t e -&gt; e
</span><a href="Agda.Syntax.Internal.html#unDom"><span class="hs-identifier hs-var">unDom</span></a></span><span> </span><span class="annot"><span class="annottext">Dom' Term (Name, Type)
</span><a href="#local-6989586621681545320"><span class="hs-identifier hs-var">ce</span></a></span><span>
</span><span id="line-584"></span><span>            </span><span id="local-6989586621681545323"><span class="annot"><span class="annottext">s :: String
</span><a href="#local-6989586621681545323"><span class="hs-identifier hs-var hs-var">s</span></a></span></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Name -&gt; String
forall a. Pretty a =&gt; a -&gt; String
</span><a href="Agda.Syntax.Common.Pretty.html#prettyShow"><span class="hs-identifier hs-var">prettyShow</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681545321"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-585"></span><span>        </span><span id="local-6989586621681545324"><span class="annot"><span class="annottext">Term
</span><a href="#local-6989586621681545324"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Term -&gt; TCMT IO Term
forall a (m :: * -&gt; *). (Reduce a, MonadReduce m) =&gt; a -&gt; m a
</span><a href="Agda.TypeChecking.Reduce.html#reduce"><span class="hs-identifier hs-var">reduce</span></a></span><span> </span><span class="annot"><span class="annottext">(Term -&gt; TCMT IO Term) -&gt; (Type -&gt; Term) -&gt; Type -&gt; TCMT IO Term
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Term -&gt; Term
forall a. Subst a =&gt; Int -&gt; a -&gt; a
</span><a href="Agda.TypeChecking.Substitute.Class.html#raise"><span class="hs-identifier hs-var">raise</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681545319"><span class="hs-identifier hs-var">i</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Term -&gt; Term) -&gt; (Type -&gt; Term) -&gt; Type -&gt; Term
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Type -&gt; Term
forall t a. Type'' t a -&gt; a
</span><a href="Agda.Syntax.Internal.html#unEl"><span class="hs-identifier hs-var">unEl</span></a></span><span> </span><span class="annot"><span class="annottext">(Type -&gt; TCMT IO Term) -&gt; Type -&gt; TCMT IO Term
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681545322"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-586"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Term
</span><a href="#local-6989586621681545324"><span class="hs-identifier hs-var">t</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-587"></span><span>          </span><span class="annot"><a href="Agda.Syntax.Internal.html#Def"><span class="hs-identifier hs-type">Def</span></a></span><span> </span><span id="local-6989586621681545329"><span class="annot"><span class="annottext">QName
</span><a href="#local-6989586621681545329"><span class="hs-identifier hs-var">d</span></a></span></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Agda.Syntax.Internal.Elim.html#Apply"><span class="hs-identifier hs-type">Apply</span></a></span><span> </span><span id="local-6989586621681545330"><span class="annot"><span class="annottext">Arg Term
</span><a href="#local-6989586621681545330"><span class="hs-identifier hs-var">u</span></a></span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">QName
</span><a href="#local-6989586621681545329"><span class="hs-identifier hs-var">d</span></a></span><span> </span><span class="annot"><span class="annottext">QName -&gt; QName -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">QName
</span><a href="#local-6989586621681545318"><span class="hs-identifier hs-var">sizelt</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-588"></span><span>            </span><span class="annot"><span class="annottext">TCMT IO (Maybe DBSizeExpr)
-&gt; TCMT IO (Maybe (Int, SizeConstraint))
-&gt; (DBSizeExpr -&gt; TCMT IO (Maybe (Int, SizeConstraint)))
-&gt; TCMT IO (Maybe (Int, SizeConstraint))
forall (m :: * -&gt; *) a b.
Monad m =&gt;
m (Maybe a) -&gt; m b -&gt; (a -&gt; m b) -&gt; m b
</span><a href="Agda.Utils.Maybe.html#caseMaybeM"><span class="hs-identifier hs-var">caseMaybeM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Term -&gt; TCMT IO (Maybe DBSizeExpr)
</span><a href="Agda.TypeChecking.SizedTypes.Solve.html#sizeExpr"><span class="hs-identifier hs-var">sizeExpr</span></a></span><span> </span><span class="annot"><span class="annottext">(Term -&gt; TCMT IO (Maybe DBSizeExpr))
-&gt; Term -&gt; TCMT IO (Maybe DBSizeExpr)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Arg Term -&gt; Term
forall e. Arg e -&gt; e
</span><a href="Agda.Syntax.Common.html#unArg"><span class="hs-identifier hs-var">unArg</span></a></span><span> </span><span class="annot"><span class="annottext">Arg Term
</span><a href="#local-6989586621681545330"><span class="hs-identifier hs-var">u</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe (Int, SizeConstraint)
-&gt; TCMT IO (Maybe (Int, SizeConstraint))
forall a. a -&gt; TCMT IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Maybe (Int, SizeConstraint)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((DBSizeExpr -&gt; TCMT IO (Maybe (Int, SizeConstraint)))
 -&gt; TCMT IO (Maybe (Int, SizeConstraint)))
-&gt; (DBSizeExpr -&gt; TCMT IO (Maybe (Int, SizeConstraint)))
-&gt; TCMT IO (Maybe (Int, SizeConstraint))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span> </span><span id="local-6989586621681545333"><span class="annot"><span class="annottext">DBSizeExpr
</span><a href="#local-6989586621681545333"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-589"></span><span>              </span><span class="annot"><span class="annottext">Maybe (Int, SizeConstraint)
-&gt; TCMT IO (Maybe (Int, SizeConstraint))
forall a. a -&gt; TCMT IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Maybe (Int, SizeConstraint)
 -&gt; TCMT IO (Maybe (Int, SizeConstraint)))
-&gt; Maybe (Int, SizeConstraint)
-&gt; TCMT IO (Maybe (Int, SizeConstraint))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(Int, SizeConstraint) -&gt; Maybe (Int, SizeConstraint)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">((Int, SizeConstraint) -&gt; Maybe (Int, SizeConstraint))
-&gt; (Int, SizeConstraint) -&gt; Maybe (Int, SizeConstraint)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681545319"><span class="hs-identifier hs-var">i</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">DBSizeExpr -&gt; Cmp -&gt; DBSizeExpr -&gt; SizeConstraint
forall rigid flex.
SizeExpr' rigid flex
-&gt; Cmp -&gt; SizeExpr' rigid flex -&gt; Constraint' rigid flex
</span><a href="Agda.TypeChecking.SizedTypes.Syntax.html#Constraint"><span class="hs-identifier hs-var">Constraint</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">NamedRigid -&gt; Offset -&gt; DBSizeExpr
forall rigid flex. rigid -&gt; Offset -&gt; SizeExpr' rigid flex
</span><a href="Agda.TypeChecking.SizedTypes.Syntax.html#Rigid"><span class="hs-identifier hs-var">Rigid</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; Int -&gt; NamedRigid
</span><a href="Agda.TypeChecking.SizedTypes.Solve.html#NamedRigid"><span class="hs-identifier hs-var">NamedRigid</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621681545323"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681545319"><span class="hs-identifier hs-var">i</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Offset
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Cmp
</span><a href="Agda.TypeChecking.SizedTypes.Syntax.html#Lt"><span class="hs-identifier hs-var">Lt</span></a></span><span> </span><span class="annot"><span class="annottext">DBSizeExpr
</span><a href="#local-6989586621681545333"><span class="hs-identifier hs-var">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-590"></span><span>          </span><span class="annot"><span class="annottext">Term
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe (Int, SizeConstraint)
-&gt; TCMT IO (Maybe (Int, SizeConstraint))
forall a. a -&gt; TCMT IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Maybe (Int, SizeConstraint)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-591"></span><span>
</span><span id="line-592"></span><span class="hs-comment">-- | Convert size constraint into form where each meta is applied</span><span>
</span><span id="line-593"></span><span class="hs-comment">--   to indices @n-1,...,1,0@ where @n@ is the arity of that meta.</span><span>
</span><span id="line-594"></span><span class="hs-comment">--</span><span>
</span><span id="line-595"></span><span class="hs-comment">--   @X[&#963;] &lt;= t@ becomes @X[id] &lt;= t[&#963;^-1]@</span><span>
</span><span id="line-596"></span><span class="hs-comment">--</span><span>
</span><span id="line-597"></span><span class="hs-comment">--   @X[&#963;] &#8804; Y[&#964;]@ becomes @X[id] &#8804; Y[&#964;[&#963;^-1]]@ or @X[&#963;[&#964;^1]] &#8804; Y[id]@</span><span>
</span><span id="line-598"></span><span class="hs-comment">--   whichever is defined.  If none is defined, we give up.</span><span>
</span><span id="line-599"></span><span class="hs-comment">--</span><span>
</span><span id="line-600"></span><span class="hs-comment">--   Cf. @SizedTypes.oldCanonicalizeSizeConstraint@.</span><span>
</span><span id="line-601"></span><span class="hs-comment">--</span><span>
</span><span id="line-602"></span><span class="hs-comment">--   Fixes (the rather artificial) issue 300.</span><span>
</span><span id="line-603"></span><span class="hs-comment">--   But it is unsound when pruned metas occur and triggers issue 1914.</span><span>
</span><span id="line-604"></span><span class="hs-comment">--   Thus we deactivate it.</span><span>
</span><span id="line-605"></span><span class="hs-comment">--   This needs to be properly implemented, possibly using the</span><span>
</span><span id="line-606"></span><span class="hs-comment">--   metaPermuatation of each meta variable.</span><span>
</span><span id="line-607"></span><span>
</span><span id="line-608"></span><span class="annot"><a href="Agda.TypeChecking.SizedTypes.Solve.html#canonicalizeSizeConstraint"><span class="hs-identifier hs-type">canonicalizeSizeConstraint</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Agda.TypeChecking.SizedTypes.Solve.html#SizeConstraint"><span class="hs-identifier hs-type">SizeConstraint</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Agda.TypeChecking.SizedTypes.Solve.html#SizeConstraint"><span class="hs-identifier hs-type">SizeConstraint</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-609"></span><span id="canonicalizeSizeConstraint"><span class="annot"><span class="annottext">canonicalizeSizeConstraint :: SizeConstraint -&gt; Maybe SizeConstraint
</span><a href="Agda.TypeChecking.SizedTypes.Solve.html#canonicalizeSizeConstraint"><span class="hs-identifier hs-var hs-var">canonicalizeSizeConstraint</span></a></span></span><span> </span><span id="local-6989586621681545338"><span class="annot"><span class="annottext">c :: SizeConstraint
</span><a href="#local-6989586621681545338"><span class="hs-identifier hs-var">c</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Agda.TypeChecking.SizedTypes.Syntax.html#Constraint"><span class="hs-identifier hs-type">Constraint</span></a></span><span> </span><span id="local-6989586621681545339"><span class="annot"><span class="annottext">DBSizeExpr
</span><a href="#local-6989586621681545339"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span id="local-6989586621681545340"><span class="annot"><span class="annottext">Cmp
</span><a href="#local-6989586621681545340"><span class="hs-identifier hs-var">cmp</span></a></span></span><span> </span><span id="local-6989586621681545341"><span class="annot"><span class="annottext">DBSizeExpr
</span><a href="#local-6989586621681545341"><span class="hs-identifier hs-var">b</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SizeConstraint -&gt; Maybe SizeConstraint
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">SizeConstraint
</span><a href="#local-6989586621681545338"><span class="hs-identifier hs-var">c</span></a></span><span>
</span><span id="line-610"></span><span class="hs-comment">{-
  case (a,b) of

    -- Case flex-flex
    (Flex (SizeMeta m xs) n, Flex (SizeMeta l ys) n')
         -- try to invert xs on ys
       | let len = size xs
       , Just ys' &lt;- mapM (\ y -&gt; (len-1 -) &lt;$&gt; findIndex (==y) xs) ys -&gt;
           return $ Constraint (Flex (SizeMeta m $ downFrom len) n)
                           cmp (Flex (SizeMeta l ys') n')
         -- try to invert ys on xs
       | let len = size ys
       , Just xs' &lt;- mapM (\ x -&gt; (len-1 -) &lt;$&gt; findIndex (==x) ys) xs -&gt;
           return $ Constraint (Flex (SizeMeta m xs') n)
                           cmp (Flex (SizeMeta l $ downFrom len) n')
         -- give up
       | otherwise -&gt; Nothing

    -- Case flex-rigid
    (Flex (SizeMeta m xs) n, Rigid (NamedRigid x i) n') -&gt; do
      let len = size xs
      j &lt;- (len-1 -) &lt;$&gt; findIndex (==i) xs
      return $ Constraint (Flex (SizeMeta m $ downFrom len) n)
                      cmp (Rigid (NamedRigid x j) n')

    -- Case rigid-flex
    (Rigid (NamedRigid x i) n, Flex (SizeMeta m xs) n') -&gt; do
      let len = size xs
      j &lt;- (len-1 -) &lt;$&gt; findIndex (==i) xs
      return $ Constraint (Rigid (NamedRigid x j) n)
                      cmp (Flex (SizeMeta m $ downFrom len) n')

    -- Case flex-const
    (Flex (SizeMeta m xs) n, _)      -&gt;
      return $ Constraint (Flex (SizeMeta m $ downFrom $ size xs) n) cmp b

    -- Case const-flex
    (_, Flex (SizeMeta m xs) n') -&gt; do
      return $ Constraint a cmp (Flex (SizeMeta m $ downFrom $ size xs) n')

    -- Case no flex
    _ -&gt; return c
-}</span><span>
</span><span id="line-653"></span><span>
</span><span id="line-654"></span><span class="annot"><span class="hs-comment">-- | Identifiers for rigid variables.</span></span><span>
</span><span id="line-655"></span><span class="hs-keyword">data</span><span> </span><span id="NamedRigid"><span class="annot"><a href="Agda.TypeChecking.SizedTypes.Solve.html#NamedRigid"><span class="hs-identifier hs-var">NamedRigid</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="NamedRigid"><span class="annot"><a href="Agda.TypeChecking.SizedTypes.Solve.html#NamedRigid"><span class="hs-identifier hs-var">NamedRigid</span></a></span></span><span>
</span><span id="line-656"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="rigidName"><span class="annot"><span class="annottext">NamedRigid -&gt; String
</span><a href="Agda.TypeChecking.SizedTypes.Solve.html#rigidName"><span class="hs-identifier hs-var hs-var">rigidName</span></a></span></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span>   </span><span class="annot"><span class="hs-comment">-- ^ Name for printing in debug messages.</span></span><span>
</span><span id="line-657"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="rigidIndex"><span class="annot"><span class="annottext">NamedRigid -&gt; Int
</span><a href="Agda.TypeChecking.SizedTypes.Solve.html#rigidIndex"><span class="hs-identifier hs-var hs-var">rigidIndex</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>      </span><span class="annot"><span class="hs-comment">-- ^ De Bruijn index.</span></span><span>
</span><span id="line-658"></span><span>  </span><span class="hs-special">}</span><span> </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681545344"><span id="local-6989586621681545350"><span id="local-6989586621681545353"><span class="annot"><span class="annottext">Int -&gt; NamedRigid -&gt; ShowS
[NamedRigid] -&gt; ShowS
NamedRigid -&gt; String
(Int -&gt; NamedRigid -&gt; ShowS)
-&gt; (NamedRigid -&gt; String)
-&gt; ([NamedRigid] -&gt; ShowS)
-&gt; Show NamedRigid
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
$cshowsPrec :: Int -&gt; NamedRigid -&gt; ShowS
showsPrec :: Int -&gt; NamedRigid -&gt; ShowS
$cshow :: NamedRigid -&gt; String
show :: NamedRigid -&gt; String
$cshowList :: [NamedRigid] -&gt; ShowS
showList :: [NamedRigid] -&gt; ShowS
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-659"></span><span>
</span><span id="line-660"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621681545358"><span class="annot"><span class="hs-identifier hs-type">Eq</span></span><span> </span><span class="annot"><a href="Agda.TypeChecking.SizedTypes.Solve.html#NamedRigid"><span class="hs-identifier hs-type">NamedRigid</span></a></span></span><span> </span><span class="hs-keyword">where</span><span> </span><span id="local-6989586621681545361"><span class="annot"><span class="annottext">== :: NamedRigid -&gt; NamedRigid -&gt; Bool
</span><span class="hs-operator hs-var hs-var hs-var hs-var">(==)</span></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">(==)</span></span><span> </span><span class="annot"><span class="annottext">(Int -&gt; Int -&gt; Bool)
-&gt; (NamedRigid -&gt; Int) -&gt; NamedRigid -&gt; NamedRigid -&gt; Bool
forall b c a. (b -&gt; b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; a -&gt; c
</span><span class="hs-operator hs-var">`on`</span></span><span> </span><span class="annot"><span class="annottext">NamedRigid -&gt; Int
</span><a href="Agda.TypeChecking.SizedTypes.Solve.html#rigidIndex"><span class="hs-identifier hs-var">rigidIndex</span></a></span><span>
</span><span id="line-661"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621681545366"><span id="local-6989586621681545369"><span id="local-6989586621681545372"><span id="local-6989586621681545375"><span id="local-6989586621681545378"><span id="local-6989586621681545381"><span class="annot"><span class="hs-identifier hs-type">Ord</span></span><span> </span><span class="annot"><a href="Agda.TypeChecking.SizedTypes.Solve.html#NamedRigid"><span class="hs-identifier hs-type">NamedRigid</span></a></span></span></span></span></span></span></span><span> </span><span class="hs-keyword">where</span><span> </span><span id="local-6989586621681545384"><span class="annot"><span class="annottext">compare :: NamedRigid -&gt; NamedRigid -&gt; Ordering
</span><span class="hs-identifier hs-var hs-var hs-var hs-var">compare</span></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Ordering
forall a. Ord a =&gt; a -&gt; a -&gt; Ordering
</span><span class="hs-identifier hs-var">compare</span></span><span> </span><span class="annot"><span class="annottext">(Int -&gt; Int -&gt; Ordering)
-&gt; (NamedRigid -&gt; Int) -&gt; NamedRigid -&gt; NamedRigid -&gt; Ordering
forall b c a. (b -&gt; b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; a -&gt; c
</span><span class="hs-operator hs-var">`on`</span></span><span> </span><span class="annot"><span class="annottext">NamedRigid -&gt; Int
</span><a href="Agda.TypeChecking.SizedTypes.Solve.html#rigidIndex"><span class="hs-identifier hs-var">rigidIndex</span></a></span><span>
</span><span id="line-662"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621681545387"><span id="local-6989586621681545390"><span class="annot"><a href="Agda.Syntax.Common.Pretty.html#Pretty"><span class="hs-identifier hs-type">Pretty</span></a></span><span> </span><span class="annot"><a href="Agda.TypeChecking.SizedTypes.Solve.html#NamedRigid"><span class="hs-identifier hs-type">NamedRigid</span></a></span></span></span><span> </span><span class="hs-keyword">where</span><span> </span><span id="local-6989586621681545393"><span class="annot"><span class="annottext">pretty :: NamedRigid -&gt; Doc
</span><a href="#local-6989586621681545393"><span class="hs-identifier hs-var hs-var hs-var hs-var">pretty</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; Doc
forall a. String -&gt; Doc a
</span><span class="hs-identifier hs-var">P.text</span></span><span> </span><span class="annot"><span class="annottext">(String -&gt; Doc) -&gt; (NamedRigid -&gt; String) -&gt; NamedRigid -&gt; Doc
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">NamedRigid -&gt; String
</span><a href="Agda.TypeChecking.SizedTypes.Solve.html#rigidName"><span class="hs-identifier hs-var">rigidName</span></a></span><span>
</span><span id="line-663"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="Agda.TypeChecking.SizedTypes.Utils.html#Plus"><span class="hs-identifier hs-type">Plus</span></a></span><span> </span><span class="annot"><a href="Agda.TypeChecking.SizedTypes.Solve.html#NamedRigid"><span class="hs-identifier hs-type">NamedRigid</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="annot"><a href="Agda.TypeChecking.SizedTypes.Solve.html#NamedRigid"><span class="hs-identifier hs-type">NamedRigid</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-664"></span><span>  </span><span id="local-6989586621681545400"><span class="annot"><span class="annottext">plus :: NamedRigid -&gt; Int -&gt; NamedRigid
</span><a href="#local-6989586621681545400"><span class="hs-identifier hs-var hs-var hs-var hs-var">plus</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Agda.TypeChecking.SizedTypes.Solve.html#NamedRigid"><span class="hs-identifier hs-type">NamedRigid</span></a></span><span> </span><span id="local-6989586621681545402"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621681545402"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621681545403"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681545403"><span class="hs-identifier hs-var">i</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621681545404"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681545404"><span class="hs-identifier hs-var">j</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; Int -&gt; NamedRigid
</span><a href="Agda.TypeChecking.SizedTypes.Solve.html#NamedRigid"><span class="hs-identifier hs-var">NamedRigid</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621681545402"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681545403"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681545404"><span class="hs-identifier hs-var">j</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-665"></span><span>
</span><span id="line-666"></span><span class="annot"><span class="hs-comment">-- | Size metas in size expressions.</span></span><span>
</span><span id="line-667"></span><span class="hs-keyword">data</span><span> </span><span id="SizeMeta"><span class="annot"><a href="Agda.TypeChecking.SizedTypes.Solve.html#SizeMeta"><span class="hs-identifier hs-var">SizeMeta</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="SizeMeta"><span class="annot"><a href="Agda.TypeChecking.SizedTypes.Solve.html#SizeMeta"><span class="hs-identifier hs-var">SizeMeta</span></a></span></span><span>
</span><span id="line-668"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="sizeMetaId"><span class="annot"><span class="annottext">SizeMeta -&gt; MetaId
</span><a href="Agda.TypeChecking.SizedTypes.Solve.html#sizeMetaId"><span class="hs-identifier hs-var hs-var">sizeMetaId</span></a></span></span><span>   </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Agda.Syntax.Common.html#MetaId"><span class="hs-identifier hs-type">MetaId</span></a></span><span>
</span><span id="line-669"></span><span>  </span><span class="hs-comment">-- TODO to fix issue 300?</span><span>
</span><span id="line-670"></span><span>  </span><span class="hs-comment">-- , sizeMetaPerm :: Permutation -- ^ Permutation from the current context</span><span>
</span><span id="line-671"></span><span>  </span><span class="hs-comment">--                               --   to the context of the meta.</span><span>
</span><span id="line-672"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="sizeMetaArgs"><span class="annot"><span class="annottext">SizeMeta -&gt; [Int]
</span><a href="Agda.TypeChecking.SizedTypes.Solve.html#sizeMetaArgs"><span class="hs-identifier hs-var hs-var">sizeMetaArgs</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span class="hs-special">]</span><span>       </span><span class="annot"><span class="hs-comment">-- ^ De Bruijn indices.</span></span><span>
</span><span id="line-673"></span><span>  </span><span class="hs-special">}</span><span> </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681545407"><span id="local-6989586621681545412"><span id="local-6989586621681545416"><span class="annot"><span class="annottext">Int -&gt; SizeMeta -&gt; ShowS
[SizeMeta] -&gt; ShowS
SizeMeta -&gt; String
(Int -&gt; SizeMeta -&gt; ShowS)
-&gt; (SizeMeta -&gt; String) -&gt; ([SizeMeta] -&gt; ShowS) -&gt; Show SizeMeta
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
$cshowsPrec :: Int -&gt; SizeMeta -&gt; ShowS
showsPrec :: Int -&gt; SizeMeta -&gt; ShowS
$cshow :: SizeMeta -&gt; String
show :: SizeMeta -&gt; String
$cshowList :: [SizeMeta] -&gt; ShowS
showList :: [SizeMeta] -&gt; ShowS
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-674"></span><span>
</span><span id="line-675"></span><span class="annot"><span class="hs-comment">-- | An equality which ignores the meta arguments.</span></span><span>
</span><span id="line-676"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621681545420"><span class="annot"><span class="hs-identifier hs-type">Eq</span></span><span>  </span><span class="annot"><a href="Agda.TypeChecking.SizedTypes.Solve.html#SizeMeta"><span class="hs-identifier hs-type">SizeMeta</span></a></span></span><span> </span><span class="hs-keyword">where</span><span> </span><span id="local-6989586621681545424"><span class="annot"><span class="annottext">== :: SizeMeta -&gt; SizeMeta -&gt; Bool
</span><span class="hs-operator hs-var hs-var hs-var hs-var">(==)</span></span></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">MetaId -&gt; MetaId -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">(==)</span></span><span>    </span><span class="annot"><span class="annottext">(MetaId -&gt; MetaId -&gt; Bool)
-&gt; (SizeMeta -&gt; MetaId) -&gt; SizeMeta -&gt; SizeMeta -&gt; Bool
forall b c a. (b -&gt; b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; a -&gt; c
</span><span class="hs-operator hs-var">`on`</span></span><span> </span><span class="annot"><span class="annottext">SizeMeta -&gt; MetaId
</span><a href="Agda.TypeChecking.SizedTypes.Solve.html#sizeMetaId"><span class="hs-identifier hs-var">sizeMetaId</span></a></span><span>
</span><span id="line-677"></span><span class="annot"><span class="hs-comment">-- | An order which ignores the meta arguments.</span></span><span>
</span><span id="line-678"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621681545429"><span id="local-6989586621681545433"><span id="local-6989586621681545436"><span id="local-6989586621681545439"><span id="local-6989586621681545442"><span id="local-6989586621681545445"><span class="annot"><span class="hs-identifier hs-type">Ord</span></span><span> </span><span class="annot"><a href="Agda.TypeChecking.SizedTypes.Solve.html#SizeMeta"><span class="hs-identifier hs-type">SizeMeta</span></a></span></span></span></span></span></span></span><span> </span><span class="hs-keyword">where</span><span> </span><span id="local-6989586621681545448"><span class="annot"><span class="annottext">compare :: SizeMeta -&gt; SizeMeta -&gt; Ordering
</span><span class="hs-identifier hs-var hs-var hs-var hs-var">compare</span></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">MetaId -&gt; MetaId -&gt; Ordering
forall a. Ord a =&gt; a -&gt; a -&gt; Ordering
</span><span class="hs-identifier hs-var">compare</span></span><span> </span><span class="annot"><span class="annottext">(MetaId -&gt; MetaId -&gt; Ordering)
-&gt; (SizeMeta -&gt; MetaId) -&gt; SizeMeta -&gt; SizeMeta -&gt; Ordering
forall b c a. (b -&gt; b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; a -&gt; c
</span><span class="hs-operator hs-var">`on`</span></span><span> </span><span class="annot"><span class="annottext">SizeMeta -&gt; MetaId
</span><a href="Agda.TypeChecking.SizedTypes.Solve.html#sizeMetaId"><span class="hs-identifier hs-var">sizeMetaId</span></a></span><span>
</span><span id="line-679"></span><span>
</span><span id="line-680"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621681545451"><span id="local-6989586621681545454"><span class="annot"><a href="Agda.Syntax.Common.Pretty.html#Pretty"><span class="hs-identifier hs-type">Pretty</span></a></span><span> </span><span class="annot"><a href="Agda.TypeChecking.SizedTypes.Solve.html#SizeMeta"><span class="hs-identifier hs-type">SizeMeta</span></a></span></span></span><span> </span><span class="hs-keyword">where</span><span> </span><span id="local-6989586621681545457"><span class="annot"><span class="annottext">pretty :: SizeMeta -&gt; Doc
</span><a href="Agda.Syntax.Common.Pretty.html#pretty"><span class="hs-identifier hs-var hs-var hs-var hs-var">pretty</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">MetaId -&gt; Doc
forall a. Pretty a =&gt; a -&gt; Doc
</span><a href="Agda.Syntax.Common.Pretty.html#pretty"><span class="hs-identifier hs-var">P.pretty</span></a></span><span> </span><span class="annot"><span class="annottext">(MetaId -&gt; Doc) -&gt; (SizeMeta -&gt; MetaId) -&gt; SizeMeta -&gt; Doc
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">SizeMeta -&gt; MetaId
</span><a href="Agda.TypeChecking.SizedTypes.Solve.html#sizeMetaId"><span class="hs-identifier hs-var">sizeMetaId</span></a></span><span>
</span><span id="line-681"></span><span>
</span><span id="line-682"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="Agda.TypeChecking.Pretty.html#PrettyTCM"><span class="hs-identifier hs-type">PrettyTCM</span></a></span><span> </span><span class="annot"><a href="Agda.TypeChecking.SizedTypes.Solve.html#SizeMeta"><span class="hs-identifier hs-type">SizeMeta</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-683"></span><span>  </span><span id="local-6989586621681545464"><span class="annot"><span class="annottext">prettyTCM :: forall (m :: * -&gt; *). MonadPretty m =&gt; SizeMeta -&gt; m Doc
</span><a href="Agda.TypeChecking.Pretty.html#prettyTCM"><span class="hs-identifier hs-var hs-var hs-var hs-var">prettyTCM</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Agda.TypeChecking.SizedTypes.Solve.html#SizeMeta"><span class="hs-identifier hs-type">SizeMeta</span></a></span><span> </span><span id="local-6989586621681545465"><span class="annot"><span class="annottext">MetaId
</span><a href="#local-6989586621681545465"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621681545466"><span class="annot"><span class="annottext">[Int]
</span><a href="#local-6989586621681545466"><span class="hs-identifier hs-var">es</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Term -&gt; m Doc
forall a (m :: * -&gt; *). (PrettyTCM a, MonadPretty m) =&gt; a -&gt; m Doc
forall (m :: * -&gt; *). MonadPretty m =&gt; Term -&gt; m Doc
</span><a href="Agda.TypeChecking.Pretty.html#prettyTCM"><span class="hs-identifier hs-var">prettyTCM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MetaId -&gt; Elims -&gt; Term
</span><a href="Agda.Syntax.Internal.html#MetaV"><span class="hs-identifier hs-var">MetaV</span></a></span><span> </span><span class="annot"><span class="annottext">MetaId
</span><a href="#local-6989586621681545465"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">(Elims -&gt; Term) -&gt; Elims -&gt; Term
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(Int -&gt; Elim' Term) -&gt; [Int] -&gt; Elims
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Arg Term -&gt; Elim' Term
forall a. Arg a -&gt; Elim' a
</span><a href="Agda.Syntax.Internal.Elim.html#Apply"><span class="hs-identifier hs-var">Apply</span></a></span><span> </span><span class="annot"><span class="annottext">(Arg Term -&gt; Elim' Term) -&gt; (Int -&gt; Arg Term) -&gt; Int -&gt; Elim' Term
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Term -&gt; Arg Term
forall a. a -&gt; Arg a
</span><a href="Agda.Syntax.Common.html#defaultArg"><span class="hs-identifier hs-var">defaultArg</span></a></span><span> </span><span class="annot"><span class="annottext">(Term -&gt; Arg Term) -&gt; (Int -&gt; Term) -&gt; Int -&gt; Arg Term
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Term
</span><a href="Agda.Syntax.Internal.html#var"><span class="hs-identifier hs-var">var</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Int]
</span><a href="#local-6989586621681545466"><span class="hs-identifier hs-var">es</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-684"></span><span>
</span><span id="line-685"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="Agda.TypeChecking.Substitute.Class.html#Subst"><span class="hs-identifier hs-type">Subst</span></a></span><span> </span><span class="annot"><a href="Agda.TypeChecking.SizedTypes.Solve.html#SizeMeta"><span class="hs-identifier hs-type">SizeMeta</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-686"></span><span>  </span><span class="hs-keyword">type</span><span> </span><span id="SubstArg"><span class="annot"><a href="Agda.TypeChecking.Substitute.Class.html#SubstArg"><span class="hs-identifier hs-var">SubstArg</span></a></span></span><span> </span><span class="annot"><a href="Agda.TypeChecking.SizedTypes.Solve.html#SizeMeta"><span class="hs-identifier hs-type">SizeMeta</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="Agda.Syntax.Internal.html#Term"><span class="hs-identifier hs-type">Term</span></a></span><span>
</span><span id="line-687"></span><span>  </span><span id="local-6989586621681545475"><span class="annot"><span class="annottext">applySubst :: Substitution' (SubstArg SizeMeta) -&gt; SizeMeta -&gt; SizeMeta
</span><a href="Agda.TypeChecking.Substitute.Class.html#applySubst"><span class="hs-identifier hs-var hs-var hs-var hs-var">applySubst</span></a></span></span><span> </span><span id="local-6989586621681545476"><span class="annot"><span class="annottext">Substitution' (SubstArg SizeMeta)
</span><a href="#local-6989586621681545476"><span class="hs-identifier hs-var">sigma</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Agda.TypeChecking.SizedTypes.Solve.html#SizeMeta"><span class="hs-identifier hs-type">SizeMeta</span></a></span><span> </span><span id="local-6989586621681545477"><span class="annot"><span class="annottext">MetaId
</span><a href="#local-6989586621681545477"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621681545478"><span class="annot"><span class="annottext">[Int]
</span><a href="#local-6989586621681545478"><span class="hs-identifier hs-var">es</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">MetaId -&gt; [Int] -&gt; SizeMeta
</span><a href="Agda.TypeChecking.SizedTypes.Solve.html#SizeMeta"><span class="hs-identifier hs-var">SizeMeta</span></a></span><span> </span><span class="annot"><span class="annottext">MetaId
</span><a href="#local-6989586621681545477"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Int -&gt; Int) -&gt; [Int] -&gt; [Int]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int
</span><a href="#local-6989586621681545479"><span class="hs-identifier hs-var">raise</span></a></span><span> </span><span class="annot"><span class="annottext">[Int]
</span><a href="#local-6989586621681545478"><span class="hs-identifier hs-var">es</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-688"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-689"></span><span>      </span><span id="local-6989586621681545479"><span class="annot"><span class="annottext">raise :: Int -&gt; Int
</span><a href="#local-6989586621681545479"><span class="hs-identifier hs-var hs-var">raise</span></a></span></span><span> </span><span id="local-6989586621681545480"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681545480"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-690"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Substitution' Term -&gt; Int -&gt; Term
forall a. EndoSubst a =&gt; Substitution' a -&gt; Int -&gt; a
</span><a href="Agda.TypeChecking.Substitute.Class.html#lookupS"><span class="hs-identifier hs-var">lookupS</span></a></span><span> </span><span class="annot"><span class="annottext">Substitution' Term
Substitution' (SubstArg SizeMeta)
</span><a href="#local-6989586621681545476"><span class="hs-identifier hs-var">sigma</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681545480"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-691"></span><span>          </span><span class="annot"><a href="Agda.Syntax.Internal.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span id="local-6989586621681545483"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681545483"><span class="hs-identifier hs-var">j</span></a></span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681545483"><span class="hs-identifier hs-var">j</span></a></span><span>
</span><span id="line-692"></span><span>          </span><span class="annot"><span class="annottext">Term
</span><span class="hs-identifier">_</span></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Int
forall a. HasCallStack =&gt; a
</span><a href="Agda.Utils.Impossible.html#__IMPOSSIBLE__"><span class="hs-identifier hs-var">__IMPOSSIBLE__</span></a></span><span>
</span><span id="line-693"></span><span>
</span><span id="line-694"></span><span class="annot"><span class="hs-comment">-- | Size expression with de Bruijn indices.</span></span><span>
</span><span id="line-695"></span><span class="hs-keyword">type</span><span> </span><span id="DBSizeExpr"><span class="annot"><a href="Agda.TypeChecking.SizedTypes.Solve.html#DBSizeExpr"><span class="hs-identifier hs-var">DBSizeExpr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="Agda.TypeChecking.SizedTypes.Syntax.html#SizeExpr%27"><span class="hs-identifier hs-type">SizeExpr'</span></a></span><span> </span><span class="annot"><a href="Agda.TypeChecking.SizedTypes.Solve.html#NamedRigid"><span class="hs-identifier hs-type">NamedRigid</span></a></span><span> </span><span class="annot"><a href="Agda.TypeChecking.SizedTypes.Solve.html#SizeMeta"><span class="hs-identifier hs-type">SizeMeta</span></a></span><span>
</span><span id="line-696"></span><span>
</span><span id="line-697"></span><span class="hs-comment">-- deriving instance Functor     (SizeExpr' Int)</span><span>
</span><span id="line-698"></span><span class="hs-comment">-- deriving instance Foldable    (SizeExpr' Int)</span><span>
</span><span id="line-699"></span><span class="hs-comment">-- deriving instance Traversable (SizeExpr' Int)</span><span>
</span><span id="line-700"></span><span>
</span><span id="line-701"></span><span class="annot"><span class="hs-comment">-- | Only for 'raise'.</span></span><span>
</span><span id="line-702"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="Agda.TypeChecking.Substitute.Class.html#Subst"><span class="hs-identifier hs-type">Subst</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Agda.TypeChecking.SizedTypes.Syntax.html#SizeExpr%27"><span class="hs-identifier hs-type">SizeExpr'</span></a></span><span> </span><span class="annot"><a href="Agda.TypeChecking.SizedTypes.Solve.html#NamedRigid"><span class="hs-identifier hs-type">NamedRigid</span></a></span><span> </span><span class="annot"><a href="Agda.TypeChecking.SizedTypes.Solve.html#SizeMeta"><span class="hs-identifier hs-type">SizeMeta</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-703"></span><span>  </span><span class="hs-keyword">type</span><span> </span><span id="SubstArg"><span class="annot"><a href="Agda.TypeChecking.Substitute.Class.html#SubstArg"><span class="hs-identifier hs-var">SubstArg</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Agda.TypeChecking.SizedTypes.Syntax.html#SizeExpr%27"><span class="hs-identifier hs-type">SizeExpr'</span></a></span><span> </span><span class="annot"><a href="Agda.TypeChecking.SizedTypes.Solve.html#NamedRigid"><span class="hs-identifier hs-type">NamedRigid</span></a></span><span> </span><span class="annot"><a href="Agda.TypeChecking.SizedTypes.Solve.html#SizeMeta"><span class="hs-identifier hs-type">SizeMeta</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="Agda.Syntax.Internal.html#Term"><span class="hs-identifier hs-type">Term</span></a></span><span>
</span><span id="line-704"></span><span>  </span><span id="local-6989586621681545492"><span class="annot"><span class="annottext">applySubst :: Substitution' (SubstArg DBSizeExpr) -&gt; DBSizeExpr -&gt; DBSizeExpr
</span><a href="Agda.TypeChecking.Substitute.Class.html#applySubst"><span class="hs-identifier hs-var hs-var hs-var hs-var">applySubst</span></a></span></span><span> </span><span id="local-6989586621681545493"><span class="annot"><span class="annottext">Substitution' (SubstArg DBSizeExpr)
</span><a href="#local-6989586621681545493"><span class="hs-identifier hs-var">sigma</span></a></span></span><span> </span><span id="local-6989586621681545494"><span class="annot"><span class="annottext">DBSizeExpr
</span><a href="#local-6989586621681545494"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-705"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">DBSizeExpr
</span><a href="#local-6989586621681545494"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-706"></span><span>      </span><span class="annot"><span class="annottext">DBSizeExpr
</span><a href="Agda.TypeChecking.SizedTypes.Syntax.html#Infty"><span class="hs-identifier hs-var">Infty</span></a></span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">DBSizeExpr
</span><a href="#local-6989586621681545494"><span class="hs-identifier hs-var">a</span></a></span><span>
</span><span id="line-707"></span><span>      </span><span class="annot"><a href="Agda.TypeChecking.SizedTypes.Syntax.html#Const"><span class="hs-identifier hs-type">Const</span></a></span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">DBSizeExpr
</span><a href="#local-6989586621681545494"><span class="hs-identifier hs-var">a</span></a></span><span>
</span><span id="line-708"></span><span>      </span><span class="annot"><a href="Agda.TypeChecking.SizedTypes.Syntax.html#Flex"><span class="hs-identifier hs-type">Flex</span></a></span><span>  </span><span id="local-6989586621681545498"><span class="annot"><span class="annottext">SizeMeta
</span><a href="#local-6989586621681545498"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621681545499"><span class="annot"><span class="annottext">Offset
</span><a href="#local-6989586621681545499"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SizeMeta -&gt; Offset -&gt; DBSizeExpr
forall rigid flex. flex -&gt; Offset -&gt; SizeExpr' rigid flex
</span><a href="Agda.TypeChecking.SizedTypes.Syntax.html#Flex"><span class="hs-identifier hs-var">Flex</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Substitution' (SubstArg SizeMeta) -&gt; SizeMeta -&gt; SizeMeta
forall a. Subst a =&gt; Substitution' (SubstArg a) -&gt; a -&gt; a
</span><a href="Agda.TypeChecking.Substitute.Class.html#applySubst"><span class="hs-identifier hs-var">applySubst</span></a></span><span> </span><span class="annot"><span class="annottext">Substitution' (SubstArg DBSizeExpr)
Substitution' (SubstArg SizeMeta)
</span><a href="#local-6989586621681545493"><span class="hs-identifier hs-var">sigma</span></a></span><span> </span><span class="annot"><span class="annottext">SizeMeta
</span><a href="#local-6989586621681545498"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Offset
</span><a href="#local-6989586621681545499"><span class="hs-identifier hs-var">n</span></a></span><span>
</span><span id="line-709"></span><span>      </span><span class="annot"><a href="Agda.TypeChecking.SizedTypes.Syntax.html#Rigid"><span class="hs-identifier hs-type">Rigid</span></a></span><span> </span><span id="local-6989586621681545500"><span class="annot"><span class="annottext">NamedRigid
</span><a href="#local-6989586621681545500"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span id="local-6989586621681545501"><span class="annot"><span class="annottext">Offset
</span><a href="#local-6989586621681545501"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-710"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Substitution' Term -&gt; Int -&gt; Term
forall a. EndoSubst a =&gt; Substitution' a -&gt; Int -&gt; a
</span><a href="Agda.TypeChecking.Substitute.Class.html#lookupS"><span class="hs-identifier hs-var">lookupS</span></a></span><span> </span><span class="annot"><span class="annottext">Substitution' Term
Substitution' (SubstArg DBSizeExpr)
</span><a href="#local-6989586621681545493"><span class="hs-identifier hs-var">sigma</span></a></span><span> </span><span class="annot"><span class="annottext">(Int -&gt; Term) -&gt; Int -&gt; Term
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">NamedRigid -&gt; Int
</span><a href="Agda.TypeChecking.SizedTypes.Solve.html#rigidIndex"><span class="hs-identifier hs-var">rigidIndex</span></a></span><span> </span><span class="annot"><span class="annottext">NamedRigid
</span><a href="#local-6989586621681545500"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-711"></span><span>          </span><span class="annot"><a href="Agda.Syntax.Internal.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span id="local-6989586621681545502"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681545502"><span class="hs-identifier hs-var">j</span></a></span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">NamedRigid -&gt; Offset -&gt; DBSizeExpr
forall rigid flex. rigid -&gt; Offset -&gt; SizeExpr' rigid flex
</span><a href="Agda.TypeChecking.SizedTypes.Syntax.html#Rigid"><span class="hs-identifier hs-var">Rigid</span></a></span><span> </span><span class="annot"><span class="annottext">NamedRigid
</span><a href="#local-6989586621681545500"><span class="hs-identifier hs-var">r</span></a></span><span class="hs-special">{</span><span> </span><span class="annot"><a href="Agda.TypeChecking.SizedTypes.Solve.html#rigidIndex"><span class="hs-identifier hs-var">rigidIndex</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621681545502"><span class="hs-identifier hs-type">j</span></a></span><span> </span><span class="hs-special">}</span><span> </span><span class="annot"><span class="annottext">Offset
</span><a href="#local-6989586621681545501"><span class="hs-identifier hs-var">n</span></a></span><span>
</span><span id="line-712"></span><span>          </span><span class="annot"><span class="annottext">Term
</span><span class="hs-identifier">_</span></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">DBSizeExpr
forall a. HasCallStack =&gt; a
</span><a href="Agda.Utils.Impossible.html#__IMPOSSIBLE__"><span class="hs-identifier hs-var">__IMPOSSIBLE__</span></a></span><span>
</span><span id="line-713"></span><span>
</span><span id="line-714"></span><span class="hs-keyword">type</span><span> </span><span id="SizeConstraint"><span class="annot"><a href="Agda.TypeChecking.SizedTypes.Solve.html#SizeConstraint"><span class="hs-identifier hs-var">SizeConstraint</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="Agda.TypeChecking.SizedTypes.Syntax.html#Constraint%27"><span class="hs-identifier hs-type">Constraint'</span></a></span><span> </span><span class="annot"><a href="Agda.TypeChecking.SizedTypes.Solve.html#NamedRigid"><span class="hs-identifier hs-type">NamedRigid</span></a></span><span> </span><span class="annot"><a href="Agda.TypeChecking.SizedTypes.Solve.html#SizeMeta"><span class="hs-identifier hs-type">SizeMeta</span></a></span><span>
</span><span id="line-715"></span><span>
</span><span id="line-716"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="Agda.TypeChecking.Substitute.Class.html#Subst"><span class="hs-identifier hs-type">Subst</span></a></span><span> </span><span class="annot"><a href="Agda.TypeChecking.SizedTypes.Solve.html#SizeConstraint"><span class="hs-identifier hs-type">SizeConstraint</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-717"></span><span>  </span><span class="hs-keyword">type</span><span> </span><span id="SubstArg"><span class="annot"><a href="Agda.TypeChecking.Substitute.Class.html#SubstArg"><span class="hs-identifier hs-var">SubstArg</span></a></span></span><span> </span><span class="annot"><a href="Agda.TypeChecking.SizedTypes.Solve.html#SizeConstraint"><span class="hs-identifier hs-type">SizeConstraint</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="Agda.Syntax.Internal.html#Term"><span class="hs-identifier hs-type">Term</span></a></span><span>
</span><span id="line-718"></span><span>  </span><span id="local-6989586621681545508"><span class="annot"><span class="annottext">applySubst :: Substitution' (SubstArg SizeConstraint)
-&gt; SizeConstraint -&gt; SizeConstraint
</span><a href="Agda.TypeChecking.Substitute.Class.html#applySubst"><span class="hs-identifier hs-var hs-var hs-var hs-var">applySubst</span></a></span></span><span> </span><span id="local-6989586621681545509"><span class="annot"><span class="annottext">Substitution' (SubstArg SizeConstraint)
</span><a href="#local-6989586621681545509"><span class="hs-identifier hs-var">sigma</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Agda.TypeChecking.SizedTypes.Syntax.html#Constraint"><span class="hs-identifier hs-type">Constraint</span></a></span><span> </span><span id="local-6989586621681545510"><span class="annot"><span class="annottext">DBSizeExpr
</span><a href="#local-6989586621681545510"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span id="local-6989586621681545511"><span class="annot"><span class="annottext">Cmp
</span><a href="#local-6989586621681545511"><span class="hs-identifier hs-var">cmp</span></a></span></span><span> </span><span id="local-6989586621681545512"><span class="annot"><span class="annottext">DBSizeExpr
</span><a href="#local-6989586621681545512"><span class="hs-identifier hs-var">b</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-719"></span><span>    </span><span class="annot"><span class="annottext">DBSizeExpr -&gt; Cmp -&gt; DBSizeExpr -&gt; SizeConstraint
forall rigid flex.
SizeExpr' rigid flex
-&gt; Cmp -&gt; SizeExpr' rigid flex -&gt; Constraint' rigid flex
</span><a href="Agda.TypeChecking.SizedTypes.Syntax.html#Constraint"><span class="hs-identifier hs-var">Constraint</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Substitution' (SubstArg DBSizeExpr) -&gt; DBSizeExpr -&gt; DBSizeExpr
forall a. Subst a =&gt; Substitution' (SubstArg a) -&gt; a -&gt; a
</span><a href="Agda.TypeChecking.Substitute.Class.html#applySubst"><span class="hs-identifier hs-var">applySubst</span></a></span><span> </span><span class="annot"><span class="annottext">Substitution' (SubstArg SizeConstraint)
Substitution' (SubstArg DBSizeExpr)
</span><a href="#local-6989586621681545509"><span class="hs-identifier hs-var">sigma</span></a></span><span> </span><span class="annot"><span class="annottext">DBSizeExpr
</span><a href="#local-6989586621681545510"><span class="hs-identifier hs-var">a</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Cmp
</span><a href="#local-6989586621681545511"><span class="hs-identifier hs-var">cmp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Substitution' (SubstArg DBSizeExpr) -&gt; DBSizeExpr -&gt; DBSizeExpr
forall a. Subst a =&gt; Substitution' (SubstArg a) -&gt; a -&gt; a
</span><a href="Agda.TypeChecking.Substitute.Class.html#applySubst"><span class="hs-identifier hs-var">applySubst</span></a></span><span> </span><span class="annot"><span class="annottext">Substitution' (SubstArg SizeConstraint)
Substitution' (SubstArg DBSizeExpr)
</span><a href="#local-6989586621681545509"><span class="hs-identifier hs-var">sigma</span></a></span><span> </span><span class="annot"><span class="annottext">DBSizeExpr
</span><a href="#local-6989586621681545512"><span class="hs-identifier hs-var">b</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-720"></span><span>
</span><span id="line-721"></span><span class="annot"><span class="hs-comment">-- | Assumes we are in the right context.</span></span><span>
</span><span id="line-722"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="Agda.TypeChecking.Pretty.html#PrettyTCM"><span class="hs-identifier hs-type">PrettyTCM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Agda.TypeChecking.SizedTypes.Solve.html#SizeConstraint"><span class="hs-identifier hs-type">SizeConstraint</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-723"></span><span>  </span><span id="local-6989586621681545538"><span class="annot"><span class="annottext">prettyTCM :: forall (m :: * -&gt; *). MonadPretty m =&gt; SizeConstraint -&gt; m Doc
</span><a href="Agda.TypeChecking.Pretty.html#prettyTCM"><span class="hs-identifier hs-var hs-var hs-var hs-var">prettyTCM</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Agda.TypeChecking.SizedTypes.Syntax.html#Constraint"><span class="hs-identifier hs-type">Constraint</span></a></span><span> </span><span id="local-6989586621681545539"><span class="annot"><span class="annottext">DBSizeExpr
</span><a href="#local-6989586621681545539"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span id="local-6989586621681545540"><span class="annot"><span class="annottext">Cmp
</span><a href="#local-6989586621681545540"><span class="hs-identifier hs-var">cmp</span></a></span></span><span> </span><span id="local-6989586621681545541"><span class="annot"><span class="annottext">DBSizeExpr
</span><a href="#local-6989586621681545541"><span class="hs-identifier hs-var">b</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-724"></span><span>    </span><span id="local-6989586621681545542"><span class="annot"><span class="annottext">Term
</span><a href="#local-6989586621681545542"><span class="hs-identifier hs-var">u</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">DBSizeExpr -&gt; m Term
forall (m :: * -&gt; *). HasBuiltins m =&gt; DBSizeExpr -&gt; m Term
</span><a href="Agda.TypeChecking.SizedTypes.Solve.html#unSizeExpr"><span class="hs-identifier hs-var">unSizeExpr</span></a></span><span> </span><span class="annot"><span class="annottext">DBSizeExpr
</span><a href="#local-6989586621681545539"><span class="hs-identifier hs-var">a</span></a></span><span>
</span><span id="line-725"></span><span>    </span><span id="local-6989586621681545543"><span class="annot"><span class="annottext">Term
</span><a href="#local-6989586621681545543"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">DBSizeExpr -&gt; m Term
forall (m :: * -&gt; *). HasBuiltins m =&gt; DBSizeExpr -&gt; m Term
</span><a href="Agda.TypeChecking.SizedTypes.Solve.html#unSizeExpr"><span class="hs-identifier hs-var">unSizeExpr</span></a></span><span> </span><span class="annot"><span class="annottext">DBSizeExpr
</span><a href="#local-6989586621681545541"><span class="hs-identifier hs-var">b</span></a></span><span>
</span><span id="line-726"></span><span>    </span><span class="annot"><span class="annottext">Term -&gt; m Doc
forall a (m :: * -&gt; *). (PrettyTCM a, MonadPretty m) =&gt; a -&gt; m Doc
forall (m :: * -&gt; *). MonadPretty m =&gt; Term -&gt; m Doc
</span><a href="Agda.TypeChecking.Pretty.html#prettyTCM"><span class="hs-identifier hs-var">prettyTCM</span></a></span><span> </span><span class="annot"><span class="annottext">Term
</span><a href="#local-6989586621681545542"><span class="hs-identifier hs-var">u</span></a></span><span> </span><span class="annot"><span class="annottext">m Doc -&gt; m Doc -&gt; m Doc
forall (m :: * -&gt; *). Applicative m =&gt; m Doc -&gt; m Doc -&gt; m Doc
</span><a href="Agda.TypeChecking.Pretty.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Cmp -&gt; m Doc
forall (m :: * -&gt; *) a. (Applicative m, Pretty a) =&gt; a -&gt; m Doc
</span><a href="Agda.TypeChecking.Pretty.html#pretty"><span class="hs-identifier hs-var">pretty</span></a></span><span> </span><span class="annot"><span class="annottext">Cmp
</span><a href="#local-6989586621681545540"><span class="hs-identifier hs-var">cmp</span></a></span><span> </span><span class="annot"><span class="annottext">m Doc -&gt; m Doc -&gt; m Doc
forall (m :: * -&gt; *). Applicative m =&gt; m Doc -&gt; m Doc -&gt; m Doc
</span><a href="Agda.TypeChecking.Pretty.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Term -&gt; m Doc
forall a (m :: * -&gt; *). (PrettyTCM a, MonadPretty m) =&gt; a -&gt; m Doc
forall (m :: * -&gt; *). MonadPretty m =&gt; Term -&gt; m Doc
</span><a href="Agda.TypeChecking.Pretty.html#prettyTCM"><span class="hs-identifier hs-var">prettyTCM</span></a></span><span> </span><span class="annot"><span class="annottext">Term
</span><a href="#local-6989586621681545543"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-727"></span><span>
</span><span id="line-728"></span><span class="annot"><span class="hs-comment">-- | Size constraint with de Bruijn indices.</span></span><span>
</span><span id="line-729"></span><span class="hs-keyword">data</span><span> </span><span id="HypSizeConstraint"><span class="annot"><a href="Agda.TypeChecking.SizedTypes.Solve.html#HypSizeConstraint"><span class="hs-identifier hs-var">HypSizeConstraint</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="HypSizeConstraint"><span class="annot"><a href="Agda.TypeChecking.SizedTypes.Solve.html#HypSizeConstraint"><span class="hs-identifier hs-var">HypSizeConstraint</span></a></span></span><span>
</span><span id="line-730"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="sizeContext"><span class="annot"><span class="annottext">HypSizeConstraint -&gt; Context
</span><a href="Agda.TypeChecking.SizedTypes.Solve.html#sizeContext"><span class="hs-identifier hs-var hs-var">sizeContext</span></a></span></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Agda.TypeChecking.Monad.Base.html#Context"><span class="hs-identifier hs-type">Context</span></a></span><span>
</span><span id="line-731"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="sizeHypIds"><span class="annot"><span class="annottext">HypSizeConstraint -&gt; [Int]
</span><a href="Agda.TypeChecking.SizedTypes.Solve.html#sizeHypIds"><span class="hs-identifier hs-var hs-var">sizeHypIds</span></a></span></span><span>     </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Agda.Syntax.Common.html#Nat"><span class="hs-identifier hs-type">Nat</span></a></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="hs-comment">-- ^ DeBruijn indices</span></span><span>
</span><span id="line-732"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="sizeHypotheses"><span class="annot"><span class="annottext">HypSizeConstraint -&gt; [SizeConstraint]
</span><a href="Agda.TypeChecking.SizedTypes.Solve.html#sizeHypotheses"><span class="hs-identifier hs-var hs-var">sizeHypotheses</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Agda.TypeChecking.SizedTypes.Solve.html#SizeConstraint"><span class="hs-identifier hs-type">SizeConstraint</span></a></span><span class="hs-special">]</span><span>  </span><span class="annot"><span class="hs-comment">-- ^ Living in @Context@.</span></span><span>
</span><span id="line-733"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="sizeConstraint"><span class="annot"><span class="annottext">HypSizeConstraint -&gt; SizeConstraint
</span><a href="Agda.TypeChecking.SizedTypes.Solve.html#sizeConstraint"><span class="hs-identifier hs-var hs-var">sizeConstraint</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Agda.TypeChecking.SizedTypes.Solve.html#SizeConstraint"><span class="hs-identifier hs-type">SizeConstraint</span></a></span><span>    </span><span class="annot"><span class="hs-comment">-- ^ Living in @Context@.</span></span><span>
</span><span id="line-734"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-735"></span><span>
</span><span id="line-736"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="Agda.TypeChecking.SizedTypes.Syntax.html#Flexs"><span class="hs-identifier hs-type">Flexs</span></a></span><span> </span><span class="annot"><a href="Agda.TypeChecking.SizedTypes.Solve.html#HypSizeConstraint"><span class="hs-identifier hs-type">HypSizeConstraint</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-737"></span><span>  </span><span class="hs-keyword">type</span><span> </span><span id="FlexOf"><span class="annot"><a href="Agda.TypeChecking.SizedTypes.Syntax.html#FlexOf"><span class="hs-identifier hs-var">FlexOf</span></a></span></span><span> </span><span class="annot"><a href="Agda.TypeChecking.SizedTypes.Solve.html#HypSizeConstraint"><span class="hs-identifier hs-type">HypSizeConstraint</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="Agda.TypeChecking.SizedTypes.Solve.html#SizeMeta"><span class="hs-identifier hs-type">SizeMeta</span></a></span><span>
</span><span id="line-738"></span><span>  </span><span id="local-6989586621681545559"><span class="annot"><span class="annottext">flexs :: HypSizeConstraint -&gt; Set (FlexOf HypSizeConstraint)
</span><a href="Agda.TypeChecking.SizedTypes.Syntax.html#flexs"><span class="hs-identifier hs-var hs-var hs-var hs-var">flexs</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Agda.TypeChecking.SizedTypes.Solve.html#HypSizeConstraint"><span class="hs-identifier hs-type">HypSizeConstraint</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">[Int]
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621681545560"><span class="annot"><span class="annottext">[SizeConstraint]
</span><a href="#local-6989586621681545560"><span class="hs-identifier hs-var">hs</span></a></span></span><span> </span><span id="local-6989586621681545561"><span class="annot"><span class="annottext">SizeConstraint
</span><a href="#local-6989586621681545561"><span class="hs-identifier hs-var">c</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[SizeConstraint] -&gt; Set (FlexOf [SizeConstraint])
forall a. Flexs a =&gt; a -&gt; Set (FlexOf a)
</span><a href="Agda.TypeChecking.SizedTypes.Syntax.html#flexs"><span class="hs-identifier hs-var">flexs</span></a></span><span> </span><span class="annot"><span class="annottext">[SizeConstraint]
</span><a href="#local-6989586621681545560"><span class="hs-identifier hs-var">hs</span></a></span><span> </span><span class="annot"><span class="annottext">Set SizeMeta -&gt; Set SizeMeta -&gt; Set SizeMeta
forall a. Monoid a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">`mappend`</span></span><span> </span><span class="annot"><span class="annottext">SizeConstraint -&gt; Set (FlexOf SizeConstraint)
forall a. Flexs a =&gt; a -&gt; Set (FlexOf a)
</span><a href="Agda.TypeChecking.SizedTypes.Syntax.html#flexs"><span class="hs-identifier hs-var">flexs</span></a></span><span> </span><span class="annot"><span class="annottext">SizeConstraint
</span><a href="#local-6989586621681545561"><span class="hs-identifier hs-var">c</span></a></span><span>
</span><span id="line-739"></span><span>
</span><span id="line-740"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="Agda.TypeChecking.Pretty.html#PrettyTCM"><span class="hs-identifier hs-type">PrettyTCM</span></a></span><span> </span><span class="annot"><a href="Agda.TypeChecking.SizedTypes.Solve.html#HypSizeConstraint"><span class="hs-identifier hs-type">HypSizeConstraint</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-741"></span><span>  </span><span id="local-6989586621681545594"><span class="annot"><span class="annottext">prettyTCM :: forall (m :: * -&gt; *). MonadPretty m =&gt; HypSizeConstraint -&gt; m Doc
</span><a href="Agda.TypeChecking.Pretty.html#prettyTCM"><span class="hs-identifier hs-var hs-var hs-var hs-var">prettyTCM</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Agda.TypeChecking.SizedTypes.Solve.html#HypSizeConstraint"><span class="hs-identifier hs-type">HypSizeConstraint</span></a></span><span> </span><span id="local-6989586621681545595"><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621681545595"><span class="hs-identifier hs-var">cxt</span></a></span></span><span> </span><span class="annot"><span class="annottext">[Int]
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621681545596"><span class="annot"><span class="annottext">[SizeConstraint]
</span><a href="#local-6989586621681545596"><span class="hs-identifier hs-var">hs</span></a></span></span><span> </span><span id="local-6989586621681545597"><span class="annot"><span class="annottext">SizeConstraint
</span><a href="#local-6989586621681545597"><span class="hs-identifier hs-var">c</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-742"></span><span>    </span><span class="annot"><span class="annottext">(Context -&gt; Context) -&gt; m Doc -&gt; m Doc
forall (tcm :: * -&gt; *) a.
MonadTCEnv tcm =&gt;
(Context -&gt; Context) -&gt; tcm a -&gt; tcm a
</span><a href="Agda.TypeChecking.Monad.Context.html#unsafeModifyContext"><span class="hs-identifier hs-var">unsafeModifyContext</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Context -&gt; Context -&gt; Context
forall a b. a -&gt; b -&gt; a
</span><span class="hs-identifier hs-var">const</span></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621681545595"><span class="hs-identifier hs-var">cxt</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(m Doc -&gt; m Doc) -&gt; m Doc -&gt; m Doc
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-743"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681545598"><span class="annot"><span class="annottext">cxtNames :: [Name]
</span><a href="#local-6989586621681545598"><span class="hs-identifier hs-var hs-var">cxtNames</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Name] -&gt; [Name]
forall a. [a] -&gt; [a]
</span><span class="hs-identifier hs-var">reverse</span></span><span> </span><span class="annot"><span class="annottext">([Name] -&gt; [Name]) -&gt; [Name] -&gt; [Name]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(Dom' Term (Name, Type) -&gt; Name) -&gt; Context -&gt; [Name]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Name, Type) -&gt; Name
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="annot"><span class="annottext">((Name, Type) -&gt; Name)
-&gt; (Dom' Term (Name, Type) -&gt; (Name, Type))
-&gt; Dom' Term (Name, Type)
-&gt; Name
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Dom' Term (Name, Type) -&gt; (Name, Type)
forall t e. Dom' t e -&gt; e
</span><a href="Agda.Syntax.Internal.html#unDom"><span class="hs-identifier hs-var">unDom</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621681545595"><span class="hs-identifier hs-var">cxt</span></a></span><span>
</span><span id="line-744"></span><span>      </span><span class="hs-comment">-- text (&quot;[#cxt=&quot; ++ show (size cxt) ++ &quot;]&quot;) &lt;+&gt; do</span><span>
</span><span id="line-745"></span><span>      </span><span class="annot"><span class="annottext">[m Doc] -&gt; m Doc
forall (m :: * -&gt; *) (t :: * -&gt; *).
(Applicative m, Semigroup (m Doc), Foldable t) =&gt;
t (m Doc) -&gt; m Doc
</span><a href="Agda.TypeChecking.Pretty.html#prettyList"><span class="hs-identifier hs-var">prettyList</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Name -&gt; m Doc) -&gt; [Name] -&gt; [m Doc]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Name -&gt; m Doc
forall a (m :: * -&gt; *). (PrettyTCM a, MonadPretty m) =&gt; a -&gt; m Doc
forall (m :: * -&gt; *). MonadPretty m =&gt; Name -&gt; m Doc
</span><a href="Agda.TypeChecking.Pretty.html#prettyTCM"><span class="hs-identifier hs-var">prettyTCM</span></a></span><span> </span><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621681545598"><span class="hs-identifier hs-var">cxtNames</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">m Doc -&gt; m Doc -&gt; m Doc
forall (m :: * -&gt; *). Applicative m =&gt; m Doc -&gt; m Doc -&gt; m Doc
</span><a href="Agda.TypeChecking.Pretty.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-746"></span><span>      </span><span class="annot"><span class="annottext">Bool -&gt; (m Doc -&gt; m Doc) -&gt; m Doc -&gt; m Doc
forall b a. IsBool b =&gt; b -&gt; (a -&gt; a) -&gt; a -&gt; a
</span><a href="Agda.Utils.Function.html#applyUnless"><span class="hs-identifier hs-var">applyUnless</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SizeConstraint] -&gt; Bool
forall a. Null a =&gt; a -&gt; Bool
</span><a href="Agda.Utils.Null.html#null"><span class="hs-identifier hs-var">null</span></a></span><span> </span><span class="annot"><span class="annottext">[SizeConstraint]
</span><a href="#local-6989586621681545596"><span class="hs-identifier hs-var">hs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-747"></span><span>       </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">[m Doc] -&gt; m Doc
forall (m :: * -&gt; *) (t :: * -&gt; *).
(Applicative m, Foldable t) =&gt;
t (m Doc) -&gt; m Doc
</span><a href="Agda.TypeChecking.Pretty.html#hcat"><span class="hs-identifier hs-var">hcat</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">m Doc -&gt; [m Doc] -&gt; [m Doc]
forall (m :: * -&gt; *) (t :: * -&gt; *).
(Applicative m, Semigroup (m Doc), Foldable t) =&gt;
m Doc -&gt; t (m Doc) -&gt; [m Doc]
</span><a href="Agda.TypeChecking.Pretty.html#punctuate"><span class="hs-identifier hs-var">punctuate</span></a></span><span> </span><span class="annot"><span class="annottext">m Doc
</span><span class="hs-string">&quot;, &quot;</span></span><span> </span><span class="annot"><span class="annottext">([m Doc] -&gt; [m Doc]) -&gt; [m Doc] -&gt; [m Doc]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(SizeConstraint -&gt; m Doc) -&gt; [SizeConstraint] -&gt; [m Doc]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">SizeConstraint -&gt; m Doc
forall a (m :: * -&gt; *). (PrettyTCM a, MonadPretty m) =&gt; a -&gt; m Doc
forall (m :: * -&gt; *). MonadPretty m =&gt; SizeConstraint -&gt; m Doc
</span><a href="Agda.TypeChecking.Pretty.html#prettyTCM"><span class="hs-identifier hs-var">prettyTCM</span></a></span><span> </span><span class="annot"><span class="annottext">[SizeConstraint]
</span><a href="#local-6989586621681545596"><span class="hs-identifier hs-var">hs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">m Doc -&gt; m Doc -&gt; m Doc
forall (m :: * -&gt; *). Applicative m =&gt; m Doc -&gt; m Doc -&gt; m Doc
</span><a href="Agda.TypeChecking.Pretty.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">m Doc
</span><span class="hs-string">&quot;|-&quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">m Doc -&gt; m Doc -&gt; m Doc
forall (m :: * -&gt; *). Applicative m =&gt; m Doc -&gt; m Doc -&gt; m Doc
</span><a href="Agda.TypeChecking.Pretty.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-748"></span><span>       </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SizeConstraint -&gt; m Doc
forall a (m :: * -&gt; *). (PrettyTCM a, MonadPretty m) =&gt; a -&gt; m Doc
forall (m :: * -&gt; *). MonadPretty m =&gt; SizeConstraint -&gt; m Doc
</span><a href="Agda.TypeChecking.Pretty.html#prettyTCM"><span class="hs-identifier hs-var">prettyTCM</span></a></span><span> </span><span class="annot"><span class="annottext">SizeConstraint
</span><a href="#local-6989586621681545597"><span class="hs-identifier hs-var">c</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-749"></span><span>
</span><span id="line-750"></span><span class="annot"><span class="hs-comment">-- | Turn a constraint over de Bruijn indices into a size constraint.</span></span><span>
</span><span id="line-751"></span><span class="annot"><a href="Agda.TypeChecking.SizedTypes.Solve.html#computeSizeConstraint"><span class="hs-identifier hs-type">computeSizeConstraint</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Agda.TypeChecking.Monad.Base.html#ProblemConstraint"><span class="hs-identifier hs-type">ProblemConstraint</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Agda.TypeChecking.Monad.Base.html#TCM"><span class="hs-identifier hs-type">TCM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="Agda.TypeChecking.SizedTypes.Solve.html#HypSizeConstraint"><span class="hs-identifier hs-type">HypSizeConstraint</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-752"></span><span id="computeSizeConstraint"><span class="annot"><span class="annottext">computeSizeConstraint :: ProblemConstraint -&gt; TCMT IO (Maybe HypSizeConstraint)
</span><a href="Agda.TypeChecking.SizedTypes.Solve.html#computeSizeConstraint"><span class="hs-identifier hs-var hs-var">computeSizeConstraint</span></a></span></span><span> </span><span id="local-6989586621681545604"><span class="annot"><span class="annottext">ProblemConstraint
</span><a href="#local-6989586621681545604"><span class="hs-identifier hs-var">c</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-753"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681545605"><span class="annot"><span class="annottext">cxt :: Context
</span><a href="#local-6989586621681545605"><span class="hs-identifier hs-var hs-var">cxt</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TCEnv -&gt; Context
</span><a href="Agda.TypeChecking.Monad.Base.html#envContext"><span class="hs-identifier hs-var">envContext</span></a></span><span> </span><span class="annot"><span class="annottext">(TCEnv -&gt; Context) -&gt; TCEnv -&gt; Context
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Closure Constraint -&gt; TCEnv
forall a. Closure a -&gt; TCEnv
</span><a href="Agda.TypeChecking.Monad.Base.html#clEnv"><span class="hs-identifier hs-var">clEnv</span></a></span><span> </span><span class="annot"><span class="annottext">(Closure Constraint -&gt; TCEnv) -&gt; Closure Constraint -&gt; TCEnv
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ProblemConstraint -&gt; Closure Constraint
</span><a href="Agda.TypeChecking.Monad.Base.html#theConstraint"><span class="hs-identifier hs-var">theConstraint</span></a></span><span> </span><span class="annot"><span class="annottext">ProblemConstraint
</span><a href="#local-6989586621681545604"><span class="hs-identifier hs-var">c</span></a></span><span>
</span><span id="line-754"></span><span>  </span><span class="annot"><span class="annottext">(Context -&gt; Context)
-&gt; TCMT IO (Maybe HypSizeConstraint)
-&gt; TCMT IO (Maybe HypSizeConstraint)
forall (tcm :: * -&gt; *) a.
MonadTCEnv tcm =&gt;
(Context -&gt; Context) -&gt; tcm a -&gt; tcm a
</span><a href="Agda.TypeChecking.Monad.Context.html#unsafeModifyContext"><span class="hs-identifier hs-var">unsafeModifyContext</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Context -&gt; Context -&gt; Context
forall a b. a -&gt; b -&gt; a
</span><span class="hs-identifier hs-var">const</span></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621681545605"><span class="hs-identifier hs-var">cxt</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(TCMT IO (Maybe HypSizeConstraint)
 -&gt; TCMT IO (Maybe HypSizeConstraint))
-&gt; TCMT IO (Maybe HypSizeConstraint)
-&gt; TCMT IO (Maybe HypSizeConstraint)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-755"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Closure Constraint -&gt; Constraint
forall a. Closure a -&gt; a
</span><a href="Agda.TypeChecking.Monad.Base.html#clValue"><span class="hs-identifier hs-var">clValue</span></a></span><span> </span><span class="annot"><span class="annottext">(Closure Constraint -&gt; Constraint)
-&gt; Closure Constraint -&gt; Constraint
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ProblemConstraint -&gt; Closure Constraint
</span><a href="Agda.TypeChecking.Monad.Base.html#theConstraint"><span class="hs-identifier hs-var">theConstraint</span></a></span><span> </span><span class="annot"><span class="annottext">ProblemConstraint
</span><a href="#local-6989586621681545604"><span class="hs-identifier hs-var">c</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-756"></span><span>      </span><span class="annot"><a href="Agda.TypeChecking.Monad.Base.html#ValueCmp"><span class="hs-identifier hs-type">ValueCmp</span></a></span><span> </span><span class="annot"><span class="annottext">Comparison
</span><a href="Agda.TypeChecking.Monad.Base.html#CmpLeq"><span class="hs-identifier hs-var">CmpLeq</span></a></span><span> </span><span class="annot"><span class="annottext">CompareAs
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621681545607"><span class="annot"><span class="annottext">Term
</span><a href="#local-6989586621681545607"><span class="hs-identifier hs-var">u</span></a></span></span><span> </span><span id="local-6989586621681545608"><span class="annot"><span class="annottext">Term
</span><a href="#local-6989586621681545608"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-757"></span><span>        </span><span class="annot"><span class="annottext">String -&gt; Int -&gt; TCMT IO Doc -&gt; TCM ()
forall (m :: * -&gt; *).
MonadDebug m =&gt;
String -&gt; Int -&gt; TCMT IO Doc -&gt; m ()
</span><a href="Agda.TypeChecking.Monad.Debug.html#reportSDoc"><span class="hs-identifier hs-var">reportSDoc</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;tc.size.solve&quot;</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">50</span></span><span> </span><span class="annot"><span class="annottext">(TCMT IO Doc -&gt; TCM ()) -&gt; TCMT IO Doc -&gt; TCM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[TCMT IO Doc] -&gt; TCMT IO Doc
forall (m :: * -&gt; *) (t :: * -&gt; *).
(Applicative m, Foldable t) =&gt;
t (m Doc) -&gt; m Doc
</span><a href="Agda.TypeChecking.Pretty.html#sep"><span class="hs-identifier hs-var">sep</span></a></span><span> </span><span class="annot"><span class="annottext">([TCMT IO Doc] -&gt; TCMT IO Doc) -&gt; [TCMT IO Doc] -&gt; TCMT IO Doc
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-758"></span><span>          </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">TCMT IO Doc
</span><span class="hs-string">&quot;converting size constraint&quot;</span></span><span>
</span><span id="line-759"></span><span>          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ProblemConstraint -&gt; TCMT IO Doc
forall a (m :: * -&gt; *). (PrettyTCM a, MonadPretty m) =&gt; a -&gt; m Doc
forall (m :: * -&gt; *). MonadPretty m =&gt; ProblemConstraint -&gt; m Doc
</span><a href="Agda.TypeChecking.Pretty.html#prettyTCM"><span class="hs-identifier hs-var">prettyTCM</span></a></span><span> </span><span class="annot"><span class="annottext">ProblemConstraint
</span><a href="#local-6989586621681545604"><span class="hs-identifier hs-var">c</span></a></span><span>
</span><span id="line-760"></span><span>          </span><span class="hs-special">]</span><span>
</span><span id="line-761"></span><span>        </span><span id="local-6989586621681545610"><span class="annot"><span class="annottext">Maybe DBSizeExpr
</span><a href="#local-6989586621681545610"><span class="hs-identifier hs-var">ma</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Term -&gt; TCMT IO (Maybe DBSizeExpr)
</span><a href="Agda.TypeChecking.SizedTypes.Solve.html#sizeExpr"><span class="hs-identifier hs-var">sizeExpr</span></a></span><span> </span><span class="annot"><span class="annottext">Term
</span><a href="#local-6989586621681545607"><span class="hs-identifier hs-var">u</span></a></span><span>
</span><span id="line-762"></span><span>        </span><span id="local-6989586621681545611"><span class="annot"><span class="annottext">Maybe DBSizeExpr
</span><a href="#local-6989586621681545611"><span class="hs-identifier hs-var">mb</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Term -&gt; TCMT IO (Maybe DBSizeExpr)
</span><a href="Agda.TypeChecking.SizedTypes.Solve.html#sizeExpr"><span class="hs-identifier hs-var">sizeExpr</span></a></span><span> </span><span class="annot"><span class="annottext">Term
</span><a href="#local-6989586621681545608"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-763"></span><span>        </span><span class="hs-special">(</span><span id="local-6989586621681545612"><span class="annot"><span class="annottext">[Int]
</span><a href="#local-6989586621681545612"><span class="hs-identifier hs-var">hids</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681545613"><span class="annot"><span class="annottext">[SizeConstraint]
</span><a href="#local-6989586621681545613"><span class="hs-identifier hs-var">hs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[(Int, SizeConstraint)] -&gt; ([Int], [SizeConstraint])
forall a b. [(a, b)] -&gt; ([a], [b])
</span><span class="hs-identifier hs-var">unzip</span></span><span> </span><span class="annot"><span class="annottext">([(Int, SizeConstraint)] -&gt; ([Int], [SizeConstraint]))
-&gt; TCM [(Int, SizeConstraint)] -&gt; TCMT IO ([Int], [SizeConstraint])
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Context -&gt; TCM [(Int, SizeConstraint)]
</span><a href="Agda.TypeChecking.SizedTypes.Solve.html#getSizeHypotheses"><span class="hs-identifier hs-var">getSizeHypotheses</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621681545605"><span class="hs-identifier hs-var">cxt</span></a></span><span>
</span><span id="line-764"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681545615"><span class="annot"><span class="annottext">mk :: DBSizeExpr -&gt; DBSizeExpr -&gt; HypSizeConstraint
</span><a href="#local-6989586621681545615"><span class="hs-identifier hs-var hs-var">mk</span></a></span></span><span> </span><span id="local-6989586621681545616"><span class="annot"><span class="annottext">DBSizeExpr
</span><a href="#local-6989586621681545616"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span id="local-6989586621681545617"><span class="annot"><span class="annottext">DBSizeExpr
</span><a href="#local-6989586621681545617"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Context
-&gt; [Int] -&gt; [SizeConstraint] -&gt; SizeConstraint -&gt; HypSizeConstraint
</span><a href="Agda.TypeChecking.SizedTypes.Solve.html#HypSizeConstraint"><span class="hs-identifier hs-var">HypSizeConstraint</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621681545605"><span class="hs-identifier hs-var">cxt</span></a></span><span> </span><span class="annot"><span class="annottext">[Int]
</span><a href="#local-6989586621681545612"><span class="hs-identifier hs-var">hids</span></a></span><span> </span><span class="annot"><span class="annottext">[SizeConstraint]
</span><a href="#local-6989586621681545613"><span class="hs-identifier hs-var">hs</span></a></span><span> </span><span class="annot"><span class="annottext">(SizeConstraint -&gt; HypSizeConstraint)
-&gt; SizeConstraint -&gt; HypSizeConstraint
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">DBSizeExpr -&gt; Cmp -&gt; DBSizeExpr -&gt; SizeConstraint
forall rigid flex.
SizeExpr' rigid flex
-&gt; Cmp -&gt; SizeExpr' rigid flex -&gt; Constraint' rigid flex
</span><a href="Agda.TypeChecking.SizedTypes.Syntax.html#Constraint"><span class="hs-identifier hs-var">Size.Constraint</span></a></span><span> </span><span class="annot"><span class="annottext">DBSizeExpr
</span><a href="#local-6989586621681545616"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="annot"><span class="annottext">Cmp
</span><a href="Agda.TypeChecking.SizedTypes.Syntax.html#Le"><span class="hs-identifier hs-var">Le</span></a></span><span> </span><span class="annot"><span class="annottext">DBSizeExpr
</span><a href="#local-6989586621681545617"><span class="hs-identifier hs-var">b</span></a></span><span>
</span><span id="line-765"></span><span>        </span><span class="hs-comment">-- We only create a size constraint if both terms can be</span><span>
</span><span id="line-766"></span><span>        </span><span class="hs-comment">-- parsed to our format of size expressions.</span><span>
</span><span id="line-767"></span><span>        </span><span class="annot"><span class="annottext">Maybe HypSizeConstraint -&gt; TCMT IO (Maybe HypSizeConstraint)
forall a. a -&gt; TCMT IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Maybe HypSizeConstraint -&gt; TCMT IO (Maybe HypSizeConstraint))
-&gt; Maybe HypSizeConstraint -&gt; TCMT IO (Maybe HypSizeConstraint)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">DBSizeExpr -&gt; DBSizeExpr -&gt; HypSizeConstraint
</span><a href="#local-6989586621681545615"><span class="hs-identifier hs-var">mk</span></a></span><span> </span><span class="annot"><span class="annottext">(DBSizeExpr -&gt; DBSizeExpr -&gt; HypSizeConstraint)
-&gt; Maybe DBSizeExpr -&gt; Maybe (DBSizeExpr -&gt; HypSizeConstraint)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Maybe DBSizeExpr
</span><a href="#local-6989586621681545610"><span class="hs-identifier hs-var">ma</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (DBSizeExpr -&gt; HypSizeConstraint)
-&gt; Maybe DBSizeExpr -&gt; Maybe HypSizeConstraint
forall a b. Maybe (a -&gt; b) -&gt; Maybe a -&gt; Maybe b
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">Maybe DBSizeExpr
</span><a href="#local-6989586621681545611"><span class="hs-identifier hs-var">mb</span></a></span><span>
</span><span id="line-768"></span><span>      </span><span class="annot"><span class="annottext">Constraint
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TCMT IO (Maybe HypSizeConstraint)
forall a. HasCallStack =&gt; a
</span><a href="Agda.Utils.Impossible.html#__IMPOSSIBLE__"><span class="hs-identifier hs-var">__IMPOSSIBLE__</span></a></span><span>
</span><span id="line-769"></span><span>
</span><span id="line-770"></span><span class="hs-comment">-- | Turn a term into a size expression.</span><span>
</span><span id="line-771"></span><span class="hs-comment">--</span><span>
</span><span id="line-772"></span><span class="hs-comment">--   Returns 'Nothing' if the term isn't a proper size expression.</span><span>
</span><span id="line-773"></span><span>
</span><span id="line-774"></span><span class="annot"><a href="Agda.TypeChecking.SizedTypes.Solve.html#sizeExpr"><span class="hs-identifier hs-type">sizeExpr</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Agda.Syntax.Internal.html#Term"><span class="hs-identifier hs-type">Term</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Agda.TypeChecking.Monad.Base.html#TCM"><span class="hs-identifier hs-type">TCM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="Agda.TypeChecking.SizedTypes.Solve.html#DBSizeExpr"><span class="hs-identifier hs-type">DBSizeExpr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-775"></span><span id="sizeExpr"><span class="annot"><span class="annottext">sizeExpr :: Term -&gt; TCMT IO (Maybe DBSizeExpr)
</span><a href="Agda.TypeChecking.SizedTypes.Solve.html#sizeExpr"><span class="hs-identifier hs-var hs-var">sizeExpr</span></a></span></span><span> </span><span id="local-6989586621681545619"><span class="annot"><span class="annottext">Term
</span><a href="#local-6989586621681545619"><span class="hs-identifier hs-var">u</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-776"></span><span>  </span><span id="local-6989586621681545620"><span class="annot"><span class="annottext">Term
</span><a href="#local-6989586621681545620"><span class="hs-identifier hs-var">u</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Term -&gt; TCMT IO Term
forall a (m :: * -&gt; *). (Reduce a, MonadReduce m) =&gt; a -&gt; m a
</span><a href="Agda.TypeChecking.Reduce.html#reduce"><span class="hs-identifier hs-var">reduce</span></a></span><span> </span><span class="annot"><span class="annottext">Term
</span><a href="#local-6989586621681545619"><span class="hs-identifier hs-var">u</span></a></span><span> </span><span class="hs-comment">-- Andreas, 2009-02-09.</span><span>
</span><span id="line-777"></span><span>                </span><span class="hs-comment">-- This is necessary to surface the solutions of metavariables.</span><span>
</span><span id="line-778"></span><span>  </span><span class="annot"><span class="annottext">String -&gt; Int -&gt; TCMT IO Doc -&gt; TCM ()
forall (m :: * -&gt; *).
MonadDebug m =&gt;
String -&gt; Int -&gt; TCMT IO Doc -&gt; m ()
</span><a href="Agda.TypeChecking.Monad.Debug.html#reportSDoc"><span class="hs-identifier hs-var">reportSDoc</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;tc.conv.size&quot;</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">60</span></span><span> </span><span class="annot"><span class="annottext">(TCMT IO Doc -&gt; TCM ()) -&gt; TCMT IO Doc -&gt; TCM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TCMT IO Doc
</span><span class="hs-string">&quot;sizeExpr:&quot;</span></span><span> </span><span class="annot"><span class="annottext">TCMT IO Doc -&gt; TCMT IO Doc -&gt; TCMT IO Doc
forall (m :: * -&gt; *). Applicative m =&gt; m Doc -&gt; m Doc -&gt; m Doc
</span><a href="Agda.TypeChecking.Pretty.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Term -&gt; TCMT IO Doc
forall a (m :: * -&gt; *). (PrettyTCM a, MonadPretty m) =&gt; a -&gt; m Doc
forall (m :: * -&gt; *). MonadPretty m =&gt; Term -&gt; m Doc
</span><a href="Agda.TypeChecking.Pretty.html#prettyTCM"><span class="hs-identifier hs-var">prettyTCM</span></a></span><span> </span><span class="annot"><span class="annottext">Term
</span><a href="#local-6989586621681545620"><span class="hs-identifier hs-var">u</span></a></span><span>
</span><span id="line-779"></span><span>  </span><span id="local-6989586621681545621"><span class="annot"><span class="annottext">SizeView
</span><a href="#local-6989586621681545621"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Term -&gt; TCMT IO SizeView
forall (m :: * -&gt; *).
(HasBuiltins m, MonadTCEnv m, ReadTCState m) =&gt;
Term -&gt; m SizeView
</span><a href="Agda.TypeChecking.Monad.SizedTypes.html#sizeView"><span class="hs-identifier hs-var">sizeView</span></a></span><span> </span><span class="annot"><span class="annottext">Term
</span><a href="#local-6989586621681545620"><span class="hs-identifier hs-var">u</span></a></span><span>
</span><span id="line-780"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">SizeView
</span><a href="#local-6989586621681545621"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-781"></span><span>    </span><span class="annot"><span class="annottext">SizeView
</span><a href="Agda.TypeChecking.Monad.SizedTypes.html#SizeInf"><span class="hs-identifier hs-var">SizeInf</span></a></span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe DBSizeExpr -&gt; TCMT IO (Maybe DBSizeExpr)
forall a. a -&gt; TCMT IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Maybe DBSizeExpr -&gt; TCMT IO (Maybe DBSizeExpr))
-&gt; Maybe DBSizeExpr -&gt; TCMT IO (Maybe DBSizeExpr)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">DBSizeExpr -&gt; Maybe DBSizeExpr
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">DBSizeExpr
forall rigid flex. SizeExpr' rigid flex
</span><a href="Agda.TypeChecking.SizedTypes.Syntax.html#Infty"><span class="hs-identifier hs-var">Infty</span></a></span><span>
</span><span id="line-782"></span><span>    </span><span class="annot"><a href="Agda.TypeChecking.Monad.SizedTypes.html#SizeSuc"><span class="hs-identifier hs-type">SizeSuc</span></a></span><span> </span><span id="local-6989586621681545625"><span class="annot"><span class="annottext">Term
</span><a href="#local-6989586621681545625"><span class="hs-identifier hs-var">u</span></a></span></span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(DBSizeExpr -&gt; DBSizeExpr) -&gt; Maybe DBSizeExpr -&gt; Maybe DBSizeExpr
forall a b. (a -&gt; b) -&gt; Maybe a -&gt; Maybe b
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DBSizeExpr -&gt; Offset -&gt; DBSizeExpr
forall a b c. Plus a b c =&gt; a -&gt; b -&gt; c
</span><a href="Agda.TypeChecking.SizedTypes.Utils.html#plus"><span class="hs-operator hs-var">`plus`</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Offset
</span><span class="hs-number">1</span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Agda.TypeChecking.SizedTypes.Syntax.html#Offset"><span class="hs-identifier hs-type">Offset</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Maybe DBSizeExpr -&gt; Maybe DBSizeExpr)
-&gt; TCMT IO (Maybe DBSizeExpr) -&gt; TCMT IO (Maybe DBSizeExpr)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Term -&gt; TCMT IO (Maybe DBSizeExpr)
</span><a href="Agda.TypeChecking.SizedTypes.Solve.html#sizeExpr"><span class="hs-identifier hs-var">sizeExpr</span></a></span><span> </span><span class="annot"><span class="annottext">Term
</span><a href="#local-6989586621681545625"><span class="hs-identifier hs-var">u</span></a></span><span>
</span><span id="line-783"></span><span>    </span><span class="annot"><a href="Agda.TypeChecking.Monad.SizedTypes.html#OtherSize"><span class="hs-identifier hs-type">OtherSize</span></a></span><span> </span><span id="local-6989586621681545627"><span class="annot"><span class="annottext">Term
</span><a href="#local-6989586621681545627"><span class="hs-identifier hs-var">u</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Term
</span><a href="#local-6989586621681545627"><span class="hs-identifier hs-var">u</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-784"></span><span>      </span><span class="annot"><a href="Agda.Syntax.Internal.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span id="local-6989586621681545628"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681545628"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span> </span><span id="local-6989586621681545629"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621681545629"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">DBSizeExpr -&gt; Maybe DBSizeExpr
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(DBSizeExpr -&gt; Maybe DBSizeExpr) -&gt; DBSizeExpr -&gt; Maybe DBSizeExpr
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">NamedRigid -&gt; Offset -&gt; DBSizeExpr
forall rigid flex. rigid -&gt; Offset -&gt; SizeExpr' rigid flex
</span><a href="Agda.TypeChecking.SizedTypes.Syntax.html#Rigid"><span class="hs-identifier hs-var">Rigid</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; Int -&gt; NamedRigid
</span><a href="Agda.TypeChecking.SizedTypes.Solve.html#NamedRigid"><span class="hs-identifier hs-var">NamedRigid</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621681545629"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681545628"><span class="hs-identifier hs-var">i</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Offset
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(String -&gt; Maybe DBSizeExpr)
-&gt; (Name -&gt; String) -&gt; Name -&gt; Maybe DBSizeExpr
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Name -&gt; String
forall a. Pretty a =&gt; a -&gt; String
</span><a href="Agda.Syntax.Common.Pretty.html#prettyShow"><span class="hs-identifier hs-var">prettyShow</span></a></span><span> </span><span class="annot"><span class="annottext">(Name -&gt; Maybe DBSizeExpr)
-&gt; TCMT IO Name -&gt; TCMT IO (Maybe DBSizeExpr)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; TCMT IO Name
forall (m :: * -&gt; *).
(Applicative m, MonadFail m, MonadTCEnv m) =&gt;
Int -&gt; m Name
</span><a href="Agda.TypeChecking.Monad.Context.html#nameOfBV"><span class="hs-identifier hs-var">nameOfBV</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681545628"><span class="hs-identifier hs-var">i</span></a></span><span>
</span><span id="line-785"></span><span class="hs-comment">--      MetaV m es  -&gt; return $ Just $ Flex (SizeMeta m es) 0</span><span>
</span><span id="line-786"></span><span>      </span><span class="annot"><a href="Agda.Syntax.Internal.html#MetaV"><span class="hs-identifier hs-type">MetaV</span></a></span><span> </span><span id="local-6989586621681545631"><span class="annot"><span class="annottext">MetaId
</span><a href="#local-6989586621681545631"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span id="local-6989586621681545632"><span class="annot"><span class="annottext">Elims
</span><a href="#local-6989586621681545632"><span class="hs-identifier hs-var">es</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621681545633"><span class="annot"><span class="annottext">[Int]
</span><a href="#local-6989586621681545633"><span class="hs-identifier hs-var">xs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Elim' Term -&gt; Maybe Int) -&gt; Elims -&gt; Maybe [Int]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; [a] -&gt; m [b]
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">Elim' Term -&gt; Maybe Int
</span><a href="#local-6989586621681545634"><span class="hs-identifier hs-var">isVar</span></a></span><span> </span><span class="annot"><span class="annottext">Elims
</span><a href="#local-6989586621681545632"><span class="hs-identifier hs-var">es</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[Int] -&gt; Bool
forall a. Ord a =&gt; [a] -&gt; Bool
</span><a href="Agda.Utils.List.html#fastDistinct"><span class="hs-identifier hs-var">List.fastDistinct</span></a></span><span> </span><span class="annot"><span class="annottext">[Int]
</span><a href="#local-6989586621681545633"><span class="hs-identifier hs-var">xs</span></a></span><span>
</span><span id="line-787"></span><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe DBSizeExpr -&gt; TCMT IO (Maybe DBSizeExpr)
forall a. a -&gt; TCMT IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Maybe DBSizeExpr -&gt; TCMT IO (Maybe DBSizeExpr))
-&gt; Maybe DBSizeExpr -&gt; TCMT IO (Maybe DBSizeExpr)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">DBSizeExpr -&gt; Maybe DBSizeExpr
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(DBSizeExpr -&gt; Maybe DBSizeExpr) -&gt; DBSizeExpr -&gt; Maybe DBSizeExpr
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SizeMeta -&gt; Offset -&gt; DBSizeExpr
forall rigid flex. flex -&gt; Offset -&gt; SizeExpr' rigid flex
</span><a href="Agda.TypeChecking.SizedTypes.Syntax.html#Flex"><span class="hs-identifier hs-var">Flex</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MetaId -&gt; [Int] -&gt; SizeMeta
</span><a href="Agda.TypeChecking.SizedTypes.Solve.html#SizeMeta"><span class="hs-identifier hs-var">SizeMeta</span></a></span><span> </span><span class="annot"><span class="annottext">MetaId
</span><a href="#local-6989586621681545631"><span class="hs-identifier hs-var">m</span></a></span><span> </span><span class="annot"><span class="annottext">[Int]
</span><a href="#local-6989586621681545633"><span class="hs-identifier hs-var">xs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Offset
</span><span class="hs-number">0</span></span><span>
</span><span id="line-788"></span><span>      </span><span class="annot"><span class="annottext">Term
</span><span class="hs-identifier">_</span></span><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe DBSizeExpr -&gt; TCMT IO (Maybe DBSizeExpr)
forall a. a -&gt; TCMT IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Maybe DBSizeExpr
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-789"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-790"></span><span>    </span><span id="local-6989586621681545634"><span class="annot"><span class="annottext">isVar :: Elim' Term -&gt; Maybe Int
</span><a href="#local-6989586621681545634"><span class="hs-identifier hs-var hs-var">isVar</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Agda.Syntax.Internal.Elim.html#Proj"><span class="hs-identifier hs-type">Proj</span></a></span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe Int
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-791"></span><span>    </span><span class="annot"><a href="#local-6989586621681545634"><span class="hs-identifier hs-var">isVar</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Agda.Syntax.Internal.Elim.html#IApply"><span class="hs-identifier hs-type">IApply</span></a></span><span> </span><span class="annot"><span class="annottext">Term
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Term
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621681545638"><span class="annot"><span class="annottext">Term
</span><a href="#local-6989586621681545638"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Elim' Term -&gt; Maybe Int
</span><a href="#local-6989586621681545634"><span class="hs-identifier hs-var">isVar</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Arg Term -&gt; Elim' Term
forall a. Arg a -&gt; Elim' a
</span><a href="Agda.Syntax.Internal.Elim.html#Apply"><span class="hs-identifier hs-var">Apply</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Term -&gt; Arg Term
forall a. a -&gt; Arg a
</span><a href="Agda.Syntax.Common.html#defaultArg"><span class="hs-identifier hs-var">defaultArg</span></a></span><span> </span><span class="annot"><span class="annottext">Term
</span><a href="#local-6989586621681545638"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-792"></span><span>    </span><span class="annot"><a href="#local-6989586621681545634"><span class="hs-identifier hs-var">isVar</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Agda.Syntax.Internal.Elim.html#Apply"><span class="hs-identifier hs-type">Apply</span></a></span><span> </span><span id="local-6989586621681545639"><span class="annot"><span class="annottext">Arg Term
</span><a href="#local-6989586621681545639"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Arg Term -&gt; Term
forall e. Arg e -&gt; e
</span><a href="Agda.Syntax.Common.html#unArg"><span class="hs-identifier hs-var">unArg</span></a></span><span> </span><span class="annot"><span class="annottext">Arg Term
</span><a href="#local-6989586621681545639"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-793"></span><span>      </span><span class="annot"><a href="Agda.Syntax.Internal.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span id="local-6989586621681545640"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681545640"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Maybe Int
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681545640"><span class="hs-identifier hs-var">i</span></a></span><span>
</span><span id="line-794"></span><span>      </span><span class="annot"><span class="annottext">Term
</span><span class="hs-identifier">_</span></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe Int
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-795"></span><span>
</span><span id="line-796"></span><span class="annot"><span class="hs-comment">-- | Turn a de size expression into a term.</span></span><span>
</span><span id="line-797"></span><span id="local-6989586621681544094"><span class="annot"><a href="Agda.TypeChecking.SizedTypes.Solve.html#unSizeExpr"><span class="hs-identifier hs-type">unSizeExpr</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Agda.TypeChecking.Monad.Builtin.html#HasBuiltins"><span class="hs-identifier hs-type">HasBuiltins</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681544094"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Agda.TypeChecking.SizedTypes.Solve.html#DBSizeExpr"><span class="hs-identifier hs-type">DBSizeExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621681544094"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="Agda.Syntax.Internal.html#Term"><span class="hs-identifier hs-type">Term</span></a></span></span><span>
</span><span id="line-798"></span><span id="unSizeExpr"><span class="annot"><span class="annottext">unSizeExpr :: forall (m :: * -&gt; *). HasBuiltins m =&gt; DBSizeExpr -&gt; m Term
</span><a href="Agda.TypeChecking.SizedTypes.Solve.html#unSizeExpr"><span class="hs-identifier hs-var hs-var">unSizeExpr</span></a></span></span><span> </span><span id="local-6989586621681545670"><span class="annot"><span class="annottext">DBSizeExpr
</span><a href="#local-6989586621681545670"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-799"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">DBSizeExpr
</span><a href="#local-6989586621681545670"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-800"></span><span>    </span><span class="annot"><span class="annottext">DBSizeExpr
</span><a href="Agda.TypeChecking.SizedTypes.Syntax.html#Infty"><span class="hs-identifier hs-var">Infty</span></a></span><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Term -&gt; Maybe Term -&gt; Term
forall a. a -&gt; Maybe a -&gt; a
</span><span class="hs-identifier hs-var">fromMaybe</span></span><span> </span><span class="annot"><span class="annottext">Term
forall a. HasCallStack =&gt; a
</span><a href="Agda.Utils.Impossible.html#__IMPOSSIBLE__"><span class="hs-identifier hs-var">__IMPOSSIBLE__</span></a></span><span> </span><span class="annot"><span class="annottext">(Maybe Term -&gt; Term) -&gt; m (Maybe Term) -&gt; m Term
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">BuiltinId -&gt; m (Maybe Term)
forall (m :: * -&gt; *). HasBuiltins m =&gt; BuiltinId -&gt; m (Maybe Term)
</span><a href="Agda.TypeChecking.Monad.Builtin.html#getBuiltin%27"><span class="hs-identifier hs-var">getBuiltin'</span></a></span><span> </span><span class="annot"><span class="annottext">BuiltinId
</span><a href="Agda.Syntax.Builtin.html#builtinSizeInf"><span class="hs-identifier hs-var">builtinSizeInf</span></a></span><span>
</span><span id="line-801"></span><span>    </span><span class="annot"><a href="Agda.TypeChecking.SizedTypes.Syntax.html#Rigid"><span class="hs-identifier hs-type">Rigid</span></a></span><span> </span><span id="local-6989586621681545673"><span class="annot"><span class="annottext">NamedRigid
</span><a href="#local-6989586621681545673"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Agda.TypeChecking.SizedTypes.Syntax.html#O"><span class="hs-identifier hs-type">O</span></a></span><span> </span><span id="local-6989586621681545675"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681545675"><span class="hs-identifier hs-var">n</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-802"></span><span>      </span><span class="annot"><span class="annottext">Bool -&gt; m () -&gt; m ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">unless</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681545675"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;=</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">m ()
forall a. HasCallStack =&gt; a
</span><a href="Agda.Utils.Impossible.html#__IMPOSSIBLE__"><span class="hs-identifier hs-var">__IMPOSSIBLE__</span></a></span><span>
</span><span id="line-803"></span><span>      </span><span class="annot"><span class="annottext">Int -&gt; Term -&gt; m Term
forall (m :: * -&gt; *). HasBuiltins m =&gt; Int -&gt; Term -&gt; m Term
</span><a href="Agda.TypeChecking.Monad.SizedTypes.html#sizeSuc"><span class="hs-identifier hs-var">sizeSuc</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681545675"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">(Term -&gt; m Term) -&gt; Term -&gt; m Term
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Term
</span><a href="Agda.Syntax.Internal.html#var"><span class="hs-identifier hs-var">var</span></a></span><span> </span><span class="annot"><span class="annottext">(Int -&gt; Term) -&gt; Int -&gt; Term
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">NamedRigid -&gt; Int
</span><a href="Agda.TypeChecking.SizedTypes.Solve.html#rigidIndex"><span class="hs-identifier hs-var">rigidIndex</span></a></span><span> </span><span class="annot"><span class="annottext">NamedRigid
</span><a href="#local-6989586621681545673"><span class="hs-identifier hs-var">r</span></a></span><span>
</span><span id="line-804"></span><span>    </span><span class="annot"><a href="Agda.TypeChecking.SizedTypes.Syntax.html#Flex"><span class="hs-identifier hs-type">Flex</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Agda.TypeChecking.SizedTypes.Solve.html#SizeMeta"><span class="hs-identifier hs-type">SizeMeta</span></a></span><span> </span><span id="local-6989586621681545677"><span class="annot"><span class="annottext">MetaId
</span><a href="#local-6989586621681545677"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621681545678"><span class="annot"><span class="annottext">[Int]
</span><a href="#local-6989586621681545678"><span class="hs-identifier hs-var">es</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Agda.TypeChecking.SizedTypes.Syntax.html#O"><span class="hs-identifier hs-type">O</span></a></span><span> </span><span id="local-6989586621681545679"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681545679"><span class="hs-identifier hs-var">n</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-805"></span><span>      </span><span class="annot"><span class="annottext">Bool -&gt; m () -&gt; m ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">unless</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681545679"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;=</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">m ()
forall a. HasCallStack =&gt; a
</span><a href="Agda.Utils.Impossible.html#__IMPOSSIBLE__"><span class="hs-identifier hs-var">__IMPOSSIBLE__</span></a></span><span>
</span><span id="line-806"></span><span>      </span><span class="annot"><span class="annottext">Int -&gt; Term -&gt; m Term
forall (m :: * -&gt; *). HasBuiltins m =&gt; Int -&gt; Term -&gt; m Term
</span><a href="Agda.TypeChecking.Monad.SizedTypes.html#sizeSuc"><span class="hs-identifier hs-var">sizeSuc</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681545679"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">(Term -&gt; m Term) -&gt; Term -&gt; m Term
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">MetaId -&gt; Elims -&gt; Term
</span><a href="Agda.Syntax.Internal.html#MetaV"><span class="hs-identifier hs-var">MetaV</span></a></span><span> </span><span class="annot"><span class="annottext">MetaId
</span><a href="#local-6989586621681545677"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">(Elims -&gt; Term) -&gt; Elims -&gt; Term
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(Int -&gt; Elim' Term) -&gt; [Int] -&gt; Elims
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Arg Term -&gt; Elim' Term
forall a. Arg a -&gt; Elim' a
</span><a href="Agda.Syntax.Internal.Elim.html#Apply"><span class="hs-identifier hs-var">Apply</span></a></span><span> </span><span class="annot"><span class="annottext">(Arg Term -&gt; Elim' Term) -&gt; (Int -&gt; Arg Term) -&gt; Int -&gt; Elim' Term
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Term -&gt; Arg Term
forall a. a -&gt; Arg a
</span><a href="Agda.Syntax.Common.html#defaultArg"><span class="hs-identifier hs-var">defaultArg</span></a></span><span> </span><span class="annot"><span class="annottext">(Term -&gt; Arg Term) -&gt; (Int -&gt; Term) -&gt; Int -&gt; Arg Term
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Term
</span><a href="Agda.Syntax.Internal.html#var"><span class="hs-identifier hs-var">var</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Int]
</span><a href="#local-6989586621681545678"><span class="hs-identifier hs-var">es</span></a></span><span>
</span><span id="line-807"></span><span>    </span><span class="annot"><a href="Agda.TypeChecking.SizedTypes.Syntax.html#Const"><span class="hs-identifier hs-type">Const</span></a></span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">m Term
forall a. HasCallStack =&gt; a
</span><a href="Agda.Utils.Impossible.html#__IMPOSSIBLE__"><span class="hs-identifier hs-var">__IMPOSSIBLE__</span></a></span><span>
</span><span id="line-808"></span></pre></body></html>